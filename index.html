<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>iTunes-like Music Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Reset and base styles */
    body, html {
      margin: 0; padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
        Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      height: 100vh;
      overflow: hidden;
      background-color: #121212;
      color: #fff;
      display: flex;
      flex-direction: column;
    }
    body.light {
      background-color: #fff;
      color: #000;
    }
    .container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    nav.sidebar {
      width: 260px;
      background: #000;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      overflow-y: auto;
    }
    nav.sidebar h1 {
      margin: 0 0 1rem 0;
      color: #1db954;
      font-weight: 700;
      font-size: 1.5rem;
      user-select: none;
    }
    button.playlist-btn {
      background: none;
      border: none;
      color: #b3b3b3;
      font-size: 1rem;
      margin: 0.25rem 0;
      text-align: left;
      cursor: pointer;
      padding: 0.3rem 0.5rem;
      border-radius: 4px;
      user-select: none;
      transition: background-color 0.15s ease;
    }
    button.playlist-btn.active,
    button.playlist-btn:hover {
      background-color: #1db954;
      color: #fff;
    }
    .new-playlist-container {
      margin-top: auto;
      display: flex;
      gap: 0.5rem;
      padding-top: 1rem;
      border-top: 1px solid #282828;
    }
    .new-playlist-container input {
      flex: 1;
      padding: 0.4rem;
      border-radius: 4px;
      border: none;
      font-size: 1rem;
      outline-offset: 2px;
      background-color: #282828;
      color: #fff;
    }
    body.light .new-playlist-container input {
      background-color: #ddd;
      color: #000;
    }
    .new-playlist-container button {
      background-color: #1db954;
      border: none;
      color: white;
      font-weight: 700;
      cursor: pointer;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      user-select: none;
      transition: background-color 0.15s ease;
    }
    .new-playlist-container button:hover {
      background-color: #1aa34a;
    }
    section.main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: #181818;
      padding: 1rem;
      overflow: hidden;
      box-sizing: border-box;
    }
    body.light section.main-content {
      background-color: #f5f5f5;
      color: #000;
    }
    .header {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .header input[type="search"] {
      flex: 1;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      border: none;
      font-size: 1rem;
      background-color: #282828;
      color: white;
      outline-offset: 2px;
    }
    body.light .header input[type="search"] {
      background-color: #fff;
      color: #000;
      border: 1px solid #ccc;
    }
    button#toggleThemeBtn {
      padding: 0.4rem 1rem;
      background: #1db954;
      border: none;
      border-radius: 20px;
      color: white;
      cursor: pointer;
      font-weight: 600;
      user-select: none;
      flex-shrink: 0;
      outline-offset: 2px;
      transition: background-color 0.15s ease;
    }
    button#toggleThemeBtn:hover {
      background: #17a34a;
    }
    .features-container {
      position: relative;
      flex-shrink: 0;
    }
    button#featuresBtn {
      padding: 0.4rem 1rem;
      border-radius: 20px;
      border: none;
      background-color: #282828;
      color: white;
      cursor: pointer;
      font-weight: 600;
      user-select: none;
      outline-offset: 2px;
      transition: background-color 0.15s ease;
    }
    button#featuresBtn:hover {
      background-color: #1db954;
    }
    #featuresMenu {
      position: absolute;
      top: 110%;
      right: 0;
      background: #282828;
      border-radius: 6px;
      box-shadow: 0 0 12px rgba(0,0,0,0.8);
      display: none;
      flex-direction: column;
      z-index: 10;
      min-width: 160px;
      padding: 0.25rem 0;
      user-select: none;
    }
    #featuresMenu.show {
      display: flex;
    }
    #featuresMenu button {
      background: none;
      border: none;
      color: white;
      text-align: left;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-weight: 600;
    }
    #featuresMenu button:hover,
    #featuresMenu button:focus {
      background-color: #1db954;
      outline: none;
    }
    .songs-table-container {
      flex: 1;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid #282828;
      background-color: #121212;
      box-sizing: border-box;
      user-select: none;
    }
    body.light .songs-table-container {
      background-color: #fff;
      border: 1px solid #ccc;
      color: #000;
    }
    table#songsTable {
      width: 100%;
      border-collapse: collapse;
      color: inherit;
    }
    table#songsTable thead tr {
      background-color: #1db954;
      color: white;
      user-select: none;
      font-weight: 700;
    }
    body.light table#songsTable thead tr {
      background-color: #17a34a;
      color: white;
    }
    table#songsTable th, table#songsTable td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid #282828;
    }
    body.light table#songsTable th, body.light table#songsTable td {
      border-color: #ddd;
    }
    table#songsTable tbody tr:hover,
    table#songsTable tbody tr.selected {
      background-color: #1db954;
      color: white;
      cursor: pointer;
    }
    .queue-container {
      width: 260px;
      background: #000;
      color: #b3b3b3;
      padding: 1rem;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    .queue-container h2 {
      margin: 0 0 1rem 0;
      color: #1db954;
      font-weight: 700;
      user-select: none;
    }
    .queue-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      user-select: none;
    }
    .queue-item {
      background: #121212;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }
    .queue-item.selected {
      background-color: #1db954;
      color: white;
    }
    .queue-item button {
      background: none;
      border: none;
      color: #ff5555;
      font-weight: 700;
      cursor: pointer;
      font-size: 1.1rem;
      line-height: 1;
      user-select: none;
    }
    .queue-item button:hover {
      color: #ff2222;
    }
    footer.now-playing-footer {
      background-color: #181818;
      padding: 0.8rem 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-sizing: border-box;
      color: white;
      user-select: none;
      flex-wrap: wrap;
    }
    body.light footer.now-playing-footer {
      background-color: #f0f0f0;
      color: #000;
    }
    .now-playing-info {
      flex: 1;
      min-width: 0;
      user-select: none;
    }
    .now-playing-title {
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .now-playing-artist {
      font-size: 0.9rem;
      color: #b3b3b3;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .player-controls {
      display: flex;
      gap: 0.5rem;
      user-select: none;
      flex-wrap: wrap;
    }
    .player-controls button {
      background: none;
      border: none;
      color: white;
      font-size: 1.8rem;
      cursor: pointer;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      transition: background-color 0.15s ease;
      user-select: none;
    }
    body.light .player-controls button {
      color: #000;
    }
    .player-controls button:hover,
    .player-controls button:focus {
      background-color: #1db954;
      color: white;
      outline: none;
    }
    .progress-container {
      position: relative;
      flex: 2;
      height: 8px;
      background-color: #282828;
      border-radius: 20px;
      cursor: pointer;
      user-select: none;
      margin: 0 1rem;
      min-width: 150px;
      outline-offset: 2px;
    }
    .progress-filled {
      background-color: #1db954;
      height: 100%;
      border-radius: 20px 0 0 20px;
      width: 0%;
      transition: width 0.1s linear;
    }
    .time-container {
      font-size: 0.85rem;
      user-select: none;
      display: flex;
      gap: 0.5rem;
      min-width: 80px;
      justify-content: flex-end;
      color: #b3b3b3;
    }
    body.light .time-container {
      color: #555;
    }
    .volume-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      user-select: none;
      min-width: 100px;
    }
    .volume-container input[type=range] {
      flex: 1;
      cursor: pointer;
    }
    /* Equalizer Panel */
    #eqPanel {
      position: fixed;
      top: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: #181818;
      border: 2px solid #1db954;
      border-radius: 8px;
      padding: 1rem;
      z-index: 1000;
      display: none;
      width: 360px;
      box-sizing: border-box;
      user-select: none;
      color: white;
      box-shadow: 0 0 12px #1db954aa;
    }
    #eqPanel[aria-hidden="false"] {
      display: block;
    }
    #eqHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: grab;
      user-select: none;
      margin-bottom: 1rem;
    }
    #eqHeader:active {
      cursor: grabbing;
    }
    #eqHeader span {
      font-weight: 700;
      font-size: 1.2rem;
    }
    #eqCloseBtn {
      background: none;
      border: none;
      color: #ff5555;
      font-size: 1.6rem;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      line-height: 1;
      transition: color 0.15s ease;
    }
    #eqCloseBtn:hover {
      color: #ff2222;
    }
    .eq-content {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      flex-wrap: nowrap;
    }
    .eq-band {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 30px;
      user-select: none;
      color: #ddd;
      font-size: 0.8rem;
    }
    .eq-band label {
      margin-bottom: 6px;
      user-select: none;
      color: #1db954;
    }
    .eq-band input[type=range] {
      writing-mode: bt-lr; /* vertical slider */
      -webkit-appearance: slider-vertical;
      width: 30px;
      height: 120px;
      background: #282828;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
    }
    .eq-band input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: #1db954;
      cursor: pointer;
      border-radius: 50%;
      border: none;
      user-select: none;
    }
    .eq-band input[type=range]:focus {
      outline: 2px solid #1db954;
      outline-offset: 2px;
    }
    /* Scrollbar for songs and sidebar */
    nav.sidebar::-webkit-scrollbar,
    .songs-table-container::-webkit-scrollbar,
    .queue-container::-webkit-scrollbar {
      width: 8px;
    }
    nav.sidebar::-webkit-scrollbar-thumb,
    .songs-table-container::-webkit-scrollbar-thumb,
    .queue-container::-webkit-scrollbar-thumb {
      background-color: #1db954;
      border-radius: 10px;
    }
    /* Responsive */
    @media (max-width: 900px) {
      .container {
        flex-direction: column;
      }
      nav.sidebar, .queue-container {
        width: 100%;
        height: 150px;
        display: flex;
        overflow-x: auto;
        overflow-y: hidden;
        padding: 0.5rem 1rem;
      }
      nav.sidebar {
        order: 1;
      }
      .queue-container {
        order: 3;
        background-color: #181818;
        color: #b3b3b3;
      }
      section.main-content {
        order: 2;
        flex: 1;
        height: calc(100vh - 300px);
        padding: 0.5rem;
      }
      .songs-table-container {
        border-radius: 0;
        border: none;
      }
    }
  </style>
</head>
<body class="dark" aria-label="Music Player">

  <div class="container" role="main" aria-label="Music Player Application">

    <!-- Sidebar playlists -->
    <nav class="sidebar" aria-label="Playlists and Controls">
      <h1>Music</h1>
      <button id="btnAllSongs" class="playlist-btn active" aria-pressed="true" aria-label="Show all songs">All Songs</button>
      <div id="playlistsContainer" aria-label="User Playlists"></div>
      <div class="new-playlist-container">
        <input type="text" id="newPlaylistInput" placeholder="New Playlist Name" aria-label="New playlist name" />
        <button id="btnCreatePlaylist" aria-label="Create new playlist">Add</button>
      </div>
    </nav>

    <!-- Main Content -->
    <section class="main-content" aria-label="Main music content">
      <div class="header">
        <input type="search" id="searchInput" placeholder="Search songs..." aria-label="Search songs" />
        <button id="toggleThemeBtn" aria-pressed="false" aria-label="Toggle dark and light mode">Dark Mode</button>
        <div class="features-container">
          <button id="featuresBtn" aria-haspopup="true" aria-expanded="false" aria-controls="featuresMenu" aria-label="Open features menu">Features ▼</button>
          <div id="featuresMenu" role="menu" aria-hidden="true" tabindex="-1">
            <button role="menuitem" id="openEqBtn">Equalizer</button>
            <!-- Add more features here -->
          </div>
        </div>
      </div>
      <div class="songs-table-container" tabindex="0" aria-label="Songs list">
        <table id="songsTable" role="grid" aria-rowcount="0" aria-colcount="4">
          <thead>
            <tr role="row">
              <th role="columnheader" scope="col" style="width:5%;">#</th>
              <th role="columnheader" scope="col" style="width:50%;">Title</th>
              <th role="columnheader" scope="col" style="width:25%;">Created</th>
              <th role="columnheader" scope="col" style="width:20%;">Duration</th>
            </tr>
          </thead>
          <tbody id="songsTbody" role="rowgroup"></tbody>
        </table>
      </div>
    </section>

    <!-- Queue Sidebar -->
    <aside class="queue-container" aria-label="Playback Queue">
      <h2>Queue</h2>
      <div id="queueList" class="queue-list" role="list"></div>
    </aside>
  </div>

  <!-- Now Playing Footer -->
  <footer class="now-playing-footer" aria-live="polite" aria-atomic="true" aria-relevant="text">
    <div class="now-playing-info" aria-label="Now playing information">
      <div class="now-playing-title" id="nowPlayingTitle">No song playing</div>
      <div class="now-playing-artist" id="nowPlayingArtist">&nbsp;</div>
    </div>
    <div class="player-controls" role="group" aria-label="Playback controls">
      <button id="prevBtn" aria-label="Previous track" title="Previous track">⏮️</button>
      <button id="playPauseBtn" aria-label="Play/Pause" title="Play or pause">▶️</button>
      <button id="nextBtn" aria-label="Next track" title="Next track">⏭️</button>
      <button id="shuffleBtn" aria-label="Shuffle" title="Shuffle playlist">🔀</button>
    </div>
    <div class="progress-container" role="slider" aria-label="Playback progress" tabindex="0" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
      <div class="progress-filled"></div>
    </div>
    <div class="time-container" aria-hidden="true">
      <span id="currentTime">0:00</span> / <span id="durationTime">0:00</span>
    </div>
    <div class="volume-container" role="group" aria-label="Volume controls">
      <label for="volumeSlider" class="visually-hidden">Volume</label>
      <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.7" aria-valuetext="Volume control" />
    </div>
  </footer>

  <!-- Audio element (hidden) -->
  <audio id="audio" crossorigin="anonymous"></audio>

  <!-- Equalizer Panel -->
  <section id="eqPanel" aria-hidden="true" aria-label="Equalizer settings" tabindex="-1">
    <div id="eqHeader" tabindex="0">
      <span>Equalizer</span>
      <button id="eqCloseBtn" aria-label="Close equalizer panel">✕</button>
    </div>
    <div class="eq-content" role="presentation" aria-hidden="true">
      <div class="eq-band">
        <label for="eq60">60Hz</label>
        <input type="range" min="-12" max="12" step="0.1" value="0" id="eq60" aria-valuemin="-12" aria-valuemax="12" aria-valuenow="0" />
      </div>
      <div class="eq-band">
        <label for="eq170">170Hz</label>
        <input type="range" min="-12" max="12" step="0.1" value="0" id="eq170" aria-valuemin="-12" aria-valuemax="12" aria-valuenow="0" />
      </div>
      <div class="eq-band">
        <label for="eq310">310Hz</label>
        <input type="range" min="-12" max="12" step="0.1" value="0" id="eq310" aria-valuemin="-12" aria-valuemax="12" aria-valuenow="0" />
      </div>
      <div class="eq-band">
        <label for="eq600">600Hz</label>
        <input type="range" min="-12" max="12" step="0.1" value="0" id="eq600" aria-valuemin="-12" aria-valuemax="12" aria-valuenow="0" />
      </div>
      <div class="eq-band">
        <label for="eq1k">1kHz</label>
        <input type="range" min="-12" max="12" step="0.1" value="0" id="eq1k" aria-valuemin="-12" aria-valuemax="12" aria-valuenow="0" />
      </div>
      <div class="eq-band">
        <label for="eq3k">3kHz</label>
        <input type="range" min="-12" max="12" step="0.1" value="0" id="eq3k" aria-valuemin="-12" aria-valuemax="12" aria-valuenow="0" />
      </div>
      <div class="eq-band">
        <label for="eq6k">6kHz</label>
        <input type="range" min="-12" max="12" step="0.1" value="0" id="eq6k" aria-valuemin="-12" aria-valuemax="12" aria-valuenow="0" />
      </div>
      <div class="eq-band">
        <label for="eq12k">12kHz</label>
        <input type="range" min="-12" max="12" step="0.1" value="0" id="eq12k" aria-valuemin="-12" aria-valuemax="12" aria-valuenow="0" />
      </div>
      <div class="eq-band">
        <label for="eq14k">14kHz</label>
        <input type="range" min="-12" max="12" step="0.1" value="0" id="eq14k" aria-valuemin="-12" aria-valuemax="12" aria-valuenow="0" />
      </div>
      <div class="eq-band">
        <label for="eq16k">16kHz</label>
        <input type="range" min="-12" max="12" step="0.1" value="0" id="eq16k" aria-valuemin="-12" aria-valuemax="12" aria-valuenow="0" />
      </div>
    </div>
  </section>

  <script>
  // === CONSTANTS ===
  const API_KEY = 'AIzaSyDsYE91wH7UDwu8eZNbD1CFuVcilgYeZhI';  // Your actual API key
  const FOLDER_ID = '1DGz9zEQh29EAqTZpmWK5mwSj5HComnkn';     // Your Google Drive folder ID

  // === DOM ELEMENTS ===
  const audio = document.getElementById('audio');
  const songsTbody = document.getElementById('songsTbody');
  const searchInput = document.getElementById('searchInput');
  const btnAllSongs = document.getElementById('btnAllSongs');
  const playlistsContainer = document.getElementById('playlistsContainer');
  const newPlaylistInput = document.getElementById('newPlaylistInput');
  const btnCreatePlaylist = document.getElementById('btnCreatePlaylist');
  const toggleThemeBtn = document.getElementById('toggleThemeBtn');
  const featuresBtn = document.getElementById('featuresBtn');
  const featuresMenu = document.getElementById('featuresMenu');
  const openEqBtn = document.getElementById('openEqBtn');
  const eqPanel = document.getElementById('eqPanel');
  const eqCloseBtn = document.getElementById('eqCloseBtn');
  const nowPlayingTitle = document.getElementById('nowPlayingTitle');
  const nowPlayingArtist = document.getElementById('nowPlayingArtist');
  const prevBtn = document.getElementById('prevBtn');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const nextBtn = document.getElementById('nextBtn');
  const shuffleBtn = document.getElementById('shuffleBtn');
  const queueList = document.getElementById('queueList');
  const progressContainer = document.querySelector('.progress-container');
  const progressFilled = document.querySelector('.progress-filled');
  const currentTimeElem = document.getElementById('currentTime');
  const durationTimeElem = document.getElementById('durationTime');
  const volumeSlider = document.getElementById('volumeSlider');

  // === STATE VARIABLES ===
  let songs = [];
  let filteredSongs = [];
  let playlists = JSON.parse(localStorage.getItem('playlists') || '{}');
  let currentPlaylist = null;  // null means all songs
  let currentSongIndex = 0;
  let isPlaying = false;
  let isDark = true;
  let audioCtx;
  let sourceNode;
  let eqFilters = [];

  // EQ frequencies:
  const eqBandsFreqs = [60, 170, 310, 600, 1000, 3000, 6000, 12000, 14000, 16000];

  // === FUNCTIONS ===

  // Format seconds to mm:ss
  function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60);
    return m + ':' + (s < 10 ? '0' : '') + s;
  }

  // Fetch songs from Google Drive folder using Drive API v3
  async function fetchSongsFromDrive() {
    let allFiles = [];
    let pageToken = null;
    const q = `'${FOLDER_ID}' in parents and (mimeType contains 'audio/')`;

    try {
      do {
        const url = new URL('https://www.googleapis.com/drive/v3/files');
        url.searchParams.set('q', q);
        url.searchParams.set('fields', 'nextPageToken, files(id, name, createdTime, mimeType)');
        url.searchParams.set('pageSize', '100');
        url.searchParams.set('key', API_KEY);
        if (pageToken) url.searchParams.set('pageToken', pageToken);

        const res = await fetch(url);
        const data = await res.json();

        if (data.error) throw new Error(data.error.message);

        allFiles = allFiles.concat(data.files);
        pageToken = data.nextPageToken;
      } while (pageToken);

      // Sort files by name
      allFiles.sort((a, b) => a.name.localeCompare(b.name));
      return allFiles;
    } catch (err) {
      console.error('Failed to fetch songs:', err);
      alert('Failed to load songs from Google Drive. Check your API key and folder permissions.');
      return [];
    }
  }

  // Render playlists sidebar buttons
  function renderPlaylists() {
    playlistsContainer.innerHTML = '';
    Object.keys(playlists).forEach(name => {
      const btn = document.createElement('button');
      btn.className = 'playlist-btn';
      btn.textContent = name;
      btn.setAttribute('aria-pressed', currentPlaylist === name);
      if (currentPlaylist === name) btn.classList.add('active');
      btn.onclick = () => {
        loadPlaylist(name);
      };
      playlistsContainer.appendChild(btn);
    });
  }

  // Load a playlist by name
  function loadPlaylist(name) {
    currentPlaylist = name;
    const ids = playlists[name];
    filteredSongs = songs.filter(s => ids.includes(s.id));
    renderSongsTable();
    updateQueueUI();
    updateNowPlayingInfo();
    highlightSelectedSong();
    btnAllSongs.classList.remove('active');
    Array.from(playlistsContainer.children).forEach(btn => {
      btn.classList.toggle('active', btn.textContent === name);
      btn.setAttribute('aria-pressed', btn.textContent === name);
    });
  }

  // Render songs table body
  function renderSongsTable() {
    songsTbody.innerHTML = '';
    songsTbody.setAttribute('aria-rowcount', filteredSongs.length);
    filteredSongs.forEach((song, idx) => {
      const tr = document.createElement('tr');
      tr.tabIndex = 0;
      tr.setAttribute('role', 'row');
      tr.className = idx === currentSongIndex ? 'selected' : '';
      tr.onclick = () => playSongAtIndex(idx);
      tr.onkeydown = e => {
        if(e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          playSongAtIndex(idx);
        }
      };

      const tdIndex = document.createElement('td');
      tdIndex.textContent = idx + 1;
      tdIndex.setAttribute('role', 'gridcell');
      const tdName = document.createElement('td');
      tdName.textContent = song.name;
      tdName.setAttribute('role', 'gridcell');
      const tdCreated = document.createElement('td');
      tdCreated.textContent = new Date(song.createdTime).toLocaleDateString();
      tdCreated.setAttribute('role', 'gridcell');
      const tdDuration = document.createElement('td');
      tdDuration.textContent = formatTime(song.duration || 0);
      tdDuration.setAttribute('role', 'gridcell');

      tr.append(tdIndex, tdName, tdCreated, tdDuration);
      songsTbody.appendChild(tr);
    });
  }

  // Update queue UI
  function updateQueueUI() {
    queueList.innerHTML = '';
    filteredSongs.forEach((song, idx) => {
      const div = document.createElement('div');
      div.className = 'queue-item' + (idx === currentSongIndex ? ' selected' : '');
      div.textContent = song.name;
      div.tabIndex = 0;
      div.setAttribute('role', 'listitem');
      div.onclick = () => playSongAtIndex(idx);
      div.onkeydown = e => {
        if(e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          playSongAtIndex(idx);
        }
      };

      // Remove button for playlist only
      if(currentPlaylist) {
        const removeBtn = document.createElement('button');
        removeBtn.textContent = '×';
        removeBtn.title = `Remove from playlist "${currentPlaylist}"`;
        removeBtn.onclick = e => {
          e.stopPropagation();
          playlists[currentPlaylist] = playlists[currentPlaylist].filter(id => id !== filteredSongs[idx].id);
          localStorage.setItem('playlists', JSON.stringify(playlists));
          loadPlaylist(currentPlaylist);
        };
        div.appendChild(removeBtn);
      }
      queueList.appendChild(div);
    });
  }

  // Highlight selected song in songs table
  function highlightSelectedSong() {
    const trs = songsTbody.querySelectorAll('tr');
    trs.forEach((tr, idx) => {
      tr.classList.toggle('selected', idx === currentSongIndex);
    });
    updateQueueUI();
  }

  // Play song by index in filteredSongs
  function playSongAtIndex(idx) {
    if(idx < 0 || idx >= filteredSongs.length) return;
    currentSongIndex = idx;
    const song = filteredSongs[idx];
    if(!song) return;

    // Set audio source to Drive direct download
    audio.src = `https://www.googleapis.com/drive/v3/files/${song.id}?alt=media&key=${API_KEY}`;
    audio.play().catch(() => {});
    isPlaying = true;
    updatePlayPauseBtn();
    highlightSelectedSong();
    updateNowPlayingInfo();
  }

  // Update now playing info
  function updateNowPlayingInfo() {
    const song = filteredSongs[currentSongIndex];
    if(!song) {
      nowPlayingTitle.textContent = 'No song playing';
      nowPlayingArtist.textContent = '\u00A0';
      return;
    }
    nowPlayingTitle.textContent = song.name;
    // Artist metadata is not available, so we leave blank
    nowPlayingArtist.textContent = `Created: ${new Date(song.createdTime).toLocaleDateString()}`;
  }

  // Playback controls
  function playPause() {
    if(isPlaying) {
      audio.pause();
      isPlaying = false;
    } else {
      audio.play().catch(() => {});
      isPlaying = true;
    }
    updatePlayPauseBtn();
  }
  function updatePlayPauseBtn() {
    playPauseBtn.textContent = isPlaying ? '⏸️' : '▶️';
    playPauseBtn.setAttribute('aria-pressed', isPlaying);
  }
  function playNext() {
    currentSongIndex++;
    if(currentSongIndex >= filteredSongs.length) currentSongIndex = 0;
    playSongAtIndex(currentSongIndex);
  }
  function playPrev() {
    currentSongIndex--;
    if(currentSongIndex < 0) currentSongIndex = filteredSongs.length - 1;
    playSongAtIndex(currentSongIndex);
  }
  function shuffle() {
    if(filteredSongs.length < 2) return;
    let newIndex;
    do {
      newIndex = Math.floor(Math.random() * filteredSongs.length);
    } while(newIndex === currentSongIndex);
    playSongAtIndex(newIndex);
  }

  // Progress bar update
  audio.addEventListener('timeupdate', () => {
    const percent = audio.currentTime / audio.duration * 100 || 0;
    progressFilled.style.width = percent + '%';
    currentTimeElem.textContent = formatTime(audio.currentTime);
    durationTimeElem.textContent = formatTime(audio.duration);
    progressContainer.setAttribute('aria-valuenow', Math.floor(percent));
  });
  progressContainer.addEventListener('click', e => {
    const rect = progressContainer.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    audio.currentTime = percent * audio.duration;
  });
  progressContainer.addEventListener('keydown', e => {
    if(e.key === 'ArrowLeft' || e.key === 'ArrowDown') {
      audio.currentTime = Math.max(0, audio.currentTime - 5);
    } else if(e.key === 'ArrowRight' || e.key === 'ArrowUp') {
      audio.currentTime = Math.min(audio.duration, audio.currentTime + 5);
    }
  });

  // Volume control
  volumeSlider.addEventListener('input', () => {
    audio.volume = volumeSlider.value;
  });

  // Search
  searchInput.addEventListener('input', () => {
    const q = searchInput.value.toLowerCase();
    filteredSongs = (currentPlaylist ? songs.filter(s => playlists[currentPlaylist]?.includes(s.id)) : songs)
      .filter(s => s.name.toLowerCase().includes(q));
    renderSongsTable();
    highlightSelectedSong();
    updateQueueUI();
  });

  // Toggle dark/light mode
  toggleThemeBtn.addEventListener('click', () => {
    isDark = !isDark;
    document.body.classList.toggle('light', !isDark);
    toggleThemeBtn.textContent = isDark ? 'Dark Mode' : 'Light Mode';
    toggleThemeBtn.setAttribute('aria-pressed', !isDark);
  });

  // Playlists creation
  btnCreatePlaylist.addEventListener('click', () => {
    const name = newPlaylistInput.value.trim();
    if(!name) return alert('Enter playlist name');
    if(playlists[name]) return alert('Playlist already exists');
    playlists[name] = [];
    localStorage.setItem('playlists', JSON.stringify(playlists));
    newPlaylistInput.value = '';
    renderPlaylists();
  });

  // Load All Songs button
  btnAllSongs.addEventListener('click', () => {
    currentPlaylist = null;
    filteredSongs = songs;
    renderSongsTable();
    updateQueueUI();
    updateNowPlayingInfo();
    highlightSelectedSong();
    btnAllSongs.classList.add('active');
    Array.from(playlistsContainer.children).forEach(btn => {
      btn.classList.remove('active');
      btn.setAttribute('aria-pressed', false);
    });
    btnAllSongs.setAttribute('aria-pressed', true);
  });

  // Features menu toggling
  featuresBtn.addEventListener('click', () => {
    const isExpanded = featuresBtn.getAttribute('aria-expanded') === 'true';
    featuresBtn.setAttribute('aria-expanded', !isExpanded);
    if(!isExpanded) {
      featuresMenu.classList.add('show');
      featuresMenu.setAttribute('aria-hidden', 'false');
      featuresMenu.focus();
    } else {
      featuresMenu.classList.remove('show');
      featuresMenu.setAttribute('aria-hidden', 'true');
    }
  });

  // Close features menu on outside click or ESC
  document.addEventListener('click', e => {
    if(!featuresBtn.contains(e.target) && !featuresMenu.contains(e.target)) {
      featuresBtn.setAttribute('aria-expanded', false);
      featuresMenu.classList.remove('show');
      featuresMenu.setAttribute('aria-hidden', 'true');
    }
  });
  document.addEventListener('keydown', e => {
    if(e.key === 'Escape') {
      featuresBtn.setAttribute('aria-expanded', false);
      featuresMenu.classList.remove('show');
      featuresMenu.setAttribute('aria-hidden', 'true');
      eqPanel.setAttribute('aria-hidden', 'true');
      eqPanel.style.display = 'none';
    }
  });

  // Open Equalizer panel
  openEqBtn.addEventListener('click', () => {
    eqPanel.style.display = 'block';
    eqPanel.setAttribute('aria-hidden', 'false');
    eqPanel.focus();
    featuresBtn.setAttribute('aria-expanded', false);
    featuresMenu.classList.remove('show');
    featuresMenu.setAttribute('aria-hidden', 'true');
  });

  // Close EQ panel
  eqCloseBtn.addEventListener('click', () => {
    eqPanel.style.display = 'none';
    eqPanel.setAttribute('aria-hidden', 'true');
  });

  // Make EQ panel draggable
  (function makeDraggable() {
    let dragTarget = eqPanel;
    let header = document.getElementById('eqHeader');
    let isDragging = false;
    let startX, startY, origX, origY;

    header.addEventListener('mousedown', e => {
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
      const rect = dragTarget.getBoundingClientRect();
      origX = rect.left;
      origY = rect.top;
      header.style.cursor = 'grabbing';
      e.preventDefault();
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
      header.style.cursor = 'grab';
    });

    document.addEventListener('mousemove', e => {
      if(!isDragging) return;
      let dx = e.clientX - startX;
      let dy = e.clientY - startY;
      dragTarget.style.left = (origX + dx) + 'px';
      dragTarget.style.top = (origY + dy) + 'px';
      dragTarget.style.transform = 'none';
    });
  })();

  // Initialize Web Audio API with equalizer
  function setupAudioContext() {
    if(audioCtx) return;

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    sourceNode = audioCtx.createMediaElementSource(audio);

    // Create filters for EQ bands
    eqFilters = eqBandsFreqs.map(freq => {
      const filter = audioCtx.createBiquadFilter();
      filter.type = 'peaking';
      filter.frequency.value = freq;
      filter.Q.value = 1;
      filter.gain.value = 0;
      return filter;
    });

    // Chain filters
    sourceNode.connect(eqFilters[0]);
    for(let i=0; i < eqFilters.length - 1; i++) {
      eqFilters[i].connect(eqFilters[i+1]);
    }
    eqFilters[eqFilters.length - 1].connect(audioCtx.destination);

    // Connect volume control later on audio element volume property
  }

  // Update EQ gain on slider change
  function setupEQControls() {
    eqBandsFreqs.forEach((freq, i) => {
      const slider = document.getElementById('eq' + freq);
      slider.addEventListener('input', () => {
        if(eqFilters[i]) eqFilters[i].gain.value = slider.value;
      });
    });
  }

  // On audio play, resume context if suspended (required by browsers)
  audio.addEventListener('play', () => {
    if(audioCtx && audioCtx.state === 'suspended') {
      audioCtx.resume();
    }
  });

  // On audio ended, auto-play next
  audio.addEventListener('ended', () => {
    playNext();
  });

  // Initial setup function
  async function init() {
    // Setup Audio Context and EQ
    setupAudioContext();
    setupEQControls();

    // Load songs from Drive
    songs = await fetchSongsFromDrive();
    filteredSongs = songs;

    // Add dummy duration (Drive API doesn't return duration directly)
    // You can extend with ID3 parsing library if needed
    songs.forEach(s => { s.duration = 0; });

    renderSongsTable();
    renderPlaylists();
    updateQueueUI();

    // Default to All Songs view
    currentPlaylist = null;
    btnAllSongs.classList.add('active');
    btnAllSongs.setAttribute('aria-pressed', 'true');

    // Volume init
    audio.volume = volumeSlider.value;
  }

  // Run init on DOMContentLoaded
  document.addEventListener('DOMContentLoaded', init);

  </script>
</body>
</html>
