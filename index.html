<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Apple Music iTunes 1:1 Replica - Google Drive Player</title>
<style>
  /* Reset & base */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    background: #121212;
    color: #eee;
    overflow: hidden;
    user-select: none;
    transition: background 0.3s, color 0.3s;
  }
  body.light {
    background: #f9f9f9;
    color: #111;
  }
  a {
    color: inherit;
    text-decoration: none;
  }
  button {
    cursor: pointer;
    background: none;
    border: none;
    color: inherit;
    font-size: 14px;
    font-weight: 600;
    transition: color 0.2s;
  }
  button:hover {
    color: #1db954;
  }
  /* Layout */
  .app {
    display: flex;
    flex-direction: column;
    height: 100vh;
    width: 100vw;
  }
  .main-content {
    flex: 1;
    display: flex;
    overflow: hidden;
  }
  /* Sidebar */
  .sidebar {
    width: 250px;
    background: #000;
    border-right: 1px solid #333;
    display: flex;
    flex-direction: column;
    padding: 20px 10px;
    transition: background 0.3s, color 0.3s;
  }
  body.light .sidebar {
    background: #f0f0f0;
    color: #111;
    border-color: #ccc;
  }
  .sidebar h2 {
    margin: 0 0 20px 0;
    font-size: 22px;
    font-weight: 900;
    color: #1db954;
    text-align: center;
    letter-spacing: 1.5px;
  }
  .sidebar button {
    display: block;
    width: 100%;
    padding: 10px 15px;
    text-align: left;
    border-radius: 4px;
    margin-bottom: 5px;
  }
  .sidebar button.active,
  .sidebar button:hover {
    background: #1db954;
    color: #000;
    font-weight: 700;
  }
  /* Playlist list placeholder */
  .playlist-list {
    margin-top: 20px;
    flex-grow: 1;
    overflow-y: auto;
  }
  .playlist-list button {
    padding-left: 25px;
    font-weight: 500;
    font-size: 14px;
  }
  /* Middle content (Library & song list) */
  .library {
    flex: 2;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #333;
    transition: background 0.3s, color 0.3s;
  }
  body.light .library {
    border-color: #ccc;
  }
  .library-header {
    padding: 10px 20px;
    background: #181818;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #333;
    transition: background 0.3s, border-color 0.3s;
    gap: 15px;
    flex-wrap: wrap;
  }
  body.light .library-header {
    background: #fff;
    border-color: #ccc;
    color: #111;
  }
  #toggleThemeBtn {
    background: #1db954;
    color: #000;
    font-weight: 700;
    padding: 8px 14px;
    border-radius: 18px;
    border: none;
    cursor: pointer;
    user-select: none;
    transition: background 0.3s;
    flex-shrink: 0;
    white-space: nowrap;
  }
  #toggleThemeBtn:hover {
    background: #17a44c;
  }
  #searchInput {
    padding: 7px 15px;
    border-radius: 14px;
    border: none;
    flex-grow: 1;
    min-width: 200px;
    font-size: 14px;
    background: #282828;
    color: #eee;
    outline: none;
    transition: background 0.3s, color 0.3s;
  }
  body.light #searchInput {
    background: #eee;
    color: #111;
  }
  /* Song Table */
  table {
    width: 100%;
    border-collapse: collapse;
    user-select: none;
    table-layout: fixed;
    flex-grow: 1;
    display: block;
    overflow-y: auto;
    height: calc(100% - 52px);
  }
  thead {
    background: #282828;
    color: #bbb;
    font-size: 12px;
    font-weight: 700;
    display: table;
    width: 100%;
    table-layout: fixed;
  }
  body.light thead {
    background: #ddd;
    color: #555;
  }
  tbody {
    display: block;
    max-height: calc(100vh - 180px);
    overflow-y: auto;
    width: 100%;
  }
  th, td {
    padding: 10px 12px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    vertical-align: middle;
    cursor: default;
    display: table-cell;
  }
  th {
    text-align: left;
    user-select: text;
  }
  tbody tr {
    border-bottom: 1px solid #282828;
    transition: background 0.2s;
    display: table;
    width: 100%;
    table-layout: fixed;
  }
  body.light tbody tr {
    border-color: #ccc;
  }
  tbody tr:hover {
    background: #1db954;
    color: #000;
  }
  tbody tr.selected {
    background: #1db954;
    color: #000;
    font-weight: 700;
  }
  tbody tr.selected:hover {
    background: #17a44c;
  }
  /* Table column widths */
  th.name, td.name {
    width: 35%;
  }
  th.artist, td.artist {
    width: 25%;
  }
  th.album, td.album {
    width: 25%;
  }
  th.duration, td.duration {
    width: 15%;
    text-align: right;
    padding-right: 20px;
    font-variant-numeric: tabular-nums;
  }
  /* Right sidebar (Up Next queue) */
  .queue {
    width: 300px;
    background: #000;
    display: flex;
    flex-direction: column;
    padding: 20px 10px;
    transition: background 0.3s, color 0.3s;
  }
  body.light .queue {
    background: #f0f0f0;
    color: #111;
  }
  .queue h3 {
    font-size: 20px;
    font-weight: 700;
    margin: 0 0 10px 0;
    text-align: center;
    color: #1db954;
  }
  .queue-list {
    flex-grow: 1;
    overflow-y: auto;
  }
  .queue-item {
    padding: 8px 10px;
    border-bottom: 1px solid #282828;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    transition: background 0.2s;
  }
  body.light .queue-item {
    border-color: #ccc;
  }
  .queue-item:hover {
    background: #1db954;
    color: #000;
  }
  .queue-item.selected {
    background: #1db954;
    font-weight: 700;
    color: #000;
  }
  .queue-item span {
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    width: 90%;
  }
  .queue-item button {
    background: none;
    border: none;
    color: #1db954;
    font-weight: 700;
    font-size: 18px;
    cursor: pointer;
    user-select: none;
  }
  /* Bottom now playing bar */
  .now-playing-bar {
    height: 120px;
    background: #181818;
    border-top: 1px solid #333;
    display: flex;
    align-items: center;
    padding: 0 25px;
    color: #eee;
    user-select: none;
    transition: background 0.3s, color 0.3s;
    gap: 20px;
    flex-wrap: wrap;
  }
  body.light .now-playing-bar {
    background: #f9f9f9;
    border-color: #ccc;
    color: #111;
  }
  .now-playing-info {
    flex: 1 1 300px;
    overflow: hidden;
    min-width: 200px;
  }
  .now-playing-title {
    font-weight: 700;
    font-size: 18px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 6px;
  }
  .now-playing-artist {
    font-size: 14px;
    color: #888;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  body.light .now-playing-artist {
    color: #666;
  }
  .player-controls {
    display: flex;
    align-items: center;
    gap: 20px;
    user-select: none;
    flex-shrink: 0;
  }
  .player-controls button {
    background: none;
    border: none;
    font-size: 28px;
    color: inherit;
    cursor: pointer;
    transition: color 0.3s;
    user-select: none;
  }
  .player-controls button:hover {
    color: #1db954;
  }
  .progress-container {
    flex-grow: 2;
    min-width: 250px;
    display: flex;
    flex-direction: column;
    user-select: none;
  }
  .progress-bar {
    width: 100%;
    height: 6px;
    background: #333;
    border-radius: 4px;
    cursor: pointer;
    position: relative;
    margin-bottom: 6px;
  }
  .progress-filled {
    height: 100%;
    background: #1db954;
    border-radius: 4px;
    width: 0%;
    transition: width 0.1s linear;
  }
  .time-container {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #888;
  }
  body.light .time-container {
    color: #666;
  }
  .volume-container {
    width: 150px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .volume-slider {
    flex-grow: 1;
  }
  input[type=range] {
    -webkit-appearance: none;
    width: 100%;
    height: 4px;
    background: #444;
    border-radius: 4px;
    cursor: pointer;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    background: #1db954;
    cursor: pointer;
    border-radius: 50%;
  }
  input[type=range]::-moz-range-thumb {
    width: 16px;
    height: 16px;
    background: #1db954;
    cursor: pointer;
    border-radius: 50%;
  }
  /* Features dropdown button */
  #featuresBtn {
    background: #1db954;
    color: #000;
    font-weight: 700;
    padding: 8px 14px;
    border-radius: 18px;
    border: none;
    cursor: pointer;
    user-select: none;
    transition: background 0.3s;
    white-space: nowrap;
  }
  #featuresBtn:hover {
    background: #17a44c;
  }
  /* Features menu */
  #featuresMenu {
    position: absolute;
    top: 40px;
    left: 0;
    background: #181818;
    border: 1px solid #1db954;
    border-radius: 6px;
    min-width: 160px;
    display: none;
    flex-direction: column;
    z-index: 9999;
  }
  #featuresMenu button {
    width: 100%;
    padding: 10px 14px;
    text-align: left;
    border-bottom: 1px solid #1db954;
    border-radius: 0;
  }
  #featuresMenu button:last-child {
    border-bottom: none;
  }
  #featuresMenu button:hover {
    background: #1db954;
    color: #000;
  }
  /* Draggable EQ panel */
  #eqPanel {
    position: fixed;
    top: 150px;
    left: 50%;
    transform: translateX(-50%);
    width: 350px;
    background: #121212;
    border: 2px solid #1db954;
    border-radius: 12px;
    padding: 15px 20px;
    color: #eee;
    user-select: none;
    display: none;
    z-index: 10000;
  }
  body.light #eqPanel {
    background: #f9f9f9;
    color: #111;
    border-color: #17a44c;
  }
  #eqPanel header {
    cursor: move;
    font-weight: 700;
    font-size: 18px;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #eqPanel header button {
    font-size: 20px;
    line-height: 1;
    color: #1db954;
    font-weight: 900;
  }
  #eqSliders {
    display: flex;
    justify-content: space-between;
    gap: 12px;
  }
  .eq-slider {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 50px;
  }
  .eq-slider input[type="range"] {
    writing-mode: bt-lr; /* vertical */
    -webkit-appearance: slider-vertical;
    width: 30px;
    height: 130px;
    background: transparent;
    cursor: pointer;
  }
  .eq-slider label {
    margin-top: 10px;
    font-size: 12px;
  }
</style>
</head>
<body>
<div class="app">
  <div class="main-content">
    <aside class="sidebar">
      <h2>Library</h2>
      <button id="btnAllSongs" class="active">All Songs</button>
      <!-- Future playlists here -->
      <div class="playlist-list" id="playlistList"></div>
    </aside>
    <section class="library">
      <div class="library-header">
        <input id="searchInput" type="search" placeholder="Search songs..." />
        <button id="toggleThemeBtn">Toggle Light/Dark</button>
        <div style="position: relative;">
          <button id="featuresBtn">Features ‚ñº</button>
          <div id="featuresMenu">
            <button id="eqToggleBtn">Equalizer</button>
            <!-- Add more features here -->
          </div>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th class="name">Name</th>
            <th class="artist">Artist</th>
            <th class="album">Album</th>
            <th class="duration">Duration</th>
          </tr>
        </thead>
        <tbody id="trackTableBody"></tbody>
      </table>
    </section>
    <aside class="queue">
      <h3>Up Next</h3>
      <div class="queue-list" id="queueList"></div>
    </aside>
  </div>
  <footer class="now-playing-bar">
    <div class="now-playing-info">
      <div class="now-playing-title" id="nowPlayingTitle">Select a song to play</div>
      <div class="now-playing-artist" id="nowPlayingArtist"></div>
    </div>
    <div class="player-controls">
      <button id="btnPrev" title="Previous Track">‚èÆÔ∏è</button>
      <button id="btnPlayPause" title="Play/Pause">‚ñ∂Ô∏è</button>
      <button id="btnNext" title="Next Track">‚è≠Ô∏è</button>
    </div>
    <div class="progress-container">
      <div class="progress-bar" id="progressBar">
        <div class="progress-filled" id="progressFilled"></div>
      </div>
      <div class="time-container">
        <span id="currentTime">0:00</span>
        <span id="durationTime">0:00</span>
      </div>
    </div>
    <div class="volume-container">
      <label for="volumeSlider" style="user-select:none;">üîä</label>
      <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.7" class="volume-slider" />
    </div>
  </footer>
</div>

<!-- Draggable EQ Panel -->
<div id="eqPanel">
  <header>
    Equalizer
    <button id="eqCloseBtn" title="Close EQ">‚úñÔ∏è</button>
  </header>
  <div id="eqSliders">
    <div class="eq-slider">
      <input type="range" min="-30" max="30" step="1" value="0" data-band="60" />
      <label>60 Hz</label>
    </div>
    <div class="eq-slider">
      <input type="range" min="-30" max="30" step="1" value="0" data-band="170" />
      <label>170 Hz</label>
    </div>
    <div class="eq-slider">
      <input type="range" min="-30" max="30" step="1" value="0" data-band="350" />
      <label>350 Hz</label>
    </div>
    <div class="eq-slider">
      <input type="range" min="-30" max="30" step="1" value="0" data-band="1000" />
      <label>1 kHz</label>
    </div>
    <div class="eq-slider">
      <input type="range" min="-30" max="30" step="1" value="0" data-band="3500" />
      <label>3.5 kHz</label>
    </div>
  </div>
</div>

<script>
(async function(){
  // Replace with your actual API key and folder ID here:
  const API_KEY = 'AIzaSyDsYE91wH7UDwu8eZNbD1CFuVcilgYeZhI';
  const FOLDER_ID = '1DGz9zEQh29EAqTZpmWK5mwSj5HComnkn';

  // State
  let songs = [];
  let filteredSongs = [];
  let currentSongIndex = -1;
  let isPlaying = false;
  let audioCtx;
  let sourceNode;
  let gainNode;
  let eqNodes = [];
  let audio = new Audio();
  audio.crossOrigin = "anonymous";

  // DOM references
  const trackTableBody = document.getElementById('trackTableBody');
  const nowPlayingTitle = document.getElementById('nowPlayingTitle');
  const nowPlayingArtist = document.getElementById('nowPlayingArtist');
  const btnPlayPause = document.getElementById('btnPlayPause');
  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');
  const progressBar = document.getElementById('progressBar');
  const progressFilled = document.getElementById('progressFilled');
  const currentTimeElem = document.getElementById('currentTime');
  const durationTimeElem = document.getElementById('durationTime');
  const volumeSlider = document.getElementById('volumeSlider');
  const searchInput = document.getElementById('searchInput');
  const featuresBtn = document.getElementById('featuresBtn');
  const featuresMenu = document.getElementById('featuresMenu');
  const eqToggleBtn = document.getElementById('eqToggleBtn');
  const eqPanel = document.getElementById('eqPanel');
  const eqCloseBtn = document.getElementById('eqCloseBtn');

  // Features menu toggle
  featuresBtn.addEventListener('click', () => {
    featuresMenu.style.display = featuresMenu.style.display === 'flex' ? 'none' : 'flex';
  });
  // Close features menu if clicking outside
  document.addEventListener('click', e => {
    if (!featuresBtn.contains(e.target) && !featuresMenu.contains(e.target)) {
      featuresMenu.style.display = 'none';
    }
  });

  // Equalizer panel toggle
  eqToggleBtn.addEventListener('click', () => {
    eqPanel.style.display = eqPanel.style.display === 'block' ? 'none' : 'block';
    featuresMenu.style.display = 'none';
  });
  eqCloseBtn.addEventListener('click', () => {
    eqPanel.style.display = 'none';
  });

  // Draggable EQ panel
  (function makeDraggable(elem){
    let isDragging = false;
    let startX, startY, startLeft, startTop;
    const header = elem.querySelector('header');
    header.style.cursor = 'move';

    header.addEventListener('mousedown', e => {
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
      const rect = elem.getBoundingClientRect();
      startLeft = rect.left;
      startTop = rect.top;
      e.preventDefault();
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
    });

    document.addEventListener('mousemove', e => {
      if (!isDragging) return;
      let newLeft = startLeft + (e.clientX - startX);
      let newTop = startTop + (e.clientY - startY);
      // Keep in viewport
      const maxLeft = window.innerWidth - elem.offsetWidth;
      const maxTop = window.innerHeight - elem.offsetHeight;
      newLeft = Math.min(Math.max(newLeft, 0), maxLeft);
      newTop = Math.min(Math.max(newTop, 0), maxTop);
      elem.style.left = newLeft + 'px';
      elem.style.top = newTop + 'px';
      elem.style.transform = 'none';
    });
  })(eqPanel);

  // Initialize AudioContext and nodes
  function setupAudioContext() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    sourceNode = audioCtx.createMediaElementSource(audio);
    gainNode = audioCtx.createGain();

    // Create EQ filters for bands
    const freqs = [60, 170, 350, 1000, 3500];
    eqNodes = freqs.map(freq => {
      const filter = audioCtx.createBiquadFilter();
      filter.type = 'peaking';
      filter.frequency.value = freq;
      filter.Q.value = 1;
      filter.gain.value = 0;
      return filter;
    });

    // Connect chain: source -> eq filters -> gain -> destination
    sourceNode.connect(eqNodes[0]);
    for (let i = 0; i < eqNodes.length -1; i++) {
      eqNodes[i].connect(eqNodes[i+1]);
    }
    eqNodes[eqNodes.length-1].connect(gainNode);
    gainNode.connect(audioCtx.destination);
  }

  // Update EQ gains from sliders
  function updateEQ() {
    eqPanel.querySelectorAll('input[type=range]').forEach((input, i) => {
      eqNodes[i].gain.value = parseFloat(input.value);
    });
  }

  // Format seconds to mm:ss
  function formatTime(s) {
    const m = Math.floor(s / 60);
    const sec = Math.floor(s % 60);
    return `${m}:${sec.toString().padStart(2, '0')}`;
  }

  // Fetch songs metadata from Google Drive
  async function fetchSongsFromDrive() {
    let allFiles = [];
    let pageToken = null;
    const baseUrl = 'https://www.googleapis.com/drive/v3/files';
    const query = encodeURIComponent(`'${FOLDER_ID}' in parents and mimeType contains 'audio/'`);
    const fields = 'nextPageToken,files(id,name,mimeType)';
    
    do {
      const url = `${baseUrl}?q=${query}&fields=${fields}&pageToken=${pageToken || ''}&key=${API_KEY}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Drive API Error: ${res.status} ${res.statusText}`);
      const data = await res.json();
      allFiles = allFiles.concat(data.files);
      pageToken = data.nextPageToken || null;
    } while(pageToken);
    
    return allFiles;
  }

  // Load song audio to get duration and build song objects
  async function buildSongList(files) {
    // We will load each audio file and get duration via HTMLAudioElement metadata
    // Also parse file name to guess artist/album (basic parsing)
    const songsList = [];
    for (const file of files) {
      const url = `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media&key=${API_KEY}`;
      try {
        const duration = await getAudioDuration(url);
        const {artist, album, title} = parseMetadataFromFilename(file.name);
        songsList.push({
          id: file.id,
          url,
          name: title || file.name,
          artist: artist || 'Unknown Artist',
          album: album || 'Unknown Album',
          duration
        });
      } catch (e) {
        // Skip problematic files but log
        console.warn(`Skipping file due to error: ${file.name}`, e);
      }
    }
    return songsList;
  }

  // Parse filename to extract artist, album, title ‚Äî very basic, expects "Artist - Title.ext"
  function parseMetadataFromFilename(filename) {
    const name = filename.replace(/\.[^/.]+$/, ""); // Remove extension
    const parts = name.split(' - ');
    if(parts.length === 2) {
      return {artist: parts[0], title: parts[1], album: ''};
    } else if(parts.length === 3) {
      return {artist: parts[0], album: parts[1], title: parts[2]};
    }
    return {artist: '', album: '', title: name};
  }

  // Get audio duration using HTMLAudioElement metadata
  function getAudioDuration(url) {
    return new Promise((resolve, reject) => {
      const tempAudio = new Audio();
      tempAudio.src = url;
      tempAudio.preload = 'metadata';
      tempAudio.crossOrigin = "anonymous";
      tempAudio.addEventListener('loadedmetadata', () => {
        resolve(tempAudio.duration);
      });
      tempAudio.addEventListener('error', () => {
        reject(new Error('Failed to load audio metadata'));
      });
    });
  }

  // Render songs table
  function renderSongsTable(list) {
    trackTableBody.innerHTML = '';
    list.forEach((song, idx) => {
      const tr = document.createElement('tr');
      tr.classList.toggle('selected', idx === currentSongIndex);
      tr.dataset.index = idx;
      tr.innerHTML = `
        <td class="name" title="${song.name}">${song.name}</td>
        <td class="artist" title="${song.artist}">${song.artist}</td>
        <td class="album" title="${song.album}">${song.album}</td>
        <td class="duration">${formatTime(song.duration)}</td>
      `;
      tr.addEventListener('click', () => {
        selectSong(idx);
      });
      trackTableBody.appendChild(tr);
    });
  }

  // Select and play a song by index
  function selectSong(index) {
    if(index < 0 || index >= filteredSongs.length) return;
    currentSongIndex = index;
    const song = filteredSongs[index];
    audio.src = song.url;
    playAudio();
    updateNowPlaying(song);
    renderSongsTable(filteredSongs);
    updateQueue();
  }

  // Play audio
  async function playAudio() {
    if (!audioCtx) setupAudioContext();
    await audioCtx.resume();
    await audio.play();
    isPlaying = true;
    btnPlayPause.textContent = '‚è∏Ô∏è';
  }

  // Pause audio
  function pauseAudio() {
    audio.pause();
    isPlaying = false;
    btnPlayPause.textContent = '‚ñ∂Ô∏è';
  }

  // Update now playing info
  function updateNowPlaying(song) {
    nowPlayingTitle.textContent = song.name;
    nowPlayingArtist.textContent = `${song.artist} ‚Äî ${song.album}`;
  }

  // Update playback progress bar and time
  function updateProgress() {
    if(audio.duration) {
      const percent = (audio.currentTime / audio.duration) * 100;
      progressFilled.style.width = percent + '%';
      currentTimeElem.textContent = formatTime(audio.currentTime);
      durationTimeElem.textContent = formatTime(audio.duration);
    }
  }

  // Seek in audio
  function seekAudio(e) {
    const rect = progressBar.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const seekPercent = clickX / rect.width;
    if(audio.duration) {
      audio.currentTime = audio.duration * seekPercent;
    }
  }

  // Volume change
  function changeVolume(e) {
    audio.volume = e.target.value;
  }

  // Play next song
  function playNext() {
    if(currentSongIndex + 1 < filteredSongs.length) {
      selectSong(currentSongIndex + 1);
    }
  }

  // Play previous song
  function playPrev() {
    if(currentSongIndex > 0) {
      selectSong(currentSongIndex - 1);
    }
  }

  // Search songs filtering
  function filterSongs(query) {
    const q = query.trim().toLowerCase();
    if(!q) return songs;
    return songs.filter(s => s.name.toLowerCase().includes(q) || s.artist.toLowerCase().includes(q) || s.album.toLowerCase().includes(q));
  }

  // Update queue list (next 5 songs)
  function updateQueue() {
    const queueList = document.getElementById('queueList');
    queueList.innerHTML = '';
    for(let i = currentSongIndex+1; i < Math.min(filteredSongs.length, currentSongIndex+6); i++) {
      const song = filteredSongs[i];
      const div = document.createElement('div');
      div.className = 'queue-item';
      div.innerHTML = `<span title="${song.name}">${song.name}</span><button title="Play this song">‚ñ∂Ô∏è</button>`;
      div.querySelector('button').addEventListener('click', () => selectSong(i));
      queueList.appendChild(div);
    }
  }

  // EQ sliders event
  eqPanel.querySelectorAll('input[type=range]').forEach(slider => {
    slider.addEventListener('input', updateEQ);
  });

  // Audio event listeners
  audio.addEventListener('timeupdate', updateProgress);
  audio.addEventListener('ended', playNext);

  // Play/Pause button
  btnPlayPause.addEventListener('click', () => {
    if(isPlaying) pauseAudio();
    else playAudio();
  });

  // Next/Prev buttons
  btnNext.addEventListener('click', playNext);
  btnPrev.addEventListener('click', playPrev);

  // Progress bar seeking
  progressBar.addEventListener('click', seekAudio);

  // Volume slider
  volumeSlider.addEventListener('input', changeVolume);

  // Search input
  searchInput.addEventListener('input', e => {
    filteredSongs = filterSongs(e.target.value);
    currentSongIndex = -1;
    renderSongsTable(filteredSongs);
    nowPlayingTitle.textContent = 'Select a song to play';
    nowPlayingArtist.textContent = '';
    updateQueue();
  });

  // Dark/light mode toggle
  const toggleThemeBtn = document.getElementById('toggleThemeBtn');
  toggleThemeBtn.addEventListener('click', () => {
    document.body.classList.toggle('light');
  });

  // Initialize app
  async function init() {
    try {
      const files = await fetchSongsFromDrive();
      songs = await buildSongList(files);
      songs.sort((a,b) => a.name.localeCompare(b.name));
      filteredSongs = songs;
      renderSongsTable(filteredSongs);
      updateQueue();
      console.log(`Loaded ${songs.length} songs.`);
    } catch(err) {
      alert('Failed to load songs: ' + err.message);
      console.error(err);
    }
  }

  init();

})();
</script>
</body>
</html>
