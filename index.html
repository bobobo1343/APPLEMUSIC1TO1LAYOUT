<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>iTunes Laptop Replica Player</title>
<style>
  /* Reset */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    background: #f2f2f5;
    color: #1c1c1e;
    user-select: none;
    overflow: hidden;
    transition: background 0.3s ease, color 0.3s ease;
  }
  body.dark {
    background: #121212;
    color: #eee;
  }
  a {
    color: inherit;
    text-decoration: none;
  }
  button {
    cursor: pointer;
    background: none;
    border: none;
    font-weight: 600;
    font-size: 14px;
    color: #007aff;
    transition: color 0.2s ease;
  }
  button:hover {
    color: #0051a8;
  }
  body.dark button {
    color: #0a84ff;
  }
  body.dark button:hover {
    color: #66a9ff;
  }

  /* Layout */
  #app {
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }
  /* Header */
  header {
    height: 44px;
    background: #f9f9f9;
    border-bottom: 1px solid #c7c7cc;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 700;
    font-size: 17px;
    color: #1c1c1e;
    user-select: none;
    padding: 0 12px;
    transition: background 0.3s ease, color 0.3s ease;
  }
  body.dark header {
    background: #1c1c1e;
    color: #eee;
    border-bottom-color: #333;
  }
  /* Dark Mode Toggle Button */
  #darkModeToggle {
    font-weight: 600;
    font-size: 14px;
    border: 1px solid #007aff;
    border-radius: 14px;
    padding: 6px 14px;
    background: none;
    user-select: none;
    cursor: pointer;
    transition: background 0.3s ease, color 0.3s ease;
  }
  #darkModeToggle:hover {
    background: #007aff;
    color: white;
  }
  body.dark #darkModeToggle {
    border-color: #0a84ff;
    color: #0a84ff;
  }
  body.dark #darkModeToggle:hover {
    background: #0a84ff;
    color: #121212;
  }

  /* Main Content */
  #main {
    flex: 1;
    display: flex;
    background: white;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
    transition: background 0.3s ease;
  }
  body.dark #main {
    background: #181818;
  }
  /* Sidebar */
  #sidebar {
    width: 240px;
    border-right: 1px solid #c7c7cc;
    background: #f9f9f9;
    padding: 20px 12px;
    display: flex;
    flex-direction: column;
    transition: background 0.3s ease, border-color 0.3s ease;
  }
  body.dark #sidebar {
    background: #1c1c1e;
    border-color: #333;
  }
  #sidebar h2 {
    font-weight: 700;
    font-size: 22px;
    color: #1c1c1e;
    margin: 0 0 24px;
    user-select: none;
    transition: color 0.3s ease;
  }
  body.dark #sidebar h2 {
    color: #eee;
  }
  #sidebar button, #sidebar .playlist-btn {
    text-align: left;
    padding: 10px 14px;
    margin-bottom: 6px;
    border-radius: 6px;
    border: none;
    background: none;
    color: #007aff;
    font-weight: 600;
    font-size: 15px;
    transition: background 0.3s ease, color 0.3s ease;
  }
  #sidebar button.active, #sidebar .playlist-btn.active, #sidebar button:hover, #sidebar .playlist-btn:hover {
    background: #007aff;
    color: white;
  }
  body.dark #sidebar button, body.dark #sidebar .playlist-btn {
    color: #0a84ff;
  }
  body.dark #sidebar button.active, body.dark #sidebar .playlist-btn.active,
  body.dark #sidebar button:hover, body.dark #sidebar .playlist-btn:hover {
    background: #0a84ff;
    color: #121212;
  }
  #playlist-controls {
    margin-top: auto;
  }
  #newPlaylistInput {
    width: calc(100% - 42px);
    padding: 8px 10px;
    border: 1px solid #c7c7cc;
    border-radius: 6px;
    font-size: 14px;
    margin-bottom: 6px;
    outline-offset: -2px;
    transition: border-color 0.3s ease, background 0.3s ease, color 0.3s ease;
  }
  body.dark #newPlaylistInput {
    background: #333;
    color: #eee;
    border-color: #444;
  }
  #addPlaylistBtn {
    width: 36px;
    height: 36px;
    font-size: 24px;
    line-height: 0;
    color: #007aff;
    border-radius: 6px;
    border: 1px solid #c7c7cc;
    background: none;
    margin-left: 6px;
    vertical-align: top;
    transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
  }
  #addPlaylistBtn:hover {
    background: #007aff;
    color: white;
    border-color: #007aff;
  }
  body.dark #addPlaylistBtn {
    color: #0a84ff;
    border-color: #444;
  }
  body.dark #addPlaylistBtn:hover {
    background: #0a84ff;
    color: #121212;
    border-color: #0a84ff;
  }
  #playlist-create {
    display: flex;
    align-items: center;
  }
  /* Library */
  #library {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: white;
    transition: background 0.3s ease;
  }
  body.dark #library {
    background: #121212;
  }
  #library-header {
    border-bottom: 1px solid #c7c7cc;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    position: relative;
  }
  body.dark #library-header {
    border-color: #333;
  }
  #searchInput {
    flex-grow: 1;
    border: 1px solid #c7c7cc;
    border-radius: 12px;
    padding: 6px 12px;
    font-size: 14px;
    color: #1c1c1e;
    outline-offset: -2px;
    transition: border-color 0.3s ease, background 0.3s ease, color 0.3s ease;
  }
  body.dark #searchInput {
    background: #333;
    color: #eee;
    border-color: #444;
  }
  #featuresDropdownBtn {
    margin-left: 20px;
    position: relative;
    font-weight: 700;
    border-radius: 14px;
    padding: 6px 14px;
    border: 1px solid #c7c7cc;
    background: white;
    user-select: none;
    transition: background 0.3s ease, border-color 0.3s ease, color 0.3s ease;
  }
  #featuresDropdownBtn:hover {
    background: #e0e0e0;
  }
  body.dark #featuresDropdownBtn {
    background: #1c1c1e;
    border-color: #333;
    color: #eee;
  }
  body.dark #featuresDropdownBtn:hover {
    background: #333;
  }
  /* Dropdown container */
  #featuresDropdown {
    position: absolute;
    top: 48px;
    right: 0;
    width: 280px;
    background: white;
    border: 1px solid #c7c7cc;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    display: none;
    padding: 16px;
    z-index: 100;
    user-select: auto;
  }
  #featuresDropdown.open {
    display: block;
  }
  body.dark #featuresDropdown {
    background: #1c1c1e;
    border-color: #333;
    box-shadow: 0 4px 16px rgba(255,255,255,0.1);
    color: #eee;
  }
  /* Song Table */
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    color: inherit;
    user-select: none;
  }
  thead tr {
    border-bottom: 1px solid #c7c7cc;
  }
  body.dark thead tr {
    border-color: #333;
  }
  th, td {
    padding: 12px 20px;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  th.name, td.name {
    width: 40%;
  }
  th.artist, td.artist {
    width: 25%;
  }
  th.album, td.album {
    width: 25%;
  }
  th.duration, td.duration {
    width: 10%;
    text-align: right;
    font-variant-numeric: tabular-nums;
  }
  tbody tr {
    cursor: pointer;
    transition: background 0.2s ease;
  }
  tbody tr:hover {
    background: #d0e7ff;
  }
  body.dark tbody tr:hover {
    background: #0a4fff;
  }
  tbody tr.selected {
    background: #007aff;
    color: white;
  }
  /* Scrollable tbody */
  tbody {
    display: block;
    height: calc(100vh - 44px - 44px - 72px - 20px); /* viewport minus header, library-header, playback bar, padding */
    overflow-y: auto;
  }
  thead, tbody tr {
    display: table;
    width: 100%;
    table-layout: fixed;
  }
  /* Queue / Up Next Sidebar */
  #queue {
    width: 300px;
    border-left: 1px solid #c7c7cc;
    background: #f9f9f9;
    padding: 20px 12px;
    display: flex;
    flex-direction: column;
    transition: background 0.3s ease, border-color 0.3s ease;
  }
  body.dark #queue {
    background: #1c1c1e;
    border-color: #333;
  }
  #queue h3 {
    font-weight: 700;
    font-size: 18px;
    margin: 0 0 20px;
    user-select: none;
    color: inherit;
  }
  #queueList {
    flex-grow: 1;
    overflow-y: auto;
  }
  .queue-item {
    padding: 10px 14px;
    margin-bottom: 6px;
    border-radius: 6px;
    cursor: pointer;
    color: #007aff;
    transition: background 0.2s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .queue-item:hover {
    background: #d0e7ff;
  }
  body.dark .queue-item:hover {
    background: #0a4fff;
  }
  .queue-item.selected {
    background: #007aff;
    color: white;
    font-weight: 700;
  }
  /* Playback Bar */
  #playbackBar {
    height: 72px;
    background: #f9f9f9;
    border-top: 1px solid #c7c7cc;
    display: flex;
    align-items: center;
    padding: 0 24px;
    gap: 18px;
    user-select: none;
    position: relative;
    transition: background 0.3s ease, border-color 0.3s ease;
  }
  body.dark #playbackBar {
    background: #1c1c1e;
    border-color: #333;
  }
  #playbackInfo {
    flex-shrink: 0;
    width: 300px;
    overflow: hidden;
  }
  #playbackTitle {
    font-weight: 700;
    font-size: 16px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #playbackArtist {
    font-size: 13px;
    color: #6e6e73;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: color 0.3s ease;
  }
  body.dark #playbackArtist {
    color: #aaa;
  }
  #playbackControls {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 0;
  }
  #playbackControls button {
    font-size: 24px;
    color: #007aff;
    background: none;
    border: none;
    cursor: pointer;
    transition: color 0.2s ease;
    user-select: none;
  }
  #playbackControls button:hover {
    color: #004e8a;
  }
  body.dark #playbackControls button {
    color: #0a84ff;
  }
  body.dark #playbackControls button:hover {
    color: #66a9ff;
  }
  #progressContainer {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    user-select: none;
  }
  #progressBar {
    width: 100%;
    height: 6px;
    background: #d0d0d6;
    border-radius: 3px;
    cursor: pointer;
    position: relative;
  }
  #progressFilled {
    height: 100%;
    background: #007aff;
    width: 0%;
    border-radius: 3px;
    transition: width 0.1s linear;
  }
  body.dark #progressBar {
    background: #333;
  }
  body.dark #progressFilled {
    background: #0a84ff;
  }
  #timeDisplay {
    margin-top: 4px;
    font-size: 12px;
    color: #6e6e73;
    display: flex;
    justify-content: space-between;
    user-select: none;
    transition: color 0.3s ease;
  }
  body.dark #timeDisplay {
    color: #aaa;
  }
  #volumeControl {
    width: 120px;
  }
  #volumeSlider {
    width: 100%;
    cursor: pointer;
  }
  /* Mini Player */
  #miniPlayerToggle {
    margin-left: 24px;
    color: #007aff;
    border: 1px solid #007aff;
    border-radius: 14px;
    padding: 6px 14px;
    font-weight: 700;
    background: none;
    user-select: none;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  #miniPlayerToggle:hover {
    background: #007aff;
    color: white;
  }
  body.dark #miniPlayerToggle {
    border-color: #0a84ff;
    color: #0a84ff;
  }
  body.dark #miniPlayerToggle:hover {
    background: #0a84ff;
    color: #121212;
  }
  /* Mini Player Style */
  #miniPlayer {
    position: fixed;
    bottom: 80px;
    right: 24px;
    width: 320px;
    height: 60px;
    background: white;
    border: 1px solid #c7c7cc;
    border-radius: 14px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    display: none;
    align-items: center;
    padding: 0 20px;
    gap: 16px;
    user-select: none;
    z-index: 200;
    transition: background 0.3s ease, border-color 0.3s ease;
  }
  body.dark #miniPlayer {
    background: #1c1c1e;
    border-color: #333;
  }
  #miniPlayer.show {
    display: flex;
  }
  #miniTitle {
    font-weight: 700;
    font-size: 14px;
    color: #1c1c1e;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex-grow: 1;
    transition: color 0.3s ease;
  }
  body.dark #miniTitle {
    color: #eee;
  }
  #miniArtist {
    font-size: 12px;
    color: #6e6e73;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: color 0.3s ease;
  }
  body.dark #miniArtist {
    color: #aaa;
  }
  #miniControls button {
    font-size: 20px;
    color: #007aff;
    background: none;
    border: none;
    cursor: pointer;
    transition: color 0.3s ease;
  }
  #miniControls button:hover {
    color: #004e8a;
  }
  body.dark #miniControls button {
    color: #0a84ff;
  }
  body.dark #miniControls button:hover {
    color: #66a9ff;
  }

  /* EQ Panel */
  #eqPanel {
    position: fixed;
    top: 100px;
    left: 100px;
    width: 350px;
    background: white;
    border-radius: 14px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.25);
    padding: 16px 24px 24px;
    z-index: 300;
    user-select: none;
    transition: background 0.3s ease;
    cursor: grab;
  }
  body.dark #eqPanel {
    background: #1c1c1e;
    box-shadow: 0 6px 20px rgba(255,255,255,0.15);
  }
  #eqPanel header {
    font-weight: 700;
    font-size: 18px;
    margin-bottom: 16px;
    cursor: grab;
    user-select: none;
    color: #1c1c1e;
    transition: color 0.3s ease;
  }
  body.dark #eqPanel header {
    color: #eee;
  }
  .eq-row {
    display: flex;
    align-items: center;
    margin-bottom: 14px;
  }
  .eq-label {
    width: 60px;
    font-size: 12px;
    color: #444;
    transition: color 0.3s ease;
  }
  body.dark .eq-label {
    color: #aaa;
  }
  .eq-slider {
    -webkit-appearance: none;
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: #d0d0d6;
    cursor: pointer;
    outline: none;
    margin-left: 12px;
    transition: background 0.3s ease;
  }
  .eq-slider:hover {
    background: #a0a0b0;
  }
  .eq-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    background: #007aff;
    border-radius: 50%;
    cursor: pointer;
    border: none;
    margin-top: -5px;
    transition: background 0.3s ease;
  }
  .eq-slider::-webkit-slider-thumb:hover {
    background: #005bb5;
  }
  body.dark .eq-slider {
    background: #333;
  }
  body.dark .eq-slider:hover {
    background: #555;
  }
  body.dark .eq-slider::-webkit-slider-thumb {
    background: #0a84ff;
  }
  body.dark .eq-slider::-webkit-slider-thumb:hover {
    background: #0665cc;
  }
</style>
</head>
<body>

<div id="app">
  <header>
    <div>iTunes Replica Player</div>
    <button id="darkModeToggle">Dark Mode</button>
  </header>

  <div id="main">
    <aside id="sidebar">
      <h2>Playlists</h2>
      <button id="allSongsBtn" class="active">All Songs</button>
      <div id="playlistsContainer"></div>
      <div id="playlist-controls">
        <div id="playlist-create">
          <input type="text" id="newPlaylistInput" placeholder="New playlist name" />
          <button id="addPlaylistBtn" title="Add Playlist">＋</button>
        </div>
      </div>
    </aside>

    <section id="library">
      <div id="library-header">
        <input type="search" id="searchInput" placeholder="Search songs..." autocomplete="off" />
        <button id="featuresDropdownBtn" title="Features">FEATURES ▼</button>
      </div>
      <table>
        <thead>
          <tr>
            <th class="name">Name</th>
            <th class="artist">Artist</th>
            <th class="album">Album</th>
            <th class="duration">Time</th>
          </tr>
        </thead>
        <tbody id="songListEl"></tbody>
      </table>
    </section>

    <aside id="queue">
      <h3>Up Next</h3>
      <div id="queueList"></div>
    </aside>
  </div>

  <div id="playbackBar">
    <div id="playbackInfo">
      <div id="playbackTitle">No song selected</div>
      <div id="playbackArtist"></div>
    </div>
    <div id="playbackControls">
      <button id="prevBtn" title="Previous">⏮️</button>
      <button id="playPauseBtn" title="Play/Pause">▶️</button>
      <button id="nextBtn" title="Next">⏭️</button>
    </div>
    <div id="progressContainer">
      <div id="progressBar" title="Seek">
        <div id="progressFilled"></div>
      </div>
      <div id="timeDisplay">
        <span id="currentTimeEl">0:00</span>
        <span id="durationEl">0:00</span>
      </div>
    </div>
    <div id="volumeControl">
      <input type="range" id="volumeSlider" min="0" max="1" step="0.01" title="Volume" />
    </div>
    <button id="miniPlayerToggle" title="Toggle Mini Player">Mini Player</button>
  </div>

  <div id="miniPlayer" class="">
    <div>
      <div id="miniTitle">No song selected</div>
      <div id="miniArtist"></div>
    </div>
    <div id="miniControls">
      <button id="miniPrev" title="Previous">⏮️</button>
      <button id="miniPlayPause" title="Play/Pause">▶️</button>
      <button id="miniNext" title="Next">⏭️</button>
    </div>
  </div>

  <div id="featuresDropdown">
    <div id="eqPanel">
      <header>Equalizer (Drag me!)</header>
      <div id="eqControls"></div>
    </div>
  </div>
</div>

<script>
  // API keys and folder ID - Replace these with your own
  const API_KEY = 'AIzaSyDsYE91wH7UDwu8eZNbD1CFuVcilgYeZhI';
  const FOLDER_ID = '1DGz9zEQh29EAqTZpmWK5mwSj5HComnkn';

  // DOM elements
  const allSongsBtn = document.getElementById('allSongsBtn');
  const playlistsContainer = document.getElementById('playlistsContainer');
  const addPlaylistBtn = document.getElementById('addPlaylistBtn');
  const newPlaylistInput = document.getElementById('newPlaylistInput');
  const songListEl = document.getElementById('songListEl');
  const queueList = document.getElementById('queueList');
  const playbackTitle = document.getElementById('playbackTitle');
  const playbackArtist = document.getElementById('playbackArtist');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const audio = new Audio();
  const progressBar = document.getElementById('progressBar');
  const progressFilled = document.getElementById('progressFilled');
  const currentTimeEl = document.getElementById('currentTimeEl');
  const durationEl = document.getElementById('durationEl');
  const volumeSlider = document.getElementById('volumeSlider');
  const searchInput = document.getElementById('searchInput');
  const featuresDropdownBtn = document.getElementById('featuresDropdownBtn');
  const featuresDropdown = document.getElementById('featuresDropdown');
  const miniPlayerToggle = document.getElementById('miniPlayerToggle');
  const miniPlayer = document.getElementById('miniPlayer');
  const miniTitle = document.getElementById('miniTitle');
  const miniArtist = document.getElementById('miniArtist');
  const miniPlayPause = document.getElementById('miniPlayPause');
  const miniPrev = document.getElementById('miniPrev');
  const miniNext = document.getElementById('miniNext');
  const eqPanel = document.getElementById('eqPanel');
  const eqControls = document.getElementById('eqControls');

  // State
  let allSongs = [];
  let filteredSongs = [];
  let playlists = {}; // playlistName -> array of song objects
  let currentPlaylist = null; // null = all songs
  let currentSongIndex = -1;
  let isPlaying = false;
  let darkMode = false;

  // Audio context & EQ setup
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  const audioContext = new AudioContext();
  const sourceNode = audioContext.createMediaElementSource(audio);

  const eqBands = [
    { freq: 32, type: "lowshelf" },
    { freq: 64, type: "peaking" },
    { freq: 125, type: "peaking" },
    { freq: 250, type: "peaking" },
    { freq: 500, type: "peaking" },
    { freq: 1000, type: "peaking" },
    { freq: 2000, type: "peaking" },
    { freq: 4000, type: "peaking" },
    { freq: 8000, type: "peaking" },
    { freq: 16000, type: "highshelf" }
  ];

  const eqNodes = eqBands.map(band => {
    const filter = audioContext.createBiquadFilter();
    filter.type = band.type;
    filter.frequency.value = band.freq;
    filter.gain.value = 0;
    return filter;
  });

  // Connect EQ nodes chain
  sourceNode.connect(eqNodes[0]);
  for (let i = 0; i < eqNodes.length - 1; i++) {
    eqNodes[i].connect(eqNodes[i + 1]);
  }
  eqNodes[eqNodes.length - 1].connect(audioContext.destination);

  // Build EQ UI
  function createEQUI() {
    eqControls.innerHTML = '';
    eqNodes.forEach((node, i) => {
      const band = eqBands[i];
      const row = document.createElement('div');
      row.className = 'eq-row';

      const label = document.createElement('label');
      label.className = 'eq-label';
      label.textContent = band.freq + ' Hz';
      label.htmlFor = 'eqSlider' + i;

      const input = document.createElement('input');
      input.type = 'range';
      input.min = -12;
      input.max = 12;
      input.value = 0;
      input.step = 0.1;
      input.className = 'eq-slider';
      input.id = 'eqSlider' + i;
      input.title = `Adjust ${band.freq} Hz`;
      input.oninput = () => {
        node.gain.value = input.value;
      };

      row.appendChild(label);
      row.appendChild(input);
      eqControls.appendChild(row);
    });
  }
  createEQUI();

  // Format seconds as mm:ss
  function formatDuration(seconds) {
    if (isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return mins + ':' + (secs < 10 ? '0' : '') + secs;
  }

  // Render songs in table
  function renderSongs() {
    songListEl.innerHTML = '';
    filteredSongs.forEach((song, idx) => {
      const tr = document.createElement('tr');
      tr.classList.toggle('selected', idx === currentSongIndex);
      tr.draggable = true;
      tr.dataset.index = idx;
      tr.onclick = () => {
        playSong(idx);
      };
      // Drag & drop handlers for playlist reorder
      tr.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', idx);
        e.currentTarget.style.opacity = '0.5';
      });
      tr.addEventListener('dragend', e => {
        e.currentTarget.style.opacity = '';
      });
      tr.addEventListener('dragover', e => {
        e.preventDefault();
        e.currentTarget.style.borderTop = '2px solid #007aff';
      });
      tr.addEventListener('dragleave', e => {
        e.currentTarget.style.borderTop = '';
      });
      tr.addEventListener('drop', e => {
        e.preventDefault();
        const draggedIndex = +e.dataTransfer.getData('text/plain');
        const targetIndex = +e.currentTarget.dataset.index;
        if (draggedIndex === targetIndex) return;
        // Reorder filteredSongs array
        const movedSong = filteredSongs.splice(draggedIndex, 1)[0];
        filteredSongs.splice(targetIndex, 0, movedSong);
        renderSongs();
      });

      tr.innerHTML = `
        <td class="name" title="${song.name}">${song.name}</td>
        <td class="artist" title="${song.artist || ''}">${song.artist || ''}</td>
        <td class="album" title="${song.album || ''}">${song.album || ''}</td>
        <td class="duration">${formatDuration(song.duration)}</td>
      `;
      songListEl.appendChild(tr);
    });
  }

  // Play song by index in filteredSongs
  async function playSong(index) {
    if (index < 0 || index >= filteredSongs.length) return;
    currentSongIndex = index;
    const song = filteredSongs[index];
    audio.src = song.url;
    try {
      if(audioContext.state === 'suspended') await audioContext.resume();
      await audio.play();
      isPlaying = true;
      updateButtons();
      updatePlaybackInfo();
      renderSongs();
      renderQueue();
      updateMiniPlayer();
    } catch(err) {
      alert('Playback error: ' + err.message);
    }
  }

  // Update playback info UI
  function updatePlaybackInfo() {
    if (currentSongIndex === -1) {
      playbackTitle.textContent = "No song selected";
      playbackArtist.textContent = "";
      miniTitle.textContent = playbackTitle.textContent;
      miniArtist.textContent = playbackArtist.textContent;
      return;
    }
    const song = filteredSongs[currentSongIndex];
    playbackTitle.textContent = song.name;
    playbackArtist.textContent = song.artist || '';
    miniTitle.textContent = playbackTitle.textContent;
    miniArtist.textContent = playbackArtist.textContent;
  }

  // Render Up Next queue (same order as filteredSongs)
  function renderQueue() {
    queueList.innerHTML = '';
    filteredSongs.forEach((song, idx) => {
      const div = document.createElement('div');
      div.className = 'queue-item' + (idx === currentSongIndex ? ' selected' : '');
      div.textContent = song.name;
      div.title = `${song.artist || ''} - ${song.album || ''}`;
      div.onclick = () => {
        playSong(idx);
      };
      queueList.appendChild(div);
    });
  }

  // Playback controls
  playPauseBtn.onclick = async () => {
    if (audio.paused) {
      try {
        if(audioContext.state === 'suspended') await audioContext.resume();
        await audio.play();
        isPlaying = true;
      } catch(err) {
        alert('Playback error: ' + err.message);
        return;
      }
    } else {
      audio.pause();
      isPlaying = false;
    }
    updateButtons();
  };
  prevBtn.onclick = () => {
    if (currentSongIndex > 0) playSong(currentSongIndex - 1);
  };
  nextBtn.onclick = () => {
    if (currentSongIndex + 1 < filteredSongs.length) playSong(currentSongIndex + 1);
  };

  // Mini player controls
  miniPlayPause.onclick = playPauseBtn.onclick;
  miniPrev.onclick = prevBtn.onclick;
  miniNext.onclick = nextBtn.onclick;

  // Update play/pause button icons
  function updateButtons() {
    if (isPlaying) {
      playPauseBtn.textContent = '⏸️';
      miniPlayPause.textContent = '⏸️';
    } else {
      playPauseBtn.textContent = '▶️';
      miniPlayPause.textContent = '▶️';
    }
  }

  // Audio time updates
  audio.ontimeupdate = () => {
    if (!audio.duration) return;
    const percent = (audio.currentTime / audio.duration) * 100;
    progressFilled.style.width = percent + '%';
    currentTimeEl.textContent = formatDuration(audio.currentTime);
    durationEl.textContent = formatDuration(audio.duration);
  };

  // Seek audio on progress bar click
  progressBar.onclick = e => {
    const rect = progressBar.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const width = rect.width;
    const seekTime = (clickX / width) * audio.duration;
    audio.currentTime = seekTime;
  };

  // Volume control
  volumeSlider.oninput = () => {
    audio.volume = volumeSlider.value;
  };
  volumeSlider.value = 0.5;
  audio.volume = 0.5;

  // Search songs
  searchInput.oninput = () => {
    const term = searchInput.value.toLowerCase();
    const baseList = currentPlaylist ? playlists[currentPlaylist] : allSongs;
    filteredSongs = baseList.filter(s =>
      s.name.toLowerCase().includes(term) ||
      (s.artist && s.artist.toLowerCase().includes(term)) ||
      (s.album && s.album.toLowerCase().includes(term))
    );
    currentSongIndex = -1;
    renderSongs();
    renderQueue();
    updatePlaybackInfo();
  };

  // Playlist buttons render
  function renderPlaylists() {
    playlistsContainer.innerHTML = '';
    for (const name in playlists) {
      const btn = document.createElement('button');
      btn.textContent = name;
      btn.className = 'playlist-btn';
      if (name === currentPlaylist) btn.classList.add('active');
      btn.onclick = () => {
        currentPlaylist = name;
        filteredSongs = playlists[name].slice();
        currentSongIndex = -1;
        searchInput.value = '';
        renderSongs();
        renderQueue();
        updatePlaybackInfo();
        renderPlaylists();
        allSongsBtn.classList.remove('active');
      };
      playlistsContainer.appendChild(btn);
    }
  }

  // All songs button
  allSongsBtn.onclick = () => {
    currentPlaylist = null;
    filteredSongs = allSongs.slice();
    currentSongIndex = -1;
    searchInput.value = '';
    renderSongs();
    renderQueue();
    updatePlaybackInfo();
    renderPlaylists();
    allSongsBtn.classList.add('active');
  };

  // Add new playlist
  addPlaylistBtn.onclick = () => {
    const name = newPlaylistInput.value.trim();
    if (!name) return alert('Please enter a playlist name');
    if (playlists[name]) return alert('Playlist already exists');
    playlists[name] = [];
    currentPlaylist = name;
    filteredSongs = [];
    currentSongIndex = -1;
    newPlaylistInput.value = '';
    renderPlaylists();
    renderSongs();
    renderQueue();
    updatePlaybackInfo();
    allSongsBtn.classList.remove('active');
  };

  // Drag & Drop for playlists (not implemented reorder here)
  // TODO: You can add playlist reorder if desired

  // FEATURES Dropdown toggle
  featuresDropdownBtn.onclick = () => {
    featuresDropdown.classList.toggle('open');
  };
  document.body.addEventListener('click', e => {
    if (!featuresDropdown.contains(e.target) && e.target !== featuresDropdownBtn) {
      featuresDropdown.classList.remove('open');
    }
  });

  // Mini player toggle
  miniPlayerToggle.onclick = () => {
    miniPlayer.classList.toggle('show');
  };

  // Dark mode toggle
  const darkModeToggle = document.getElementById('darkModeToggle');
  darkModeToggle.onclick = () => {
    darkMode = !darkMode;
    if (darkMode) {
      document.body.classList.add('dark');
      darkModeToggle.textContent = 'Light Mode';
    } else {
      document.body.classList.remove('dark');
      darkModeToggle.textContent = 'Dark Mode';
    }
  };

  // EQ drag functionality
  (() => {
    let isDragging = false;
    let offsetX, offsetY;

    eqPanel.querySelector('header').style.cursor = 'grab';

    eqPanel.querySelector('header').addEventListener('mousedown', e => {
      isDragging = true;
      offsetX = e.clientX - eqPanel.offsetLeft;
      offsetY = e.clientY - eqPanel.offsetTop;
      eqPanel.style.cursor = 'grabbing';
      e.preventDefault();
    });

    window.addEventListener('mouseup', () => {
      isDragging = false;
      eqPanel.style.cursor = 'grab';
    });

    window.addEventListener('mousemove', e => {
      if (!isDragging) return;
      let left = e.clientX - offsetX;
      let top = e.clientY - offsetY;
      // Constrain inside viewport
      left = Math.max(0, Math.min(left, window.innerWidth - eqPanel.offsetWidth));
      top = Math.max(44, Math.min(top, window.innerHeight - eqPanel.offsetHeight));
      eqPanel.style.left = left + 'px';
      eqPanel.style.top = top + 'px';
    });
  })();

  // Fetch songs from Google Drive folder using API key and folder ID
  async function loadSongsFromDrive() {
    try {
      const filesRes = await fetch(`https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents+and+mimeType+contains+'audio/'&key=${API_KEY}&fields=files(id,name,mimeType,size)`);
      if (!filesRes.ok) throw new Error('Failed to fetch file list');
      const filesJson = await filesRes.json();
      if (!filesJson.files || !filesJson.files.length) {
        alert('No audio files found in your folder.');
        return;
      }
      // Build allSongs array
      allSongs = filesJson.files.map(f => {
        // Extract metadata from filename if possible
        // Assuming filename format: "Artist - Title.mp3"
        let artist = '';
        let name = f.name.replace(/\.[^/.]+$/, ""); // remove extension
        let album = '';
        if (name.includes(' - ')) {
          const parts = name.split(' - ');
          if (parts.length >= 2) {
            artist = parts[0];
            name = parts.slice(1).join(' - ');
          }
        }
        return {
          id: f.id,
          name,
          artist,
          album,
          duration: 0, // We'll load durations later if needed
          url: `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media&key=${API_KEY}`
        };
      });
      filteredSongs = allSongs.slice();
      renderSongs();
      renderQueue();
      updatePlaybackInfo();
    } catch (error) {
      alert('Error loading songs from Drive: ' + error.message);
    }
  }

  // Initialize
  (async () => {
    await loadSongsFromDrive();
    allSongsBtn.classList.add('active');
  })();

  // When song ends play next
  audio.onended = () => {
    if (currentSongIndex + 1 < filteredSongs.length) {
      playSong(currentSongIndex + 1);
    } else {
      isPlaying = false;
      updateButtons();
    }
  };
</script>

</body>
</html>
