<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>iTunes Desktop Replica - No Artwork</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Reset */
    * {
      box-sizing: border-box;
    }
    body, html {
      margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      user-select: none;
      background: #121212;
      color: #eee;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }
    body.light {
      background: #f9f9f9;
      color: #111;
    }
    a {
      color: inherit;
      text-decoration: none;
    }
    button {
      cursor: pointer;
      background: none;
      border: none;
      color: inherit;
      font-size: 14px;
      font-weight: 600;
      transition: color 0.2s;
    }
    button:hover {
      color: #1db954;
    }
    /* Layout containers */
    .app {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100vw;
      overflow: hidden;
    }
    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    /* Sidebar */
    .sidebar {
      width: 250px;
      background: #000;
      border-right: 1px solid #333;
      display: flex;
      flex-direction: column;
      padding: 20px 10px;
      transition: background 0.3s, color 0.3s;
    }
    body.light .sidebar {
      background: #f0f0f0;
      color: #111;
      border-color: #ccc;
    }
    .sidebar h2 {
      margin: 0 0 20px 0;
      font-size: 22px;
      font-weight: 900;
      color: #1db954;
      text-align: center;
      letter-spacing: 1.5px;
    }
    .sidebar button {
      display: block;
      width: 100%;
      padding: 10px 15px;
      text-align: left;
      border-radius: 4px;
      margin-bottom: 5px;
    }
    .sidebar button.active,
    .sidebar button:hover {
      background: #1db954;
      color: #000;
      font-weight: 700;
    }
    /* Playlist list */
    .playlist-list {
      margin-top: 20px;
      flex-grow: 1;
      overflow-y: auto;
    }
    .playlist-list button {
      padding-left: 25px;
      font-weight: 500;
      font-size: 14px;
    }
    /* Middle content (Library & song list) */
    .library {
      flex: 2;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #333;
      transition: background 0.3s, color 0.3s;
    }
    body.light .library {
      border-color: #ccc;
    }
    .library-header {
      padding: 15px 20px;
      background: #181818;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #333;
      transition: background 0.3s, border-color 0.3s;
    }
    body.light .library-header {
      background: #fff;
      border-color: #ccc;
    }
    .library-header input[type="search"] {
      padding: 7px 15px;
      border-radius: 14px;
      border: none;
      width: 100%;
      max-width: 300px;
      font-size: 14px;
      background: #282828;
      color: #eee;
      outline: none;
      transition: background 0.3s, color 0.3s;
    }
    body.light .library-header input[type="search"] {
      background: #eee;
      color: #111;
    }
    .library-header button {
      background: #1db954;
      color: #000;
      font-weight: 700;
      padding: 8px 15px;
      border-radius: 18px;
      font-size: 14px;
      transition: background 0.3s;
    }
    .library-header button:hover {
      background: #17a44c;
    }
    /* Song Table */
    table {
      width: 100%;
      border-collapse: collapse;
      user-select: none;
      table-layout: fixed;
    }
    thead {
      background: #282828;
      color: #bbb;
      font-size: 12px;
      font-weight: 700;
    }
    body.light thead {
      background: #ddd;
      color: #555;
    }
    th, td {
      padding: 10px 12px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      vertical-align: middle;
      cursor: default;
    }
    th {
      text-align: left;
      user-select: text;
    }
    tbody tr {
      border-bottom: 1px solid #282828;
      transition: background 0.2s;
    }
    body.light tbody tr {
      border-color: #ccc;
    }
    tbody tr:hover {
      background: #1db954;
      color: #000;
    }
    tbody tr.selected {
      background: #1db954;
      color: #000;
      font-weight: 700;
    }
    tbody tr.selected:hover {
      background: #17a44c;
    }
    /* Table column widths */
    th.name, td.name {
      width: 35%;
    }
    th.artist, td.artist {
      width: 25%;
    }
    th.album, td.album {
      width: 25%;
    }
    th.duration, td.duration {
      width: 15%;
      text-align: right;
      padding-right: 20px;
      font-variant-numeric: tabular-nums;
    }
    /* Right sidebar (Up Next queue) */
    .queue {
      width: 300px;
      background: #000;
      display: flex;
      flex-direction: column;
      padding: 20px 10px;
      transition: background 0.3s, color 0.3s;
    }
    body.light .queue {
      background: #f0f0f0;
      color: #111;
    }
    .queue h3 {
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 10px 0;
      text-align: center;
      color: #1db954;
    }
    .queue-list {
      flex-grow: 1;
      overflow-y: auto;
    }
    .queue-item {
      padding: 8px 10px;
      border-bottom: 1px solid #282828;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      transition: background 0.2s;
    }
    body.light .queue-item {
      border-color: #ccc;
    }
    .queue-item:hover {
      background: #1db954;
      color: #000;
    }
    .queue-item.selected {
      background: #1db954;
      font-weight: 700;
      color: #000;
    }
    .queue-item span {
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      width: 90%;
    }
    .queue-item button {
      background: none;
      border: none;
      color: #1db954;
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      user-select: none;
    }
    /* Bottom now playing bar */
    .now-playing-bar {
      height: 90px;
      background: #181818;
      border-top: 1px solid #333;
      display: flex;
      align-items: center;
      padding: 0 25px;
      color: #eee;
      user-select: none;
      transition: background 0.3s, color 0.3s;
    }
    body.light .now-playing-bar {
      background: #f9f9f9;
      border-color: #ccc;
      color: #111;
    }
    .now-playing-info {
      flex: 1;
      overflow: hidden;
    }
    .now-playing-title {
      font-weight: 700;
      font-size: 18px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 6px;
    }
    .now-playing-artist {
      font-size: 14px;
      color: #888;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    body.light .now-playing-artist {
      color: #666;
    }
    .player-controls {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-left: 20px;
      user-select: none;
    }
    .player-controls button {
      background: none;
      border: none;
      font-size: 28px;
      color: inherit;
      cursor: pointer;
      transition: color 0.3s;
      user-select: none;
    }
    .player-controls button:hover {
      color: #1db954;
    }
    .progress-container {
      flex-grow: 2;
      margin-left: 20px;
      display: flex;
      flex-direction: column;
      user-select: none;
    }
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #333;
      border-radius: 4px;
      cursor: pointer;
      position: relative;
      margin-bottom: 6px;
    }
    .progress-filled {
      height: 100%;
      background: #1db954;
      border-radius: 4px;
      width: 0%;
      transition: width 0.1s linear;
    }
    .time-container {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #888;
    }
    body.light .time-container {
      color: #666;
    }
    .volume-container {
      width: 150px;
      display: flex;
      align-items: center;
      gap: 6px;
      user-select: none;
    }
    .volume-slider {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 5px;
      background: #333;
      outline: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #1db954;
      cursor: pointer;
      transition: background 0.3s;
    }
    .volume-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #1db954;
      cursor: pointer;
      transition: background 0.3s;
    }
    .toggle-theme-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 8px 14px;
      background: #1db954;
      color: #000;
      font-weight: 700;
      border-radius: 18px;
      border: none;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s;
      z-index: 1000;
    }
    .toggle-theme-btn:hover {
      background: #17a44c;
    }
    body.light .toggle-theme-btn {
      background: #1db954;
      color: #000;
    }
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background-color: #1db954;
      border-radius: 4px;
    }
    /* Responsive */
    @media (max-width: 900px) {
      .queue {
        display: none;
      }
    }
  </style>
</head>
<body>
  <button class="toggle-theme-btn" id="toggleThemeBtn">Toggle Light/Dark</button>
  <div class="app">
    <div class="main-content">
      <nav class="sidebar" id="sidebar">
        <h2>Library</h2>
        <button id="btnAllSongs" class="active">All Songs</button>
        <div class="playlist-list" id="playlists"></div>
      </nav>
      <section class="library">
        <div class="library-header">
          <input type="search" id="searchInput" placeholder="Search" autocomplete="off" />
          <button id="btnNewPlaylist">New Playlist</button>
        </div>
        <table id="songsTable" tabindex="0" aria-label="Songs List">
          <thead>
            <tr>
              <th class="name" title="Song Name">Name</th>
              <th class="artist" title="Artist">Artist</th>
              <th class="album" title="Album">Album</th>
              <th class="duration" title="Duration">Time</th>
            </tr>
          </thead>
          <tbody id="songsBody">
            <!-- Songs go here -->
          </tbody>
        </table>
      </section>
      <aside class="queue">
        <h3>Up Next</h3>
        <div class="queue-list" id="queueList">
          <!-- Queue songs -->
        </div>
      </aside>
    </div>
    <footer class="now-playing-bar">
      <div class="now-playing-info" id="nowPlayingInfo">
        <div class="now-playing-title" id="nowPlayingTitle">No song selected</div>
        <div class="now-playing-artist" id="nowPlayingArtist">&nbsp;</div>
      </div>
      <div class="progress-container" id="progressContainer" aria-label="Playback progress" role="slider" tabindex="0">
        <div class="progress-bar" id="progressBar">
          <div class="progress-filled" id="progressFilled"></div>
        </div>
        <div class="time-container">
          <span id="currentTime">0:00</span>
          <span id="durationTime">0:00</span>
        </div>
      </div>
      <div class="player-controls">
        <button id="btnPrev" title="Previous">⏮️</button>
        <button id="btnPlayPause" title="Play">▶️</button>
        <button id="btnNext" title="Next">⏭️</button>
        <button id="btnShuffle" title="Shuffle">🔀</button>
      </div>
      <div class="volume-container" title="Volume control">
        <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.01" value="0.7" aria-label="Volume control"/>
      </div>
    </footer>
  </div>

  <script>
    // Your Google Drive Folder ID & API Key here
    const folderId = '1DGz9zEQh29EAqTZpmWK5mwSj5HComnkn';
    const apiKey = 'AIzaSyDsYE91wH7UDwu8eZNbD1CFuVcilgYeZhI';

    // Elements
    const btnAllSongs = document.getElementById('btnAllSongs');
    const playlistsDiv = document.getElementById('playlists');
    const songsBody = document.getElementById('songsBody');
    const searchInput = document.getElementById('searchInput');
    const btnNewPlaylist = document.getElementById('btnNewPlaylist');
    const queueList = document.getElementById('queueList');
    const nowPlayingTitle = document.getElementById('nowPlayingTitle');
    const nowPlayingArtist = document.getElementById('nowPlayingArtist');
    const btnPrev = document.getElementById('btnPrev');
    const btnPlayPause = document.getElementById('btnPlayPause');
    const btnNext = document.getElementById('btnNext');
    const btnShuffle = document.getElementById('btnShuffle');
    const volumeSlider = document.getElementById('volumeSlider');
    const progressBar = document.getElementById('progressBar');
    const progressFilled = document.getElementById('progressFilled');
    const currentTimeElem = document.getElementById('currentTime');
    const durationTimeElem = document.getElementById('durationTime');
    const progressContainer = document.getElementById('progressContainer');
    const toggleThemeBtn = document.getElementById('toggleThemeBtn');

    // State
    let tracks = [];
    let filteredTracks = [];
    let currentTrackIndex = -1;
    let isPlaying = false;
    let playlists = JSON.parse(localStorage.getItem('playlists') || '{}');
    let queue = [];
    let audio = new Audio();
    audio.volume = parseFloat(volumeSlider.value);

    // UTILITIES
    function formatDuration(seconds) {
      if (isNaN(seconds)) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }

    // API to load tracks from Google Drive
    async function loadAllTracks() {
      let allFiles = [];
      let pageToken = '';
      try {
        do {
          const query = encodeURIComponent(
            `'${folderId}' in parents and (mimeType contains 'audio/')`
          );
          const url = `https://www.googleapis.com/drive/v3/files?q=${query}&fields=files(id,name,mimeType),nextPageToken&pageSize=100&key=${apiKey}${pageToken ? `&pageToken=${pageToken}` : ''}`;
          const res = await fetch(url);
          const data = await res.json();
          if (data.files) allFiles = allFiles.concat(data.files);
          pageToken = data.nextPageToken || '';
        } while (pageToken);

        // Sort by name
        allFiles.sort((a, b) => a.name.localeCompare(b.name));

        tracks = allFiles.map(f => ({
          id: f.id,
          name: f.name,
          artist: 'Unknown Artist',
          album: 'Unknown Album',
          duration: 0, // We'll get duration later when loaded
        }));

        filteredTracks = [...tracks];
        renderSongs();
      } catch (err) {
        console.error('Error loading tracks', err);
        nowPlayingTitle.textContent = 'Error loading tracks';
      }
    }

    // Render playlists in sidebar
    function renderPlaylists() {
      playlistsDiv.innerHTML = '';
      for (const plName in playlists) {
        const btn = document.createElement('button');
        btn.textContent = plName;
        btn.onclick = () => {
          filteredTracks = playlists[plName];
          currentTrackIndex = -1;
          renderSongs();
          highlightPlaylistButton(plName);
        };
        playlistsDiv.appendChild(btn);
      }
    }

    function highlightPlaylistButton(name) {
      [...playlistsDiv.children].forEach(btn => {
        btn.classList.toggle('active', btn.textContent === name);
      });
      btnAllSongs.classList.toggle('active', false);
    }

    // Render songs table
    function renderSongs() {
      songsBody.innerHTML = '';
      filteredTracks.forEach((track, index) => {
        const tr = document.createElement('tr');
        tr.tabIndex = 0;
        tr.className = index === currentTrackIndex ? 'selected' : '';
        tr.onclick = () => {
          playTrack(index);
        };
        tr.onkeydown = (e) => {
          if (e.key === 'Enter') playTrack(index);
        };

        const tdName = document.createElement('td');
        tdName.className = 'name';
        tdName.textContent = track.name;

        const tdArtist = document.createElement('td');
        tdArtist.className = 'artist';
        tdArtist.textContent = track.artist;

        const tdAlbum = document.createElement('td');
        tdAlbum.className = 'album';
        tdAlbum.textContent = track.album;

        const tdDuration = document.createElement('td');
        tdDuration.className = 'duration';
        tdDuration.textContent = formatDuration(track.duration);

        tr.appendChild(tdName);
        tr.appendChild(tdArtist);
        tr.appendChild(tdAlbum);
        tr.appendChild(tdDuration);

        songsBody.appendChild(tr);
      });
    }

    // Play a track by index
    async function playTrack(index) {
      if (index < 0 || index >= filteredTracks.length) return;
      currentTrackIndex = index;
      const track = filteredTracks[index];
      // Set audio src to Google Drive streaming url
      audio.src = `https://www.googleapis.com/drive/v3/files/${track.id}?alt=media&key=${apiKey}`;
      audio.play().catch(() => {});
      isPlaying = true;
      btnPlayPause.textContent = '⏸️';
      nowPlayingTitle.textContent = track.name;
      nowPlayingArtist.textContent = `${track.artist} — ${track.album}`;
      updateSelectedSong();
      addToQueue(track);
      // Load duration (hack: wait for metadata)
      audio.onloadedmetadata = () => {
        track.duration = audio.duration;
        renderSongs();
      };
    }

    // Update highlighted song in table
    function updateSelectedSong() {
      [...songsBody.children].forEach((tr, i) => {
        tr.classList.toggle('selected', i === currentTrackIndex);
      });
    }

    // Add to queue (Up Next)
    function addToQueue(track) {
      if (!queue.find(t => t.id === track.id)) {
        queue.push(track);
        renderQueue();
      }
    }

    // Render Up Next queue list
    function renderQueue() {
      queueList.innerHTML = '';
      queue.forEach((track, i) => {
        const div = document.createElement('div');
        div.className = 'queue-item';
        div.textContent = track.name;
        if (i === currentTrackIndex) div.classList.add('selected');
        div.onclick = () => {
          playTrack(i);
        };
        queueList.appendChild(div);
      });
    }

    // Playback controls
    function playPause() {
      if (!audio.src) return;
      if (isPlaying) {
        audio.pause();
        btnPlayPause.textContent = '▶️';
      } else {
        audio.play().catch(() => {});
        btnPlayPause.textContent = '⏸️';
      }
      isPlaying = !isPlaying;
    }
    function nextTrack() {
      if (queue.length === 0) return;
      currentTrackIndex = (currentTrackIndex + 1) % queue.length;
      playTrack(currentTrackIndex);
    }
    function prevTrack() {
      if (queue.length === 0) return;
      currentTrackIndex = (currentTrackIndex - 1 + queue.length) % queue.length;
      playTrack(currentTrackIndex);
    }
    function shuffleQueue() {
      if (queue.length === 0) return;
      for (let i = queue.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [queue[i], queue[j]] = [queue[j], queue[i]];
      }
      renderQueue();
      currentTrackIndex = 0;
      playTrack(currentTrackIndex);
    }

    // Volume control
    volumeSlider.oninput = () => {
      audio.volume = parseFloat(volumeSlider.value);
    };

    // Progress bar control
    audio.ontimeupdate = () => {
      if (audio.duration) {
        const percent = (audio.currentTime / audio.duration) * 100;
        progressFilled.style.width = percent + '%';
        currentTimeElem.textContent = formatDuration(audio.currentTime);
        durationTimeElem.textContent = formatDuration(audio.duration);
      }
    };

    function seek(e) {
      const rect = progressBar.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const percent = clickX / rect.width;
      audio.currentTime = percent * audio.duration;
    }
    progressBar.addEventListener('click', seek);
    progressContainer.addEventListener('keydown', e => {
      if(e.key === 'ArrowLeft') audio.currentTime = Math.max(0, audio.currentTime - 5);
      else if(e.key === 'ArrowRight') audio.currentTime = Math.min(audio.duration, audio.currentTime + 5);
    });

    // Search/filter songs
    searchInput.oninput = () => {
      const q = searchInput.value.toLowerCase();
      filteredTracks = tracks.filter(t => t.name.toLowerCase().includes(q) || t.artist.toLowerCase().includes(q) || t.album.toLowerCase().includes(q));
      currentTrackIndex = -1;
      renderSongs();
    };

    // Playlist handling
    btnNewPlaylist.onclick = () => {
      const plName = prompt('Enter new playlist name:');
      if (!plName) return;
      if (playlists[plName]) {
        alert('Playlist already exists!');
        return;
      }
      playlists[plName] = [];
      savePlaylists();
      renderPlaylists();
    };

    function savePlaylists() {
      localStorage.setItem('playlists', JSON.stringify(playlists));
    }

    function addToPlaylist(plName, track) {
      if (!playlists[plName]) return;
      if (!playlists[plName].some(t => t.id === track.id)) {
        playlists[plName].push(track);
        savePlaylists();
      }
    }

    // Clicking playlist button filters songs & allows adding tracks to playlist via right-click menu
    playlistsDiv.addEventListener('contextmenu', e => {
      e.preventDefault();
      const target = e.target;
      if (target.tagName === 'BUTTON') {
        alert('Right-click disabled on playlist buttons to prevent conflicts.');
      }
    });

    // Add context menu to songs to add to playlist when in "All Songs" view
    songsBody.addEventListener('contextmenu', e => {
      e.preventDefault();
      if (currentTrackIndex === -1) return;
      if (filteredTracks.length === 0) return;
      if (currentTrackIndex < 0 || currentTrackIndex >= filteredTracks.length) return;

      // Build custom menu near cursor
      const menu = document.createElement('div');
      menu.style.position = 'fixed';
      menu.style.left = e.pageX + 'px';
      menu.style.top = e.pageY + 'px';
      menu.style.background = '#282828';
      menu.style.color = '#eee';
      menu.style.border = '1px solid #1db954';
      menu.style.padding = '5px';
      menu.style.borderRadius = '6px';
      menu.style.zIndex = 9999;

      Object.keys(playlists).forEach(plName => {
        const item = document.createElement('div');
        item.textContent = 'Add to "' + plName + '"';
        item.style.padding = '5px 10px';
        item.style.cursor = 'pointer';
        item.onmouseenter = () => { item.style.background = '#1db954'; item.style.color = '#000'; };
        item.onmouseleave = () => { item.style.background = ''; item.style.color = '#eee'; };
        item.onclick = () => {
          addToPlaylist(plName, filteredTracks[currentTrackIndex]);
          alert(`Added to playlist "${plName}"`);
          document.body.removeChild(menu);
        };
        menu.appendChild(item);
      });

      document.body.appendChild(menu);

      // Remove menu on click elsewhere
      const removeMenu = () => {
        if (menu.parentNode) menu.parentNode.removeChild(menu);
        document.removeEventListener('click', removeMenu);
      };
      document.addEventListener('click', removeMenu);
    });

    // Button handlers
    btnAllSongs.onclick = () => {
      filteredTracks = [...tracks];
      currentTrackIndex = -1;
      renderSongs();
      btnAllSongs.classList.add('active');
      [...playlistsDiv.children].forEach(b => b.classList.remove('active'));
    };
    btnPlayPause.onclick = playPause;
    btnNext.onclick = nextTrack;
    btnPrev.onclick = prevTrack;
    btnShuffle.onclick = shuffleQueue;

    // Auto next track on end
    audio.onended = nextTrack;

    // Toggle dark/light mode
    toggleThemeBtn.onclick = () => {
      if(document.body.classList.contains('light')) {
        document.body.classList.remove('light');
        localStorage.setItem('theme', 'dark');
      } else {
        document.body.classList.add('light');
        localStorage.setItem('theme', 'light');
      }
    };
    // Load saved theme
    (function(){
      const savedTheme = localStorage.getItem('theme');
      if(savedTheme === 'light') document.body.classList.add('light');
    })();

    // Initialize app
    async function init() {
      renderPlaylists();
      await loadAllTracks();
      btnAllSongs.click();
    }
    init();

  </script>
</body>
</html>
