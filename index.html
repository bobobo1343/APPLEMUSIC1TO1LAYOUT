<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ITUNE VERSION</title>
<style>
  /* Reset */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    background: #121212;
    color: #eee;
    overflow: hidden;
  }
  a {
    color: inherit;
    text-decoration: none;
  }
  button {
    cursor: pointer;
    background: none;
    border: none;
    color: inherit;
    font-size: 14px;
    font-weight: 600;
    transition: color 0.2s;
  }
  button:hover {
    color: #1db954;
  }
  /* Layout */
  .app {
    display: flex;
    height: 100vh;
    width: 100vw;
  }
  .sidebar {
    width: 280px;
    background: #000;
    border-right: 1px solid #333;
    display: flex;
    flex-direction: column;
    padding: 20px;
  }
  .sidebar h2 {
    margin: 0 0 20px;
    font-size: 22px;
    font-weight: 900;
    color: #1db954;
    text-align: center;
    letter-spacing: 1.5px;
  }
  .sidebar button {
    display: block;
    width: 100%;
    padding: 14px 15px;
    text-align: left;
    border-radius: 6px;
    margin-bottom: 8px;
    font-size: 16px;
  }
  .sidebar button.active,
  .sidebar button:hover {
    background: #1db954;
    color: #000;
    font-weight: 700;
  }
  .playlist-list {
    margin-top: 20px;
    flex-grow: 1;
    overflow-y: auto;
    border-top: 1px solid #333;
    padding-top: 15px;
  }
  .playlist-list button {
    padding-left: 25px;
    font-weight: 500;
    font-size: 15px;
    margin-bottom: 6px;
  }
  /* Main content */
  .main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  .library-header {
    padding: 12px 20px;
    background: #181818;
    display: flex;
    align-items: center;
    gap: 15px;
    border-bottom: 1px solid #333;
  }
  .library-header input[type="search"] {
    padding: 10px 15px;
    border-radius: 18px;
    border: none;
    flex-grow: 1;
    font-size: 16px;
    background: #282828;
    color: #eee;
    outline: none;
  }
  #btnNewPlaylist {
    background: #1db954;
    color: #000;
    font-weight: 700;
    padding: 10px 20px;
    border-radius: 18px;
    font-size: 16px;
    transition: background 0.3s;
  }
  #btnNewPlaylist:hover {
    background: #17a44c;
  }
  /* Track Table */
  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    flex-grow: 1;
    display: block;
    overflow-y: auto;
    height: calc(100vh - 140px);
  }
  thead {
    background: #282828;
    color: #bbb;
    font-size: 14px;
    font-weight: 700;
    display: table;
    width: 100%;
    table-layout: fixed;
  }
  tbody {
    display: block;
    max-height: calc(100vh - 160px);
    overflow-y: auto;
    width: 100%;
  }
  th, td {
    padding: 14px 16px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    vertical-align: middle;
    cursor: default;
    display: table-cell;
  }
  th {
    text-align: left;
    user-select: text;
  }
  tbody tr {
    border-bottom: 1px solid #282828;
    transition: background 0.2s;
    display: table;
    width: 100%;
    table-layout: fixed;
  }
  tbody tr:hover {
    background: #1db954;
    color: #000;
  }
  tbody tr.selected {
    background: #1db954;
    color: #000;
    font-weight: 700;
  }
  /* Table columns widths */
  th.name, td.name { width: 40%; }
  th.artist, td.artist { width: 25%; }
  th.album, td.album { width: 25%; }
  th.duration, td.duration {
    width: 10%;
    text-align: right;
    padding-right: 20px;
    font-variant-numeric: tabular-nums;
  }
  /* Playlist controls */
  .playlist-controls {
    padding: 10px 20px;
    background: #181818;
    border-top: 1px solid #333;
    display: flex;
    gap: 10px;
  }
  .playlist-controls button {
    background: #1db954;
    color: #000;
    font-weight: 700;
    padding: 8px 16px;
    border-radius: 18px;
    font-size: 14px;
    transition: background 0.3s;
  }
  .playlist-controls button:hover {
    background: #17a44c;
  }
  /* Playback bar */
  .playback-bar {
    height: 100px;
    background: #181818;
    border-top: 1px solid #333;
    display: flex;
    align-items: center;
    padding: 0 25px;
    color: #eee;
    gap: 20px;
  }
  .now-playing-info {
    flex: 1 1 300px;
    overflow: hidden;
    min-width: 220px;
  }
  .now-playing-title {
    font-weight: 700;
    font-size: 20px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 8px;
  }
  .now-playing-artist {
    font-size: 14px;
    color: #888;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .player-controls {
    display: flex;
    align-items: center;
    gap: 20px;
  }
  .player-controls button {
    background: none;
    border: none;
    font-size: 30px;
    color: inherit;
    cursor: pointer;
    transition: color 0.3s;
  }
  .player-controls button:hover {
    color: #1db954;
  }
  .progress-container {
    flex-grow: 2;
    min-width: 300px;
    display: flex;
    flex-direction: column;
  }
  .progress-bar {
    width: 100%;
    height: 8px;
    background: #333;
    border-radius: 4px;
    cursor: pointer;
    position: relative;
  }
  .progress-filled {
    height: 100%;
    background: #1db954;
    border-radius: 4px;
    width: 0%;
    transition: width 0.1s linear;
  }
  .time-container {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #888;
    margin-top: 4px;
  }
  /* Mini player window */
  #miniPlayer {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 320px;
    background: #181818;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.7);
    padding: 15px;
    color: #eee;
    user-select: none;
    cursor: move;
    z-index: 10000;
    display: none;
  }
  #miniPlayer .title {
    font-weight: 700;
    font-size: 18px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #miniPlayer .artist {
    font-size: 14px;
    color: #aaa;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 10px;
  }
  #miniPlayer button.close-btn {
    background: none;
    border: none;
    color: #1db954;
    font-size: 20px;
    float: right;
    cursor: pointer;
  }
  /* Scrollbars */
  ::-webkit-scrollbar {
    width: 10px;
    height: 10px;
  }
  ::-webkit-scrollbar-thumb {
    background: #1db954;
    border-radius: 10px;
  }
  ::-webkit-scrollbar-track {
    background: #222;
  }
</style>
</head>
<body>
<div class="app">
  <div class="sidebar">
    <h2>ITUNE VERSION</h2>
    <button id="btnAllSongs" class="active">All Songs</button>
    <div class="playlist-list" id="playlistList"></div>
    <button id="btnNewPlaylist">+ New Playlist</button>
  </div>
  <div class="main-content">
    <div class="library-header">
      <input type="search" id="searchInput" placeholder="Search songs..." autocomplete="off" />
      <button id="btnShowMiniPlayer">Show Mini Player</button>
    </div>
    <table>
      <thead>
        <tr>
          <th class="name">Song</th>
          <th class="artist">Artist</th>
          <th class="album">Album</th>
          <th class="duration">Duration</th>
          <th style="width:60px;">Add</th>
        </tr>
      </thead>
      <tbody id="trackTableBody">
        <!-- Tracks loaded here -->
      </tbody>
    </table>
    <div class="playlist-controls" style="display:none;" id="playlistControls">
      <button id="btnPlayPlaylist">Play Playlist</button>
      <button id="btnClearPlaylist">Clear Playlist</button>
    </div>
    <div class="playback-bar" id="playbackBar">
      <div class="now-playing-info">
        <div class="now-playing-title" id="nowPlayingTitle">Nothing Playing</div>
        <div class="now-playing-artist" id="nowPlayingArtist"></div>
      </div>
      <div class="player-controls">
        <button id="btnPrev">&#9664;&#9664;</button>
        <button id="btnPlayPause">&#9654;</button>
        <button id="btnNext">&#9654;&#9654;</button>
      </div>
      <div class="progress-container">
        <div class="progress-bar" id="progressBar">
          <div class="progress-filled" id="progressFilled"></div>
        </div>
        <div class="time-container">
          <span id="currentTime">0:00</span>
          <span id="durationTime">0:00</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="miniPlayer" title="Drag to move">
  <button class="close-btn" id="btnCloseMiniPlayer">&times;</button>
  <div class="title" id="miniTitle">Nothing Playing</div>
  <div class="artist" id="miniArtist"></div>
  <audio id="miniAudio" controls style="width:100%; margin-top:8px;"></audio>
</div>

<script>
  // Google Drive API info
  const FOLDER_ID = "1DGz9zEQh29EAqTZpmWK5mwSj5HComnkn";
  const API_KEY = "AIzaSyDsYE91wH7UDwu8eZNbD1CFuVcilgYeZhI";

  // State
  let allTracks = [];
  let filteredTracks = [];
  let playlists = JSON.parse(localStorage.getItem("playlists") || "{}");
  let currentPlaylist = null;
  let currentTrackIndex = -1;
  let isPlaying = false;

  // DOM Elements
  const btnAllSongs = document.getElementById("btnAllSongs");
  const playlistList = document.getElementById("playlistList");
  const btnNewPlaylist = document.getElementById("btnNewPlaylist");
  const searchInput = document.getElementById("searchInput");
  const trackTableBody = document.getElementById("trackTableBody");
  const playlistControls = document.getElementById("playlistControls");
  const btnPlayPlaylist = document.getElementById("btnPlayPlaylist");
  const btnClearPlaylist = document.getElementById("btnClearPlaylist");
  const playbackBar = document.getElementById("playbackBar");
  const nowPlayingTitle = document.getElementById("nowPlayingTitle");
  const nowPlayingArtist = document.getElementById("nowPlayingArtist");
  const btnPrev = document.getElementById("btnPrev");
  const btnPlayPause = document.getElementById("btnPlayPause");
  const btnNext = document.getElementById("btnNext");
  const progressBar = document.getElementById("progressBar");
  const progressFilled = document.getElementById("progressFilled");
  const currentTimeSpan = document.getElementById("currentTime");
  const durationTimeSpan = document.getElementById("durationTime");

  // Mini player elements
  const btnShowMiniPlayer = document.getElementById("btnShowMiniPlayer");
  const miniPlayer = document.getElementById("miniPlayer");
  const btnCloseMiniPlayer = document.getElementById("btnCloseMiniPlayer");
  const miniTitle = document.getElementById("miniTitle");
  const miniArtist = document.getElementById("miniArtist");
  const miniAudio = document.getElementById("miniAudio");

  // Audio elements
  let audio = new Audio();
  audio.crossOrigin = "anonymous";

  // Playback queue (history)
  let playbackQueue = [];

  // Helpers
  function formatDuration(seconds) {
    if (isNaN(seconds)) return "0:00";
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs < 10 ? "0" : ""}${secs}`;
  }

  function updatePlaybackBar() {
    if(currentTrackIndex < 0 || !filteredTracks[currentTrackIndex]) {
      nowPlayingTitle.textContent = "Nothing Playing";
      nowPlayingArtist.textContent = "";
      progressFilled.style.width = "0%";
      currentTimeSpan.textContent = "0:00";
      durationTimeSpan.textContent = "0:00";
      btnPlayPause.textContent = "▶️";
      return;
    }
    const track = filteredTracks[currentTrackIndex];
    nowPlayingTitle.textContent = track.name;
    nowPlayingArtist.textContent = track.artist || "";
  }

  function playTrack(index) {
    if(index < 0 || index >= filteredTracks.length) return;
    currentTrackIndex = index;
    const track = filteredTracks[index];
    audio.src = `https://www.googleapis.com/drive/v3/files/${track.id}?alt=media&key=${API_KEY}`;
    audio.play().catch(console.error);
    isPlaying = true;
    updatePlaybackBar();
    updateMiniPlayer(track);
    addToPlaybackQueue(track);
    highlightSelectedRow();
  }

  function highlightSelectedRow() {
    const rows = trackTableBody.querySelectorAll("tr");
    rows.forEach((row, i) => {
      row.classList.toggle("selected", i === currentTrackIndex);
    });
  }

  // Playback controls
  btnPlayPause.onclick = () => {
    if(isPlaying) {
      audio.pause();
      isPlaying = false;
      btnPlayPause.textContent = "▶️";
      miniAudio.pause();
    } else {
      audio.play().catch(console.error);
      isPlaying = true;
      btnPlayPause.textContent = "⏸️";
      miniAudio.play();
    }
  };
  btnPrev.onclick = () => {
    if(currentTrackIndex > 0) playTrack(currentTrackIndex - 1);
  };
  btnNext.onclick = () => {
    if(currentTrackIndex < filteredTracks.length - 1) playTrack(currentTrackIndex + 1);
  };

  // Progress bar
  audio.ontimeupdate = () => {
    if(audio.duration) {
      const percent = (audio.currentTime / audio.duration) * 100;
      progressFilled.style.width = percent + "%";
      currentTimeSpan.textContent = formatDuration(audio.currentTime);
      durationTimeSpan.textContent = formatDuration(audio.duration);
    }
  };
  progressBar.onclick = (e) => {
    const rect = progressBar.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const width = rect.width;
    const newTime = (clickX / width) * audio.duration;
    audio.currentTime = newTime;
  };

  // Search filter
  searchInput.oninput = () => {
    const q = searchInput.value.toLowerCase();
    if(currentPlaylist) {
      filteredTracks = playlists[currentPlaylist].filter(t => t.name.toLowerCase().includes(q));
    } else {
      filteredTracks = allTracks.filter(t => t.name.toLowerCase().includes(q));
    }
    currentTrackIndex = -1;
    renderTrackTable();
  };

  // Playlist rendering
  function renderPlaylistButtons() {
    playlistList.innerHTML = "";
    Object.keys(playlists).forEach(name => {
      const btn = document.createElement("button");
      btn.textContent = name;
      btn.onclick = () => {
        currentPlaylist = name;
        filteredTracks = [...playlists[name]];
        currentTrackIndex = -1;
        btnAllSongs.classList.remove("active");
        Array.from(playlistList.children).forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        playlistControls.style.display = "flex";
        renderTrackTable();
      };
      playlistList.appendChild(btn);
    });
  }
  renderPlaylistButtons();

  // Playlist controls
  btnPlayPlaylist.onclick = () => {
    if(filteredTracks.length > 0) playTrack(0);
  };
  btnClearPlaylist.onclick = () => {
    currentPlaylist = null;
    filteredTracks = [...allTracks];
    currentTrackIndex = -1;
    playlistControls.style.display = "none";
    btnAllSongs.classList.add("active");
    Array.from(playlistList.children).forEach(b => b.classList.remove("active"));
    renderTrackTable();
  };

  // Add song to playlist
  function addToPlaylist(track) {
    if(!currentPlaylist) {
      alert("Select a playlist or create a new one first.");
      return;
    }
    if(!playlists[currentPlaylist]) playlists[currentPlaylist] = [];
    if(playlists[currentPlaylist].find(t => t.id === track.id)) return;
    playlists[currentPlaylist].push(track);
    localStorage.setItem("playlists", JSON.stringify(playlists));
    filteredTracks = [...playlists[currentPlaylist]];
    renderTrackTable();
  }

  // New playlist creation
  btnNewPlaylist.onclick = () => {
    const name = prompt("Enter new playlist name:");
    if(!name) return;
    if(playlists[name]) {
      alert("Playlist already exists!");
      return;
    }
    playlists[name] = [];
    localStorage.setItem("playlists", JSON.stringify(playlists));
    renderPlaylistButtons();
  };

  // Render track table
  function renderTrackTable() {
    trackTableBody.innerHTML = "";
    filteredTracks.forEach((track, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="name">${track.name}</td>
        <td class="artist">${track.artist || ""}</td>
        <td class="album">${track.album || ""}</td>
        <td class="duration">${formatDuration(track.duration)}</td>
        <td style="text-align:center;"><button title="Add to Playlist">+</button></td>
      `;
      tr.querySelector("button").onclick = (e) => {
        e.stopPropagation();
        addToPlaylist(track);
      };
      tr.onclick = () => {
        playTrack(i);
      };
      trackTableBody.appendChild(tr);
    });
    highlightSelectedRow();
  }

  // Load songs from Google Drive folder
  async function loadSongsFromDrive() {
    try {
      let pageToken = "";
      let files = [];
      do {
        const res = await fetch(`https://www.googleapis.com/drive/v3/files?key=${API_KEY}&q='${FOLDER_ID}'+in+parents+and+mimeType+contains+'audio/'&fields=nextPageToken,files(id,name,mimeType)${pageToken ? ",pageToken="+pageToken : ""}`);
        const data = await res.json();
        if(data.error) throw new Error(data.error.message);
        files = files.concat(data.files);
        pageToken = data.nextPageToken || "";
      } while(pageToken);
      allTracks = files.map(f => ({
        id: f.id,
        name: f.name,
        artist: "",
        album: "",
        duration: 0, // duration unknown without extra API
      }));
      filteredTracks = [...allTracks];
      renderTrackTable();
    } catch(e) {
      alert("Failed to load songs: "+e.message);
    }
  }

  // Playback history (queue)
  function addToPlaybackQueue(track) {
    playbackQueue.push(track);
    if(playbackQueue.length > 30) playbackQueue.shift(); // Keep last 30
  }

  // Mini player update
  function updateMiniPlayer(track) {
    miniTitle.textContent = track.name;
    miniArtist.textContent = track.artist || "";
    miniAudio.src = `https://www.googleapis.com/drive/v3/files/${track.id}?alt=media&key=${API_KEY}`;
    miniAudio.play().catch(() => {});
  }

  // Mini player controls
  btnShowMiniPlayer.onclick = () => {
    miniPlayer.style.display = "block";
  };
  btnCloseMiniPlayer.onclick = () => {
    miniPlayer.style.display = "none";
    miniAudio.pause();
  };

  // Drag mini player
  (() => {
    let isDragging = false, offsetX = 0, offsetY = 0;
    miniPlayer.addEventListener("mousedown", (e) => {
      if(e.target.closest("button")) return; // Ignore clicks on buttons
      isDragging = true;
      offsetX = e.clientX - miniPlayer.getBoundingClientRect().left;
      offsetY = e.clientY - miniPlayer.getBoundingClientRect().top;
      miniPlayer.style.userSelect = "none";
    });
    window.addEventListener("mouseup", () => {
      isDragging = false;
      miniPlayer.style.userSelect = "";
    });
    window.addEventListener("mousemove", (e) => {
      if(!isDragging) return;
      let left = e.clientX - offsetX;
      let top = e.clientY - offsetY;
      left = Math.min(window.innerWidth - miniPlayer.offsetWidth, Math.max(0, left));
      top = Math.min(window.innerHeight - miniPlayer.offsetHeight, Math.max(0, top));
      miniPlayer.style.left = left + "px";
      miniPlayer.style.top = top + "px";
    });
  })();

  // Initial load
  btnAllSongs.onclick = () => {
    currentPlaylist = null;
    filteredTracks = [...allTracks];
    currentTrackIndex = -1;
    btnAllSongs.classList.add("active");
    Array.from(playlistList.children).forEach(b => b.classList.remove("active"));
    playlistControls.style.display = "none";
    renderTrackTable();
  };
  btnAllSongs.click();

  loadSongsFromDrive();

</script>
</body>
</html>
