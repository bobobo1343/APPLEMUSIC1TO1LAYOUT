<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>iTunes Replica Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Reset and base */
    * {
      box-sizing: border-box;
    }
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background: #f5f5f7;
      color: #1c1c1e;
      user-select: none;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }
    body.dark {
      background: #121212;
      color: #eee;
    }

    /* Layout */
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    header {
      height: 44px;
      background: #f5f5f7;
      color: #1c1c1e;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      user-select: none;
      border-bottom: 1px solid #ccc;
      transition: background 0.3s, color 0.3s;
    }
    body.dark header {
      background: #1c1c1e;
      color: #eee;
      border-bottom: 1px solid #333;
    }
    header button {
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      border: none;
      background: none;
      color: inherit;
      padding: 4px 12px;
      border-radius: 14px;
      transition: background 0.3s;
    }
    header button:hover {
      background: #007aff;
      color: white;
    }

    #main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Sidebar */
    #sidebar {
      width: 250px;
      background: #e1e1e6;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      padding: 16px 10px;
      transition: background 0.3s, color 0.3s;
    }
    body.dark #sidebar {
      background: #2c2c2e;
      border-color: #444;
    }
    #sidebar h2 {
      margin: 0 0 12px;
      font-weight: 700;
      font-size: 20px;
      text-align: center;
      color: #007aff;
    }
    #sidebar button, .playlist-btn {
      display: block;
      width: 100%;
      text-align: left;
      margin-bottom: 6px;
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 14px;
      border: none;
      background: none;
      color: inherit;
      cursor: pointer;
      transition: background 0.3s, color 0.3s;
      user-select: none;
    }
    #sidebar button.active, .playlist-btn.active,
    #sidebar button:hover, .playlist-btn:hover {
      background: #007aff;
      color: white;
      font-weight: 700;
    }
    #playlist-create {
      display: flex;
      margin-top: auto;
      gap: 6px;
    }
    #newPlaylistInput {
      flex: 1;
      padding: 6px 12px;
      border-radius: 14px;
      border: 1px solid #ccc;
      outline: none;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    #newPlaylistInput:focus {
      border-color: #007aff;
    }
    #addPlaylistBtn {
      font-size: 20px;
      padding: 0 10px;
      font-weight: 700;
      background: #007aff;
      color: white;
      border-radius: 14px;
      border: none;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s;
    }
    #addPlaylistBtn:hover {
      background: #005bb5;
    }

    /* Library Section */
    #library {
      flex: 2;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #ccc;
      background: white;
      transition: background 0.3s, color 0.3s;
      overflow: hidden;
    }
    body.dark #library {
      background: #1c1c1e;
      border-color: #444;
    }
    #library-header {
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid #ccc;
      transition: border-color 0.3s;
    }
    body.dark #library-header {
      border-color: #444;
    }
    #searchInput {
      flex: 1;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 14px;
      border: 1px solid #ccc;
      outline: none;
      transition: background 0.3s, color 0.3s, border-color 0.3s;
      color: #1c1c1e;
    }
    #searchInput::placeholder {
      color: #999;
    }
    #featuresDropdownBtn {
      font-weight: 700;
      padding: 8px 12px;
      border-radius: 14px;
      border: none;
      background: #007aff;
      color: white;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s;
    }
    #featuresDropdownBtn:hover {
      background: #005bb5;
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    thead {
      flex: 0 0 auto;
      background: #f0f0f3;
      color: #555;
      font-weight: 600;
      font-size: 13px;
      user-select: none;
      border-bottom: 1px solid #ccc;
      transition: background 0.3s, color 0.3s;
    }
    body.dark thead {
      background: #2c2c2e;
      color: #aaa;
      border-color: #444;
    }
    thead tr {
      display: flex;
      width: 100%;
    }
    tbody {
      flex: 1 1 auto;
      overflow-y: auto;
      display: block;
      width: 100%;
    }
    tbody tr {
      display: flex;
      width: 100%;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
    }
    tbody tr:hover {
      background: #e0f0ff;
    }
    body.dark tbody tr:hover {
      background: #333744;
    }
    tbody tr.selected {
      background: #007aff;
      color: white;
      font-weight: 700;
    }
    tbody td {
      padding: 8px 12px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      flex-shrink: 0;
    }
    tbody td.name { flex: 35%; }
    tbody td.artist { flex: 25%; }
    tbody td.album { flex: 25%; }
    tbody td.duration {
      flex: 15%;
      text-align: right;
      padding-right: 20px;
      font-variant-numeric: tabular-nums;
    }

    /* Queue (History) */
    #queue {
      width: 300px;
      background: #e1e1e6;
      padding: 16px 10px;
      transition: background 0.3s, color 0.3s;
      overflow-y: auto;
      user-select: none;
      display: flex;
      flex-direction: column;
    }
    body.dark #queue {
      background: #2c2c2e;
      color: #eee;
    }
    #queue h3 {
      font-weight: 700;
      font-size: 18px;
      margin: 0 0 12px;
      text-align: center;
      color: #007aff;
    }
    .queue-item {
      padding: 10px 12px;
      border-bottom: 1px solid #ccc;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
      border-radius: 14px;
      margin-bottom: 6px;
      user-select: none;
    }
    body.dark .queue-item {
      border-color: #444;
    }
    .queue-item:hover {
      background: #007aff;
      color: white;
    }
    .queue-item.selected {
      background: #005bb5;
      color: white;
      font-weight: 700;
    }

    /* Playback Bar */
    #playbackBar {
      height: 80px;
      background: #f5f5f7;
      border-top: 1px solid #ccc;
      display: flex;
      align-items: center;
      padding: 0 20px;
      user-select: none;
      transition: background 0.3s, color 0.3s;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 500;
      gap: 16px;
      box-sizing: border-box;
    }
    body.dark #playbackBar {
      background: #1c1c1e;
      border-color: #444;
      color: #eee;
    }

    #playbackInfo {
      flex: 1 1 30%;
      overflow: hidden;
    }
    #playbackTitle {
      font-weight: 700;
      font-size: 16px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #playbackArtist {
      font-size: 14px;
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    body.dark #playbackArtist {
      color: #aaa;
    }

    #playbackControls {
      flex: 0 0 auto;
      display: flex;
      gap: 16px;
      font-size: 28px;
    }
    #playbackControls button {
      background: none;
      border: none;
      cursor: pointer;
      color: #007aff;
      transition: color 0.3s;
      user-select: none;
    }
    #playbackControls button:hover {
      color: #005bb5;
    }

    #progressContainer {
      flex: 1 1 40%;
      user-select: none;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 200px;
    }
    #progressBar {
      background: #d8d8d8;
      border-radius: 6px;
      height: 8px;
      cursor: pointer;
      position: relative;
      width: 100%;
      overflow: hidden;
    }
    body.dark #progressBar {
      background: #444;
    }
    #progressFilled {
      background: #007aff;
      height: 100%;
      width: 0%;
      transition: width 0.1s linear;
      border-radius: 6px 0 0 6px;
    }
    #timeDisplay {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #666;
    }
    body.dark #timeDisplay {
      color: #aaa;
    }

    #volumeControl {
      width: 120px;
      flex: 0 0 auto;
    }
    #volumeSlider {
      width: 100%;
      cursor: pointer;
    }

    #miniPlayerToggle {
      flex: 0 0 auto;
      cursor: pointer;
      background: none;
      border: none;
      color: #007aff;
      font-weight: 700;
      font-size: 14px;
      padding: 6px 12px;
      border-radius: 14px;
      transition: background 0.3s;
    }
    #miniPlayerToggle:hover {
      background: #005bb5;
      color: white;
    }

    /* Mini Player */
    #miniPlayer {
      position: fixed;
      bottom: 90px;
      right: 24px;
      width: 300px;
      background: #f5f5f7;
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      padding: 12px 16px;
      display: none;
      user-select: none;
      transition: background 0.3s, color 0.3s;
      z-index: 510;
      font-size: 14px;
      color: #1c1c1e;
    }
    body.dark #miniPlayer {
      background: #1c1c1e;
      color: #eee;
      box-shadow: 0 6px 20px rgba(255,255,255,0.15);
    }
    #miniPlayer.show {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    #miniTitle {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 700;
    }
    #miniArtist {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #666;
    }
    body.dark #miniArtist {
      color: #aaa;
    }
    #miniControls button {
      background: none;
      border: none;
      color: #007aff;
      font-size: 22px;
      cursor: pointer;
      user-select: none;
      padding: 0 6px;
      transition: color 0.3s;
    }
    #miniControls button:hover {
      color: #005bb5;
    }

    /* FEATURES Dropdown and EQ */
    #featuresDropdown {
      position: fixed;
      bottom: 100px;
      left: 20px;
      width: 360px;
      max-height: 500px;
      background: #f5f5f7;
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      padding: 20px 24px 24px;
      overflow-y: auto;
      user-select: none;
      transition: background 0.3s, color 0.3s;
      display: none;
      z-index: 600;
    }
    body.dark #featuresDropdown {
      background: #1c1c1e;
      color: #eee;
      box-shadow: 0 6px 20px rgba(255,255,255,0.15);
    }
    #featuresDropdown.open {
      display: block;
    }
    #featuresDropdown header {
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 16px;
      cursor: grab;
      user-select: none;
      color: #1c1c1e;
      transition: color 0.3s ease;
    }
    body.dark #featuresDropdown header {
      color: #eee;
    }
    .eq-row {
      display: flex;
      align-items: center;
      margin-bottom: 14px;
    }
    .eq-label {
      width: 60px;
      font-size: 12px;
      color: #444;
      transition: color 0.3s ease;
      user-select: none;
    }
    body.dark .eq-label {
      color: #aaa;
    }
    .eq-slider {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: #d0d0d6;
      cursor: pointer;
      outline: none;
      margin-left: 12px;
      transition: background 0.3s ease;
    }
    .eq-slider:hover {
      background: #a0a0b0;
    }
    .eq-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: #007aff;
      border-radius: 50%;
      cursor: pointer;
      border: none;
      margin-top: -5px;
      transition: background 0.3s ease;
    }
    .eq-slider::-webkit-slider-thumb:hover {
      background: #005bb5;
    }
    body.dark .eq-slider {
      background: #333;
    }
    body.dark .eq-slider:hover {
      background: #555;
    }
    body.dark .eq-slider::-webkit-slider-thumb {
      background: #0a84ff;
    }
    body.dark .eq-slider::-webkit-slider-thumb:hover {
      background: #0665cc;
    }
  </style>
</head>
<body>

<div id="app">
  <header>
    <div>iTunes Replica Player</div>
    <div>
      <button id="darkModeToggle">Dark Mode</button>
      <button id="featuresDropdownBtn">FEATURES</button>
      <button id="miniPlayerToggle">Mini Player</button>
    </div>
  </header>

  <div id="main">
    <aside id="sidebar">
      <h2>Playlists</h2>
      <button id="allSongsBtn" class="active">All Songs</button>
      <div id="playlistList"></div>
      <div id="playlist-create">
        <input id="newPlaylistInput" placeholder="New Playlist Name" />
        <button id="addPlaylistBtn" title="Add Playlist">+</button>
      </div>
    </aside>

    <section id="library">
      <div id="library-header">
        <input type="search" id="searchInput" placeholder="Search songs or artists" />
      </div>
      <table>
        <thead>
          <tr>
            <th class="name">Name</th>
            <th class="artist">Artist</th>
            <th class="album">Album</th>
            <th class="duration">Duration</th>
          </tr>
        </thead>
        <tbody id="songList">
          <!-- Songs will be loaded here -->
        </tbody>
      </table>
    </section>

    <aside id="queue">
      <h3>Up Next (History)</h3>
      <div id="queueList">
        <!-- Queue songs -->
      </div>
    </aside>
  </div>

  <div id="playbackBar">
    <div id="playbackInfo">
      <div id="playbackTitle">No song playing</div>
      <div id="playbackArtist"></div>
    </div>
    <div id="playbackControls">
      <button id="prevBtn" title="Previous">&#9664;&#9664;</button>
      <button id="playPauseBtn" title="Play/Pause">&#9654;</button>
      <button id="nextBtn" title="Next">&#9654;&#9654;</button>
    </div>
    <div id="progressContainer">
      <div id="progressBar">
        <div id="progressFilled"></div>
      </div>
      <div id="timeDisplay">
        <span id="currentTime">0:00</span>
        <span id="totalTime">0:00</span>
      </div>
    </div>
    <div id="volumeControl">
      <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.8" />
    </div>
  </div>

  <div id="miniPlayer">
    <div id="miniTitle">No song playing</div>
    <div id="miniArtist"></div>
    <div id="miniControls">
      <button id="miniPrevBtn" title="Previous">&#9664;&#9664;</button>
      <button id="miniPlayPauseBtn" title="Play/Pause">&#9654;</button>
      <button id="miniNextBtn" title="Next">&#9654;&#9654;</button>
    </div>
  </div>

  <div id="featuresDropdown">
    <header>Equalizer (Drag me!)</header>
    <div class="eq-row">
      <label class="eq-label" for="eq60">60Hz</label>
      <input type="range" id="eq60" class="eq-slider" min="-15" max="15" step="0.5" value="0" />
    </div>
    <div class="eq-row">
      <label class="eq-label" for="eq170">170Hz</label>
      <input type="range" id="eq170" class="eq-slider" min="-15" max="15" step="0.5" value="0" />
    </div>
    <div class="eq-row">
      <label class="eq-label" for="eq310">310Hz</label>
      <input type="range" id="eq310" class="eq-slider" min="-15" max="15" step="0.5" value="0" />
    </div>
    <div class="eq-row">
      <label class="eq-label" for="eq600">600Hz</label>
      <input type="range" id="eq600" class="eq-slider" min="-15" max="15" step="0.5" value="0" />
    </div>
    <div class="eq-row">
      <label class="eq-label" for="eq1000">1kHz</label>
      <input type="range" id="eq1000" class="eq-slider" min="-15" max="15" step="0.5" value="0" />
    </div>
    <div class="eq-row">
      <label class="eq-label" for="eq3000">3kHz</label>
      <input type="range" id="eq3000" class="eq-slider" min="-15" max="15" step="0.5" value="0" />
    </div>
    <div class="eq-row">
      <label class="eq-label" for="eq6000">6kHz</label>
      <input type="range" id="eq6000" class="eq-slider" min="-15" max="15" step="0.5" value="0" />
    </div>
    <div class="eq-row">
      <label class="eq-label" for="eq12000">12kHz</label>
      <input type="range" id="eq12000" class="eq-slider" min="-15" max="15" step="0.5" value="0" />
    </div>
    <div class="eq-row">
      <label class="eq-label" for="eq14000">14kHz</label>
      <input type="range" id="eq14000" class="eq-slider" min="-15" max="15" step="0.5" value="0" />
    </div>
    <div class="eq-row">
      <label class="eq-label" for="eq16000">16kHz</label>
      <input type="range" id="eq16000" class="eq-slider" min="-15" max="15" step="0.5" value="0" />
    </div>
  </div>
</div>

<script>
  // Replace with your Google Drive API key and folder ID
  const API_KEY = 'AIzaSyDsYE91wH7UDwu8eZNbD1CFuVcilgYeZhI';
  const FOLDER_ID = '1DGz9zEQh29EAqTZpmWK5mwSj5HComnkn';

  // Player State
  let allSongs = [];
  let filteredSongs = [];
  let playlists = {};
  let currentPlaylist = null; // null means all songs
  let currentSongIndex = -1;
  let isPlaying = false;
  let historyQueue = []; // For "Up Next" history
  let darkMode = false;

  // Audio and Web Audio API Context
  const audio = new Audio();
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const sourceNode = audioContext.createMediaElementSource(audio);

  // Create EQ filters
  const eqFrequencies = [60,170,310,600,1000,3000,6000,12000,14000,16000];
  const filters = eqFrequencies.map(freq => {
    const filter = audioContext.createBiquadFilter();
    filter.type = 'peaking';
    filter.frequency.value = freq;
    filter.Q.value = 1;
    filter.gain.value = 0;
    return filter;
  });

  // Connect filters in series and connect to destination
  sourceNode.connect(filters[0]);
  for(let i=0; i<filters.length-1; i++) {
    filters[i].connect(filters[i+1]);
  }
  filters[filters.length -1].connect(audioContext.destination);

  // Elements
  const allSongsBtn = document.getElementById('allSongsBtn');
  const playlistList = document.getElementById('playlistList');
  const newPlaylistInput = document.getElementById('newPlaylistInput');
  const addPlaylistBtn = document.getElementById('addPlaylistBtn');
  const songList = document.getElementById('songList');
  const queueList = document.getElementById('queueList');
  const searchInput = document.getElementById('searchInput');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const playbackTitle = document.getElementById('playbackTitle');
  const playbackArtist = document.getElementById('playbackArtist');
  const playbackBar = document.getElementById('playbackBar');
  const progressBar = document.getElementById('progressBar');
  const progressFilled = document.getElementById('progressFilled');
  const currentTimeEl = document.getElementById('currentTime');
  const totalTimeEl = document.getElementById('totalTime');
  const volumeSlider = document.getElementById('volumeSlider');
  const darkModeToggle = document.getElementById('darkModeToggle');
  const featuresDropdownBtn = document.getElementById('featuresDropdownBtn');
  const featuresDropdown = document.getElementById('featuresDropdown');
  const miniPlayerToggle = document.getElementById('miniPlayerToggle');
  const miniPlayer = document.getElementById('miniPlayer');
  const miniTitle = document.getElementById('miniTitle');
  const miniArtist = document.getElementById('miniArtist');
  const miniPlayPauseBtn = document.getElementById('miniPlayPauseBtn');
  const miniPrevBtn = document.getElementById('miniPrevBtn');
  const miniNextBtn = document.getElementById('miniNextBtn');

  // Helper to format duration seconds to mm:ss
  function formatDuration(seconds) {
    if (isNaN(seconds)) return "0:00";
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return mins + ":" + (secs < 10 ? "0" : "") + secs;
  }

  // Render songs list
  function renderSongs() {
    // Filter based on search and playlist
    let listToRender = filteredSongs;
    if (currentPlaylist && playlists[currentPlaylist]) {
      const playlistSongIds = new Set(playlists[currentPlaylist]);
      listToRender = filteredSongs.filter(s => playlistSongIds.has(s.id));
    }
    songList.innerHTML = '';
    listToRender.forEach((song, i) => {
      const tr = document.createElement('tr');
      tr.classList.toggle('selected', i === currentSongIndex);
      tr.dataset.index = i;
      tr.title = `${song.artist} - ${song.name}`;
      tr.innerHTML = `
        <td class="name">${song.name}</td>
        <td class="artist">${song.artist || ''}</td>
        <td class="album">${song.album || ''}</td>
        <td class="duration">${formatDuration(song.duration)}</td>
      `;
      tr.onclick = () => {
        playSong(i);
      };
      songList.appendChild(tr);
    });
  }

  // Render playlists list
  function renderPlaylists() {
    playlistList.innerHTML = '';
    for (const name in playlists) {
      const btn = document.createElement('button');
      btn.textContent = name;
      btn.classList.add('playlist-btn');
      if (currentPlaylist === name) btn.classList.add('active');
      btn.onclick = () => {
        currentPlaylist = name;
        filteredSongs = allSongs.slice();
        renderSongs();
        renderPlaylists();
        allSongsBtn.classList.remove('active');
      };
      playlistList.appendChild(btn);
    }
  }

  // Render queue (history)
  function renderQueue() {
    queueList.innerHTML = '';
    historyQueue.forEach((song, i) => {
      const div = document.createElement('div');
      div.classList.add('queue-item');
      if (currentSongIndex !== -1 && allSongs[currentSongIndex]?.id === song.id) {
        div.classList.add('selected');
      }
      div.textContent = `${song.artist || ''} - ${song.name}`;
      div.title = `${song.artist || ''} - ${song.name}`;
      div.onclick = () => {
        const idx = allSongs.findIndex(s => s.id === song.id);
        if (idx !== -1) playSong(idx);
      };
      queueList.appendChild(div);
    });
  }

  // Play song at index
  async function playSong(index) {
    if (index < 0 || index >= filteredSongs.length) return;
    if (currentPlaylist && playlists[currentPlaylist]) {
      // Map filteredSongs index to allSongs index
      const playlistSongIds = playlists[currentPlaylist];
      const songId = filteredSongs[index].id;
      const allIdx = allSongs.findIndex(s => s.id === songId);
      if (allIdx === -1) return;
      currentSongIndex = allIdx;
    } else {
      currentSongIndex = index;
    }
    const song = allSongs[currentSongIndex];
    if (!song) return;
    try {
      if (audioContext.state === 'suspended') await audioContext.resume();

      audio.src = song.url;
      audio.play();
      isPlaying = true;
      updatePlaybackInfo();
      updateButtons();

      // Add to historyQueue without duplicates, limit to last 30
      historyQueue = historyQueue.filter(s => s.id !== song.id);
      historyQueue.unshift(song);
      if (historyQueue.length > 30) historyQueue.pop();
      renderQueue();
      renderSongs();
      renderPlaylists();
    } catch (e) {
      alert('Error playing song: ' + e.message);
    }
  }

  // Update playback info
  function updatePlaybackInfo() {
    const song = allSongs[currentSongIndex];
    if (!song) {
      playbackTitle.textContent = 'No song playing';
      playbackArtist.textContent = '';
      miniTitle.textContent = 'No song playing';
      miniArtist.textContent = '';
      return;
    }
    playbackTitle.textContent = song.name;
    playbackArtist.textContent = song.artist || '';
    miniTitle.textContent = song.name;
    miniArtist.textContent = song.artist || '';
  }

  // Update play/pause buttons
  function updateButtons() {
    if (isPlaying) {
      playPauseBtn.innerHTML = '&#10073;&#10073;'; // Pause symbol
      miniPlayPauseBtn.innerHTML = '&#10073;&#10073;';
    } else {
      playPauseBtn.innerHTML = '&#9654;'; // Play symbol
      miniPlayPauseBtn.innerHTML = '&#9654;';
    }
  }

  // Playback control handlers
  playPauseBtn.onclick = () => {
    if (!audio.src) return;
    if (isPlaying) {
      audio.pause();
      isPlaying = false;
    } else {
      audio.play();
      isPlaying = true;
    }
    updateButtons();
  };
  miniPlayPauseBtn.onclick = playPauseBtn.onclick;

  prevBtn.onclick = () => {
    if (currentSongIndex <= 0) return;
    playSong(currentSongIndex - 1);
  };
  miniPrevBtn.onclick = prevBtn.onclick;

  nextBtn.onclick = () => {
    if (currentSongIndex + 1 >= filteredSongs.length) return;
    playSong(currentSongIndex + 1);
  };
  miniNextBtn.onclick = nextBtn.onclick;

  // Progress bar update
  audio.ontimeupdate = () => {
    if (audio.duration) {
      const percent = (audio.currentTime / audio.duration) * 100;
      progressFilled.style.width = percent + '%';
      currentTimeEl.textContent = formatDuration(audio.currentTime);
      totalTimeEl.textContent = formatDuration(audio.duration);
    }
  };

  // Seek in song
  progressBar.onclick = (e) => {
    if (!audio.duration) return;
    const rect = progressBar.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const percentage = clickX / rect.width;
    audio.currentTime = percentage * audio.duration;
  };

  // Volume control
  volumeSlider.oninput = () => {
    audio.volume = volumeSlider.value;
  };
  volumeSlider.value = 0.8;
  audio.volume = 0.8;

  // Search filtering
  searchInput.oninput = () => {
    const q = searchInput.value.toLowerCase();
    filteredSongs = allSongs.filter(song => {
      return song.name.toLowerCase().includes(q) || (song.artist && song.artist.toLowerCase().includes(q));
    });
    renderSongs();
  };

  // Playlist controls
  allSongsBtn.onclick = () => {
    currentPlaylist = null;
    filteredSongs = allSongs.slice();
    currentSongIndex = -1;
    searchInput.value = '';
    renderSongs();
    renderQueue();
    updatePlaybackInfo();
    renderPlaylists();
    allSongsBtn.classList.add('active');
  };

  addPlaylistBtn.onclick = () => {
    const name = newPlaylistInput.value.trim();
    if (!name) return alert('Please enter a playlist name');
    if (playlists[name]) return alert('Playlist already exists');
    playlists[name] = [];
    currentPlaylist = name;
    filteredSongs = allSongs.slice();
    currentSongIndex = -1;
    newPlaylistInput.value = '';
    renderPlaylists();
    renderSongs();
    renderQueue();
    updatePlaybackInfo();
    allSongsBtn.classList.remove('active');
  };

  // Drag and drop for songs in playlist
  function enableDragDrop() {
    let draggedIndex = null;

    songList.querySelectorAll('tr').forEach(row => {
      row.draggable = true;

      row.addEventListener('dragstart', e => {
        draggedIndex = Number(row.dataset.index);
        e.dataTransfer.effectAllowed = 'move';
      });

      row.addEventListener('dragover', e => {
        e.preventDefault();
        row.style.borderTop = '2px solid #007aff';
      });

      row.addEventListener('dragleave', e => {
        row.style.borderTop = '';
      });

      row.addEventListener('drop', e => {
        e.preventDefault();
        row.style.borderTop = '';
        const targetIndex = Number(row.dataset.index);
        if (draggedIndex === null || targetIndex === draggedIndex) return;
        if (!currentPlaylist) return alert('You can only reorder songs inside a playlist');
        const playlistSongs = playlists[currentPlaylist];
        // Map filteredSongs indices to playlist indices
        const draggedSongId = filteredSongs[draggedIndex].id;
        const targetSongId = filteredSongs[targetIndex].id;
        const draggedPos = playlistSongs.indexOf(draggedSongId);
        const targetPos = playlistSongs.indexOf(targetSongId);
        if (draggedPos === -1 || targetPos === -1) return;
        playlistSongs.splice(draggedPos, 1);
        playlistSongs.splice(targetPos, 0, draggedSongId);
        renderSongs();
        enableDragDrop();
      });
    });
  }

  // FEATURES dropdown toggle and drag EQ
  featuresDropdownBtn.onclick = () => {
    featuresDropdown.classList.toggle('open');
  };

  // Dark Mode toggle
  darkModeToggle.onclick = () => {
    darkMode = !darkMode;
    if (darkMode) {
      document.body.classList.add('dark');
      darkModeToggle.textContent = 'Light Mode';
    } else {
      document.body.classList.remove('dark');
      darkModeToggle.textContent = 'Dark Mode';
    }
  };

  // Mini Player toggle
  miniPlayerToggle.onclick = () => {
    if (miniPlayer.classList.contains('show')) {
      miniPlayer.classList.remove('show');
    } else {
      miniPlayer.classList.add('show');
    }
  };

  // Mini Player controls
  miniPlayPauseBtn.onclick = () => {
    if (isPlaying) {
      audio.pause();
      isPlaying = false;
    } else {
      audio.play();
      isPlaying = true;
    }
    updateButtons();
  };
  miniPrevBtn.onclick = prevBtn.onclick;
  miniNextBtn.onclick = nextBtn.onclick;

  // Update EQ gain based on sliders
  eqFrequencies.forEach((freq, i) => {
    const slider = document.getElementById(`eq${freq}`);
    slider.addEventListener('input', e => {
      filters[i].gain.value = parseFloat(e.target.value);
    });
  });

  // Make FEATURES draggable
  (function makeDraggable(el) {
    let isDown = false, offset = [0,0];

    const header = el.querySelector('header');
    if (!header) return;

    header.style.cursor = 'grab';

    header.addEventListener('mousedown', e => {
      isDown = true;
      offset = [
        el.offsetLeft - e.clientX,
        el.offsetTop - e.clientY
      ];
      header.style.cursor = 'grabbing';
    });

    window.addEventListener('mouseup', e => {
      isDown = false;
      header.style.cursor = 'grab';
    });

    window.addEventListener('mousemove', e => {
      e.preventDefault();
      if (!isDown) return;
      el.style.left = (e.clientX + offset[0]) + 'px';
      el.style.top = (e.clientY + offset[1]) + 'px';
    });
  })(featuresDropdown);

  // Load songs from Google Drive API
  async function loadSongsFromDrive() {
    try {
      let files = [];
      let pageToken = '';
      do {
        const response = await fetch(`https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents+and+mimeType contains 'audio/' and trashed=false&key=${API_KEY}&fields=nextPageToken,files(id,name,mimeType,thumbnailLink,modifiedTime,videoMediaMetadata)&pageSize=1000&pageToken=${pageToken}`);
        if (!response.ok) {
          throw new Error(`Drive API error ${response.status}`);
        }
        const data = await response.json();
        files = files.concat(data.files);
        pageToken = data.nextPageToken || '';
      } while (pageToken);

      allSongs = files.map(f => {
        // Extract metadata from filename "Artist - Song.mp3" if possible
        let artist = '';
        let name = f.name.replace(/\.[^/.]+$/, "");
        if (name.includes(' - ')) {
          [artist, name] = name.split(' - ', 2);
        }
        return {
          id: f.id,
          name: name,
          artist: artist,
          album: '',
          duration: 0, // Will update later
          url: `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media&key=${API_KEY}`,
        };
      });

      // Initialize filteredSongs and render
      filteredSongs = allSongs.slice();
      renderSongs();

      // Try to load duration metadata by loading audio blobs
      for(let song of allSongs) {
        try {
          const headResp = await fetch(song.url, { method: 'HEAD' });
          if (headResp.ok) {
            // We can't get duration from HEAD so skip this
          }
          // For duration, we rely on audio element loadedmetadata event when playing
        } catch(e) {}
      }

    } catch (error) {
      alert('Failed to load songs: ' + error.message);
    }
  }

  // Init app
  async function init() {
    playlists = JSON.parse(localStorage.getItem('playlists') || '{}');
    darkMode = localStorage.getItem('darkMode') === 'true';
    if (darkMode) {
      document.body.classList.add('dark');
      darkModeToggle.textContent = 'Light Mode';
    }
    currentPlaylist = null;
    allSongsBtn.classList.add('active');

    await loadSongsFromDrive();
    renderPlaylists();
    renderQueue();

    // Play next automatically when ended
    audio.onended = () => {
      if (currentSongIndex + 1 < filteredSongs.length) {
        playSong(currentSongIndex + 1);
      } else {
        isPlaying = false;
        updateButtons();
      }
    };

    // Save playlists on change
    window.addEventListener('beforeunload', () => {
      localStorage.setItem('playlists', JSON.stringify(playlists));
      localStorage.setItem('darkMode', darkMode);
    });
  }

  init();

  // Listen for search debounce
  let searchTimeout;
  searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      const q = searchInput.value.toLowerCase();
      filteredSongs = allSongs.filter(song => song.name.toLowerCase().includes(q) || (song.artist && song.artist.toLowerCase().includes(q)));
      renderSongs();
      if (currentPlaylist) currentPlaylist = null; // reset to all songs after search
      allSongsBtn.classList.add('active');
      renderPlaylists();
    }, 300);
  });

  // Call enableDragDrop after rendering songs
  const observer = new MutationObserver(() => {
    enableDragDrop();
  });
  observer.observe(songList, {childList: true});
</script>
</body>
</html>
