<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>iTunes Replica Music Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Basic Reset */
    * {
      box-sizing: border-box;
    }
    body, html {
      margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background: #121212;
      color: #eee;
      display: flex;
      flex-direction: column;
      user-select: none;
      transition: background 0.3s, color 0.3s;
      overflow: hidden;
    }
    body.light {
      background: #f9f9f9;
      color: #111;
    }
    /* Layout */
    header {
      padding: 12px 20px;
      background: #181818;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #333;
    }
    body.light header {
      background: #fff;
      border-color: #ccc;
      color: #111;
    }
    header h1 {
      margin: 0;
      font-weight: 700;
      font-size: 22px;
      color: #1db954;
      user-select: text;
    }
    #toggleThemeBtn {
      background: #1db954;
      border: none;
      padding: 8px 16px;
      font-weight: 700;
      color: #000;
      border-radius: 20px;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s;
    }
    #toggleThemeBtn:hover {
      background: #17a44c;
    }
    main {
      flex: 1;
      display: flex;
      height: calc(100vh - 56px);
      overflow: hidden;
    }
    /* Sidebar */
    aside {
      width: 250px;
      background: #000;
      padding: 20px 10px;
      border-right: 1px solid #333;
      display: flex;
      flex-direction: column;
      transition: background 0.3s, color 0.3s;
    }
    body.light aside {
      background: #f0f0f0;
      border-color: #ccc;
      color: #111;
    }
    aside h2 {
      color: #1db954;
      margin: 0 0 15px 0;
      font-weight: 900;
      font-size: 22px;
      text-align: center;
      user-select: text;
    }
    aside button {
      background: none;
      border: none;
      color: #b3b3b3;
      padding: 10px 20px;
      text-align: left;
      font-size: 16px;
      cursor: pointer;
      border-radius: 6px;
      margin-bottom: 6px;
      transition: color 0.2s, background 0.2s;
    }
    aside button:hover,
    aside button.active {
      background: #1db954;
      color: #000;
      font-weight: 700;
    }
    /* Song list & controls container */
    section {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    /* Search bar */
    #searchBar {
      padding: 10px 20px;
      border-bottom: 1px solid #333;
      background: #181818;
      transition: background 0.3s;
    }
    body.light #searchBar {
      background: #fff;
      border-color: #ccc;
    }
    #searchInput {
      width: 100%;
      padding: 8px 12px;
      font-size: 16px;
      border-radius: 20px;
      border: none;
      background: #282828;
      color: #eee;
      outline: none;
      transition: background 0.3s, color 0.3s;
    }
    body.light #searchInput {
      background: #eee;
      color: #111;
    }
    /* Songs table */
    #songTableContainer {
      flex: 1;
      overflow-y: auto;
      background: #121212;
      transition: background 0.3s;
    }
    body.light #songTableContainer {
      background: #f9f9f9;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      user-select: none;
      min-width: 600px;
    }
    thead tr {
      border-bottom: 1px solid #333;
    }
    body.light thead tr {
      border-color: #ccc;
    }
    thead th {
      color: #bbb;
      padding: 12px 15px;
      font-weight: 600;
      text-align: left;
      font-size: 13px;
      user-select: text;
      cursor: default;
    }
    tbody tr {
      border-bottom: 1px solid #282828;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    body.light tbody tr {
      border-color: #ddd;
    }
    tbody tr:hover {
      background: #1db954;
      color: #000;
      font-weight: 700;
    }
    tbody tr.selected {
      background: #1db954;
      color: #000;
      font-weight: 700;
    }
    tbody td {
      padding: 12px 15px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      font-size: 14px;
    }
    td.duration {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    /* Now Playing bar */
    #nowPlayingBar {
      height: 110px;
      background: #181818;
      border-top: 1px solid #333;
      color: #eee;
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 20px;
      user-select: none;
      transition: background 0.3s, color 0.3s;
      flex-wrap: wrap;
    }
    body.light #nowPlayingBar {
      background: #f9f9f9;
      border-color: #ccc;
      color: #111;
    }
    #nowPlayingInfo {
      flex: 1;
      min-width: 220px;
      overflow: hidden;
    }
    #nowPlayingTitle {
      font-weight: 700;
      font-size: 20px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }
    #nowPlayingArtistAlbum {
      font-size: 14px;
      color: #888;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    body.light #nowPlayingArtistAlbum {
      color: #666;
    }
    /* Controls */
    #playerControls {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-shrink: 0;
    }
    #playerControls button {
      background: none;
      border: none;
      color: inherit;
      font-size: 28px;
      cursor: pointer;
      transition: color 0.3s;
      user-select: none;
      padding: 4px 8px;
    }
    #playerControls button:hover {
      color: #1db954;
    }
    /* Progress bar */
    #progressContainer {
      flex-grow: 2;
      min-width: 250px;
      user-select: none;
      display: flex;
      flex-direction: column;
    }
    #progressBar {
      width: 100%;
      height: 6px;
      background: #333;
      border-radius: 4px;
      cursor: pointer;
      position: relative;
      margin-bottom: 6px;
    }
    #progressFilled {
      height: 100%;
      background: #1db954;
      border-radius: 4px;
      width: 0%;
      transition: width 0.1s linear;
    }
    #timeContainer {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #888;
    }
    body.light #timeContainer {
      color: #666;
    }
    /* Volume */
    #volumeContainer {
      width: 150px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #volumeIcon {
      font-size: 22px;
    }
    #volumeSlider {
      flex-grow: 1;
      cursor: pointer;
    }
    /* Equalizer button */
    #eqToggleBtn {
      background: #1db954;
      border: none;
      color: #000;
      padding: 6px 14px;
      border-radius: 18px;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s;
    }
    #eqToggleBtn:hover {
      background: #17a44c;
    }
    /* Draggable Equalizer box */
    #eqBox {
      position: fixed;
      bottom: 130px;
      right: 20px;
      width: 300px;
      background: #181818;
      border: 1px solid #1db954;
      border-radius: 12px;
      padding: 15px;
      color: #eee;
      box-shadow: 0 0 15px #1db954aa;
      display: none;
      user-select: none;
      z-index: 1000;
    }
    body.light #eqBox {
      background: #f9f9f9;
      color: #111;
      border-color: #17a44c;
      box-shadow: 0 0 15px #17a44caa;
    }
    #eqBox header {
      cursor: move;
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 10px;
      user-select: none;
    }
    .eqSliderContainer {
      display: flex;
      flex-direction: column;
      margin-bottom: 12px;
    }
    .eqSliderContainer label {
      font-size: 14px;
      margin-bottom: 4px;
      user-select: text;
    }
    .eqSliderContainer input[type=range] {
      width: 100%;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <h1>iTunes Replica</h1>
    <button id="toggleThemeBtn">Toggle Light/Dark</button>
  </header>

  <main>
    <aside>
      <h2>Library</h2>
      <button id="btnLoadSongs" class="active">All Songs</button>
      <!-- Add playlists here if desired -->
    </aside>

    <section>
      <div id="searchBar">
        <input id="searchInput" type="search" placeholder="Search songs..." autocomplete="off" />
      </div>
      <div id="songTableContainer">
        <table id="songTable" cellspacing="0" cellpadding="0" aria-label="Songs list">
          <thead>
            <tr>
              <th class="name">Title</th>
              <th class="artist">Artist</th>
              <th class="album">Album</th>
              <th class="duration">Duration</th>
            </tr>
          </thead>
          <tbody id="songTableBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="nowPlayingBar">
    <div id="nowPlayingInfo">
      <div id="nowPlayingTitle">No song playing</div>
      <div id="nowPlayingArtistAlbum"></div>
    </div>
    <div id="playerControls">
      <button id="btnPrev" title="Previous">‚èÆÔ∏è</button>
      <button id="btnPlayPause" title="Play/Pause">‚ñ∂Ô∏è</button>
      <button id="btnNext" title="Next">‚è≠Ô∏è</button>
      <button id="eqToggleBtn" title="Equalizer">EQ</button>
    </div>
    <div id="progressContainer">
      <div id="progressBar" aria-label="Progress Bar" role="progressbar" tabindex="0">
        <div id="progressFilled"></div>
      </div>
      <div id="timeContainer">
        <span id="currentTime">0:00</span>
        <span id="durationTime">0:00</span>
      </div>
    </div>
    <div id="volumeContainer">
      <div id="volumeIcon">üîä</div>
      <input id="volumeSlider" type="range" min="0" max="1" step="0.01" value="0.7" aria-label="Volume Slider" />
    </div>
  </div>

  <!-- Equalizer draggable box -->
  <div id="eqBox" role="dialog" aria-modal="true" aria-labelledby="eqHeader" tabindex="0">
    <header id="eqHeader">Equalizer</header>
    <div class="eqSliderContainer">
      <label for="bassSlider">Bass</label>
      <input type="range" id="bassSlider" min="-15" max="15" value="0" />
    </div>
    <div class="eqSliderContainer">
      <label for="trebleSlider">Treble</label>
      <input type="range" id="trebleSlider" min="-15" max="15" value="0" />
    </div>
  </div>

  <audio id="audio" crossorigin="anonymous"></audio>

  <script>
    const API_KEY = 'AIzaSyDsYE91wH7UDwu8eZNbD1CFuVcilgYeZhI';
    const FOLDER_ID = '1DGz9zEQh29EAqTZpmWK5mwSj5HComnkn';

    // DOM elements
    const body = document.body;
    const toggleThemeBtn = document.getElementById('toggleThemeBtn');
    const btnLoadSongs = document.getElementById('btnLoadSongs');
    const searchInput = document.getElementById('searchInput');
    const songTableBody = document.getElementById('songTableBody');
    const nowPlayingTitle = document.getElementById('nowPlayingTitle');
    const nowPlayingArtistAlbum = document.getElementById('nowPlayingArtistAlbum');
    const audio = document.getElementById('audio');
    const btnPlayPause = document.getElementById('btnPlayPause');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const progressBar = document.getElementById('progressBar');
    const progressFilled = document.getElementById('progressFilled');
    const currentTimeEl = document.getElementById('currentTime');
    const durationTimeEl = document.getElementById('durationTime');
    const volumeSlider = document.getElementById('volumeSlider');
    const eqToggleBtn = document.getElementById('eqToggleBtn');
    const eqBox = document.getElementById('eqBox');
    const bassSlider = document.getElementById('bassSlider');
    const trebleSlider = document.getElementById('trebleSlider');
    const eqHeader = document.getElementById('eqHeader');

    let tracks = [];
    let filteredTracks = [];
    let currentTrackIndex = -1;
    let isPlaying = false;

    // Audio Context & EQ nodes
    let audioCtx, sourceNode, bassFilter, trebleFilter;

    // Initialize
    function init() {
      loadAllSongs();
      setupEventListeners();
      setupAudioContext();
      updateVolume(volumeSlider.value);
    }

    // Fetch songs from Google Drive folder
    async function loadAllSongs(pageToken = '') {
      try {
        let allFiles = [];
        let nextPageToken = pageToken;

        do {
          const query = encodeURIComponent(`'${FOLDER_ID}' in parents and trashed=false and (mimeType contains 'audio/')`);
          let url = `https://www.googleapis.com/drive/v3/files?q=${query}&fields=nextPageToken,files(id,name,mimeType)&pageSize=100&key=${API_KEY}`;
          if (nextPageToken) url += `&pageToken=${nextPageToken}`;

          const res = await fetch(url);
          const data = await res.json();

          if (data.files) {
            allFiles = allFiles.concat(data.files);
          }
          nextPageToken = data.nextPageToken;
        } while (nextPageToken);

        // Sort alphabetically
        allFiles.sort((a, b) => a.name.localeCompare(b.name));
        tracks = allFiles.map(file => ({
          id: file.id,
          name: file.name,
          artist: 'Unknown Artist',
          album: 'Unknown Album',
          duration: 0,
          url: `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media&key=${API_KEY}`
        }));
        filteredTracks = [...tracks];
        renderSongList();
      } catch (e) {
        alert('Failed to load songs from Google Drive API.');
        console.error(e);
      }
    }

    // Render song list
    function renderSongList() {
      songTableBody.innerHTML = '';
      filteredTracks.forEach((track, idx) => {
        const tr = document.createElement('tr');
        tr.className = idx === currentTrackIndex ? 'selected' : '';
        tr.tabIndex = 0;
        tr.title = `${track.name} - ${track.artist} (${track.album})`;
        tr.innerHTML = `
          <td class="name">${track.name}</td>
          <td class="artist">${track.artist}</td>
          <td class="album">${track.album}</td>
          <td class="duration">${formatDuration(track.duration)}</td>
        `;
        tr.onclick = () => playTrack(idx);
        tr.onkeypress = (e) => { if (e.key === 'Enter') playTrack(idx); };
        songTableBody.appendChild(tr);
      });
    }

    // Format duration seconds -> mm:ss
    function formatDuration(seconds) {
      if (!seconds || isNaN(seconds)) return '0:00';
      const m = Math.floor(seconds / 60);
      const s = Math.floor(seconds % 60);
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    // Play selected track
    async function playTrack(index) {
      if (index < 0 || index >= filteredTracks.length) return;
      currentTrackIndex = index;
      const track = filteredTracks[currentTrackIndex];
      // Load audio
      audio.src = track.url;
      try {
        await audio.play();
        isPlaying = true;
        updateNowPlaying(track);
        renderSongList();
        btnPlayPause.textContent = '‚è∏Ô∏è';
      } catch (e) {
        console.error('Playback failed:', e);
      }
    }

    // Update Now Playing UI
    function updateNowPlaying(track) {
      nowPlayingTitle.textContent = track.name;
      nowPlayingArtistAlbum.textContent = `${track.artist} ‚Äî ${track.album}`;
    }

    // Play or pause toggle
    function togglePlayPause() {
      if (!audio.src) return;
      if (isPlaying) {
        audio.pause();
        btnPlayPause.textContent = '‚ñ∂Ô∏è';
      } else {
        audio.play();
        btnPlayPause.textContent = '‚è∏Ô∏è';
      }
      isPlaying = !isPlaying;
    }

    // Play previous track
    function playPrev() {
      if (currentTrackIndex === -1) return;
      let newIndex = currentTrackIndex - 1;
      if (newIndex < 0) newIndex = filteredTracks.length - 1;
      playTrack(newIndex);
    }

    // Play next track
    function playNext() {
      if (currentTrackIndex === -1) return;
      let newIndex = currentTrackIndex + 1;
      if (newIndex >= filteredTracks.length) newIndex = 0;
      playTrack(newIndex);
    }

    // Update progress bar UI
    function updateProgress() {
      if (!audio.duration) return;
      const percent = (audio.currentTime / audio.duration) * 100;
      progressFilled.style.width = `${percent}%`;
      currentTimeEl.textContent = formatDuration(audio.currentTime);
      durationTimeEl.textContent = formatDuration(audio.duration);
    }

    // Seek audio when clicking progress bar
    function seekAudio(e) {
      const rect = progressBar.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const percent = clickX / rect.width;
      audio.currentTime = percent * audio.duration;
    }

    // Search filter songs
    function filterSongs() {
      const val = searchInput.value.toLowerCase();
      filteredTracks = tracks.filter(t => 
        t.name.toLowerCase().includes(val) || 
        t.artist.toLowerCase().includes(val) ||
        t.album.toLowerCase().includes(val)
      );
      renderSongList();
    }

    // Toggle theme
    function toggleTheme() {
      body.classList.toggle('light');
    }

    // Volume control
    function updateVolume(val) {
      audio.volume = val;
    }

    // Setup audio context & equalizer
    function setupAudioContext() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      sourceNode = audioCtx.createMediaElementSource(audio);
      bassFilter = audioCtx.createBiquadFilter();
      bassFilter.type = "lowshelf";
      bassFilter.frequency.setValueAtTime(200, audioCtx.currentTime);
      trebleFilter = audioCtx.createBiquadFilter();
      trebleFilter.type = "highshelf";
      trebleFilter.frequency.setValueAtTime(2000, audioCtx.currentTime);
      sourceNode.connect(bassFilter);
      bassFilter.connect(trebleFilter);
      trebleFilter.connect(audioCtx.destination);
    }

    // Update EQ filters
    function updateEQ() {
      bassFilter.gain.setValueAtTime(bassSlider.value, audioCtx.currentTime);
      trebleFilter.gain.setValueAtTime(trebleSlider.value, audioCtx.currentTime);
    }

    // Draggable EQ box
    function makeDraggable(elem, handle) {
      let posX = 0, posY = 0, mouseX = 0, mouseY = 0;
      handle.onmousedown = dragMouseDown;

      function dragMouseDown(e) {
        e.preventDefault();
        mouseX = e.clientX;
        mouseY = e.clientY;
        document.onmouseup = closeDrag;
        document.onmousemove = elementDrag;
      }

      function elementDrag(e) {
        e.preventDefault();
        posX = mouseX - e.clientX;
        posY = mouseY - e.clientY;
        mouseX = e.clientX;
        mouseY = e.clientY;
        elem.style.top = (elem.offsetTop - posY) + "px";
        elem.style.left = (elem.offsetLeft - posX) + "px";
      }

      function closeDrag() {
        document.onmouseup = null;
        document.onmousemove = null;
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      toggleThemeBtn.addEventListener('click', toggleTheme);
      btnLoadSongs.addEventListener('click', () => {
        filteredTracks = [...tracks];
        renderSongList();
      });
      searchInput.addEventListener('input', filterSongs);
      btnPlayPause.addEventListener('click', togglePlayPause);
      btnPrev.addEventListener('click', playPrev);
      btnNext.addEventListener('click', playNext);
      audio.addEventListener('timeupdate', updateProgress);
      audio.addEventListener('ended', playNext);
      progressBar.addEventListener('click', seekAudio);
      volumeSlider.addEventListener('input', e => updateVolume(e.target.value));
      eqToggleBtn.addEventListener('click', () => {
        eqBox.style.display = eqBox.style.display === 'block' ? 'none' : 'block';
        if (eqBox.style.display === 'block') {
          if (audioCtx.state === 'suspended') {
            audioCtx.resume();
          }
        }
      });
      bassSlider.addEventListener('input', updateEQ);
      trebleSlider.addEventListener('input', updateEQ);

      // Make EQ draggable by header
      makeDraggable(eqBox, eqHeader);
    }

    // Start app
    init();
  </script>
</body>
</html>
