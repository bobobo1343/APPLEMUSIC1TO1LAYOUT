<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>iTunes Laptop Replica Player</title>
<style>
  /* Reset */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    background: #f2f2f5;
    color: #1c1c1e;
    user-select: none;
    overflow: hidden;
  }
  a {
    color: inherit;
    text-decoration: none;
  }
  button {
    cursor: pointer;
    background: none;
    border: none;
    font-weight: 600;
    font-size: 14px;
    color: #007aff;
    transition: color 0.2s ease;
  }
  button:hover {
    color: #0051a8;
  }
  /* Layout */
  #app {
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }
  /* Header */
  header {
    height: 44px;
    background: #f9f9f9;
    border-bottom: 1px solid #c7c7cc;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 17px;
    color: #1c1c1e;
    user-select: none;
  }
  /* Main Content */
  #main {
    flex: 1;
    display: flex;
    background: white;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
  }
  /* Sidebar */
  #sidebar {
    width: 240px;
    border-right: 1px solid #c7c7cc;
    background: #f9f9f9;
    padding: 20px 12px;
    display: flex;
    flex-direction: column;
  }
  #sidebar h2 {
    font-weight: 700;
    font-size: 22px;
    color: #1c1c1e;
    margin: 0 0 24px;
    user-select: none;
  }
  #sidebar button, #sidebar .playlist-btn {
    text-align: left;
    padding: 10px 14px;
    margin-bottom: 6px;
    border-radius: 6px;
    border: none;
    background: none;
    color: #007aff;
    font-weight: 600;
    font-size: 15px;
    transition: background 0.3s ease;
  }
  #sidebar button.active, #sidebar .playlist-btn.active, #sidebar button:hover, #sidebar .playlist-btn:hover {
    background: #007aff;
    color: white;
  }
  #playlist-controls {
    margin-top: auto;
  }
  #newPlaylistInput {
    width: calc(100% - 42px);
    padding: 8px 10px;
    border: 1px solid #c7c7cc;
    border-radius: 6px;
    font-size: 14px;
    margin-bottom: 6px;
    outline-offset: -2px;
  }
  #addPlaylistBtn {
    width: 36px;
    height: 36px;
    font-size: 24px;
    line-height: 0;
    color: #007aff;
    border-radius: 6px;
    border: 1px solid #c7c7cc;
    background: none;
    margin-left: 6px;
    vertical-align: top;
    transition: background 0.3s ease, color 0.3s ease;
  }
  #addPlaylistBtn:hover {
    background: #007aff;
    color: white;
    border-color: #007aff;
  }
  #playlist-create {
    display: flex;
    align-items: center;
  }
  /* Library */
  #library {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: white;
  }
  #library-header {
    border-bottom: 1px solid #c7c7cc;
    padding: 10px 20px;
    display: flex;
    align-items: center;
  }
  #searchInput {
    flex-grow: 1;
    border: 1px solid #c7c7cc;
    border-radius: 12px;
    padding: 6px 12px;
    font-size: 14px;
    color: #1c1c1e;
    outline-offset: -2px;
  }
  #featuresDropdownBtn {
    margin-left: 20px;
    position: relative;
    font-weight: 700;
    border-radius: 14px;
    padding: 6px 14px;
    border: 1px solid #c7c7cc;
    background: white;
    user-select: none;
  }
  #featuresDropdownBtn:hover {
    background: #e0e0e0;
  }
  /* Dropdown container */
  #featuresDropdown {
    position: absolute;
    top: 48px;
    right: 0;
    width: 280px;
    background: white;
    border: 1px solid #c7c7cc;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    display: none;
    padding: 16px;
    z-index: 100;
  }
  #featuresDropdown.open {
    display: block;
  }
  /* Song Table */
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    color: #1c1c1e;
    user-select: none;
  }
  thead tr {
    border-bottom: 1px solid #c7c7cc;
  }
  th, td {
    padding: 12px 20px;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  th.name, td.name {
    width: 40%;
  }
  th.artist, td.artist {
    width: 25%;
  }
  th.album, td.album {
    width: 25%;
  }
  th.duration, td.duration {
    width: 10%;
    text-align: right;
    font-variant-numeric: tabular-nums;
  }
  tbody tr {
    cursor: pointer;
    transition: background 0.2s ease;
  }
  tbody tr:hover {
    background: #d0e7ff;
  }
  tbody tr.selected {
    background: #007aff;
    color: white;
  }
  tbody {
    display: block;
    height: calc(100% - 44px);
    overflow-y: auto;
  }
  thead, tbody tr {
    display: table;
    width: 100%;
    table-layout: fixed;
  }
  /* Queue / Up Next Sidebar */
  #queue {
    width: 300px;
    border-left: 1px solid #c7c7cc;
    background: #f9f9f9;
    padding: 20px 12px;
    display: flex;
    flex-direction: column;
  }
  #queue h3 {
    font-weight: 700;
    font-size: 18px;
    margin: 0 0 20px;
    user-select: none;
    color: #1c1c1e;
  }
  #queueList {
    flex-grow: 1;
    overflow-y: auto;
  }
  .queue-item {
    padding: 10px 14px;
    margin-bottom: 6px;
    border-radius: 6px;
    cursor: pointer;
    color: #007aff;
    transition: background 0.2s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .queue-item:hover {
    background: #d0e7ff;
  }
  .queue-item.selected {
    background: #007aff;
    color: white;
    font-weight: 700;
  }
  /* Playback Bar */
  #playbackBar {
    height: 72px;
    background: #f9f9f9;
    border-top: 1px solid #c7c7cc;
    display: flex;
    align-items: center;
    padding: 0 24px;
    gap: 18px;
    user-select: none;
    position: relative;
  }
  #playbackInfo {
    flex-shrink: 0;
    width: 300px;
    overflow: hidden;
  }
  #playbackTitle {
    font-weight: 700;
    font-size: 16px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #playbackArtist {
    font-size: 13px;
    color: #6e6e73;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #playbackControls {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-shrink: 0;
  }
  #playbackControls button {
    font-size: 24px;
    color: #007aff;
    background: none;
    border: none;
    cursor: pointer;
    transition: color 0.2s ease;
    user-select: none;
  }
  #playbackControls button:hover {
    color: #004e8a;
  }
  #progressContainer {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    user-select: none;
  }
  #progressBar {
    width: 100%;
    height: 6px;
    background: #d0d0d6;
    border-radius: 3px;
    cursor: pointer;
    position: relative;
  }
  #progressFilled {
    height: 100%;
    background: #007aff;
    width: 0%;
    border-radius: 3px;
    transition: width 0.1s linear;
  }
  #timeDisplay {
    margin-top: 4px;
    font-size: 12px;
    color: #6e6e73;
    display: flex;
    justify-content: space-between;
    user-select: none;
  }
  #volumeControl {
    width: 120px;
  }
  #volumeSlider {
    width: 100%;
    cursor: pointer;
  }
  /* Mini Player */
  #miniPlayerToggle {
    margin-left: 24px;
    color: #007aff;
    border: 1px solid #007aff;
    border-radius: 14px;
    padding: 6px 14px;
    font-weight: 700;
    background: none;
    user-select: none;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  #miniPlayerToggle:hover {
    background: #007aff;
    color: white;
  }
  /* Mini Player Style */
  #miniPlayer {
    position: fixed;
    bottom: 80px;
    right: 24px;
    width: 320px;
    height: 60px;
    background: white;
    border: 1px solid #c7c7cc;
    border-radius: 14px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    display: none;
    align-items: center;
    padding: 0 20px;
    gap: 16px;
    user-select: none;
    z-index: 200;
  }
  #miniPlayer.show {
    display: flex;
  }
  #miniTitle {
    font-weight: 700;
    font-size: 14px;
    color: #1c1c1e;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex-grow: 1;
  }
  #miniArtist {
    font-size: 12px;
    color: #6e6e73;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  #miniControls button {
    font-size: 20px;
    color: #007aff;
    background: none;
    border: none;
    cursor: pointer;
  }
  #miniControls button:hover {
    color: #004e8a;
  }
  /* EQ sliders */
  .eq-slider {
    width: 100%;
  }
  .eq-label {
    font-size: 12px;
    color: #1c1c1e;
    margin-bottom: 4px;
    font-weight: 600;
  }
  .eq-row {
    margin-bottom: 14px;
  }
</style>
</head>
<body>
<div id="app">
  <header>Music</header>
  <div id="main">
    <nav id="sidebar">
      <h2>Library</h2>
      <button id="allSongsBtn" class="active">All Songs</button>
      <div id="playlists"></div>
      <div id="playlist-create">
        <input id="newPlaylistInput" type="text" placeholder="New playlist name..." />
        <button id="addPlaylistBtn" title="Add playlist">+</button>
      </div>
    </nav>

    <section id="library">
      <div id="library-header">
        <input id="searchInput" type="search" placeholder="Search" />
        <button id="featuresDropdownBtn" title="Features">FEATURES ▼</button>
        <div id="featuresDropdown" tabindex="0" aria-hidden="true">
          <div><strong>Equalizer</strong></div>
          <div id="eqControls">
            <!-- Sliders will be inserted here -->
          </div>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th class="name">Name</th>
            <th class="artist">Artist</th>
            <th class="album">Album</th>
            <th class="duration">Duration</th>
          </tr>
        </thead>
        <tbody id="songList"></tbody>
      </table>
    </section>

    <aside id="queue">
      <h3>Up Next</h3>
      <div id="queueList"></div>
    </aside>
  </div>

  <footer id="playbackBar">
    <div id="playbackInfo">
      <div id="playbackTitle">No song selected</div>
      <div id="playbackArtist"></div>
    </div>
    <div id="playbackControls">
      <button id="prevBtn" title="Previous">⏮️</button>
      <button id="playPauseBtn" title="Play/Pause">▶️</button>
      <button id="nextBtn" title="Next">⏭️</button>
    </div>
    <div id="progressContainer">
      <div id="progressBar" aria-label="Playback progress bar" role="progressbar" tabindex="0">
        <div id="progressFilled"></div>
      </div>
      <div id="timeDisplay"><span id="currentTime">0:00</span><span id="duration">0:00</span></div>
    </div>
    <div id="volumeControl">
      <input id="volumeSlider" type="range" min="0" max="1" step="0.01" value="0.5" aria-label="Volume control"/>
    </div>
    <button id="miniPlayerToggle" title="Toggle Mini Player">Mini Player</button>
  </footer>

  <div id="miniPlayer" aria-label="Mini music player">
    <div id="miniTitle">No song selected</div>
    <div id="miniArtist"></div>
    <div id="miniControls">
      <button id="miniPrev" title="Previous">⏮️</button>
      <button id="miniPlayPause" title="Play/Pause">▶️</button>
      <button id="miniNext" title="Next">⏭️</button>
    </div>
  </div>
</div>

<audio id="audio" preload="metadata"></audio>

<script>
  // Replace these with your actual Google Drive API Key & Folder ID
  const API_KEY = 'AIzaSyDsYE91wH7UDwu8eZNbD1CFuVcilgYeZhI';
  const FOLDER_ID = '1DGz9zEQh29EAqTZpmWK5mwSj5HComnkn';

  // DOM Elements
  const audio = document.getElementById('audio');
  const songListEl = document.getElementById('songList');
  const searchInput = document.getElementById('searchInput');
  const allSongsBtn = document.getElementById('allSongsBtn');
  const playlistsContainer = document.getElementById('playlists');
  const addPlaylistBtn = document.getElementById('addPlaylistBtn');
  const newPlaylistInput = document.getElementById('newPlaylistInput');
  const queueList = document.getElementById('queueList');
  const playbackTitle = document.getElementById('playbackTitle');
  const playbackArtist = document.getElementById('playbackArtist');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const progressBar = document.getElementById('progressBar');
  const progressFilled = document.getElementById('progressFilled');
  const currentTimeEl = document.getElementById('currentTime');
  const durationEl = document.getElementById('duration');
  const volumeSlider = document.getElementById('volumeSlider');
  const featuresDropdownBtn = document.getElementById('featuresDropdownBtn');
  const featuresDropdown = document.getElementById('featuresDropdown');
  const eqControls = document.getElementById('eqControls');
  const miniPlayerToggle = document.getElementById('miniPlayerToggle');
  const miniPlayer = document.getElementById('miniPlayer');
  const miniTitle = document.getElementById('miniTitle');
  const miniArtist = document.getElementById('miniArtist');
  const miniPlayPause = document.getElementById('miniPlayPause');
  const miniPrev = document.getElementById('miniPrev');
  const miniNext = document.getElementById('miniNext');

  // State
  let allSongs = [];
  let filteredSongs = [];
  let playlists = {}; // playlistName -> array of song objects
  let currentPlaylist = null; // null = all songs
  let currentSongIndex = -1;
  let isPlaying = false;

  // Audio context & EQ
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  const audioContext = new AudioContext();
  const sourceNode = audioContext.createMediaElementSource(audio);
  const eqBands = [
    { freq: 32, type: "lowshelf" },
    { freq: 64, type: "peaking" },
    { freq: 125, type: "peaking" },
    { freq: 250, type: "peaking" },
    { freq: 500, type: "peaking" },
    { freq: 1000, type: "peaking" },
    { freq: 2000, type: "peaking" },
    { freq: 4000, type: "peaking" },
    { freq: 8000, type: "peaking" },
    { freq: 16000, type: "highshelf" }
  ];
  const eqNodes = eqBands.map(band => {
    const filter = audioContext.createBiquadFilter();
    filter.type = band.type;
    filter.frequency.value = band.freq;
    filter.gain.value = 0;
    return filter;
  });

  // Connect EQ chain
  sourceNode.connect(eqNodes[0]);
  for(let i=0; i < eqNodes.length-1; i++) {
    eqNodes[i].connect(eqNodes[i+1]);
  }
  eqNodes[eqNodes.length-1].connect(audioContext.destination);

  // Build EQ UI
  function createEQUI() {
    eqControls.innerHTML = '';
    eqNodes.forEach((node, i) => {
      const band = eqBands[i];
      const row = document.createElement('div');
      row.className = 'eq-row';

      const label = document.createElement('label');
      label.className = 'eq-label';
      label.textContent = band.freq + ' Hz';
      label.htmlFor = 'eqSlider' + i;

      const input = document.createElement('input');
      input.type = 'range';
      input.min = -12;
      input.max = 12;
      input.value = 0;
      input.step = 0.1;
      input.className = 'eq-slider';
      input.id = 'eqSlider' + i;
      input.title = `Adjust ${band.freq} Hz`;
      input.oninput = () => {
        node.gain.value = input.value;
      };

      row.appendChild(label);
      row.appendChild(input);
      eqControls.appendChild(row);
    });
  }
  createEQUI();

  // Format seconds as mm:ss
  function formatDuration(seconds) {
    if (isNaN(seconds)) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return mins + ':' + (secs < 10 ? '0' : '') + secs;
  }

  // Render songs in table
  function renderSongs() {
    songListEl.innerHTML = '';
    filteredSongs.forEach((song, idx) => {
      const tr = document.createElement('tr');
      tr.classList.toggle('selected', idx === currentSongIndex);
      tr.draggable = true;
      tr.dataset.index = idx;
      tr.onclick = () => {
        playSong(idx);
      };
      // Drag & drop handlers for playlist reorder
      tr.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', idx);
        e.currentTarget.style.opacity = '0.5';
      });
      tr.addEventListener('dragend', e => {
        e.currentTarget.style.opacity = '';
      });
      tr.addEventListener('dragover', e => {
        e.preventDefault();
        const draggingOver = e.currentTarget;
        draggingOver.style.borderTop = '2px solid #007aff';
      });
      tr.addEventListener('dragleave', e => {
        e.currentTarget.style.borderTop = '';
      });
      tr.addEventListener('drop', e => {
        e.preventDefault();
        const draggedIndex = +e.dataTransfer.getData('text/plain');
        const targetIndex = +e.currentTarget.dataset.index;
        if (draggedIndex === targetIndex) return;
        // Reorder filteredSongs array
        const movedSong = filteredSongs.splice(draggedIndex, 1)[0];
        filteredSongs.splice(targetIndex, 0, movedSong);
        renderSongs();
      });

      tr.innerHTML = `
        <td class="name">${song.name}</td>
        <td class="artist">${song.artist || ''}</td>
        <td class="album">${song.album || ''}</td>
        <td class="duration">${formatDuration(song.duration)}</td>
      `;
      songListEl.appendChild(tr);
    });
  }

  // Play song by index in filteredSongs
  function playSong(index) {
    if (index < 0 || index >= filteredSongs.length) return;
    currentSongIndex = index;
    const song = filteredSongs[index];
    audio.src = song.url;
    if(audioContext.state === 'suspended') {
      audioContext.resume();
    }
    audio.play();
    isPlaying = true;
    updatePlaybackInfo();
    renderSongs();
    renderQueue();
    updateMiniPlayer();
  }

  // Update playback info UI
  function updatePlaybackInfo() {
    if(currentSongIndex === -1) {
      playbackTitle.textContent = "No song selected";
      playbackArtist.textContent = "";
      miniTitle.textContent = playbackTitle.textContent;
      miniArtist.textContent = playbackArtist.textContent;
      return;
    }
    const song = filteredSongs[currentSongIndex];
    playbackTitle.textContent = song.name;
    playbackArtist.textContent = song.artist || '';
    miniTitle.textContent = playbackTitle.textContent;
    miniArtist.textContent = playbackArtist.textContent;
  }

  // Render Up Next queue (same order as filteredSongs)
  function renderQueue() {
    queueList.innerHTML = '';
    filteredSongs.forEach((song, idx) => {
      const div = document.createElement('div');
      div.className = 'queue-item' + (idx === currentSongIndex ? ' selected' : '');
      div.textContent = song.name;
      div.title = `${song.artist || ''} - ${song.album || ''}`;
      div.onclick = () => {
        playSong(idx);
      };
      queueList.appendChild(div);
    });
  }

  // Playback controls
  playPauseBtn.onclick = () => {
    if (audio.paused) {
      audio.play();
      isPlaying = true;
      updateButtons();
    } else {
      audio.pause();
      isPlaying = false;
      updateButtons();
    }
  };
  prevBtn.onclick = () => {
    if(currentSongIndex > 0) playSong(currentSongIndex - 1);
  };
  nextBtn.onclick = () => {
    if(currentSongIndex +1 < filteredSongs.length) playSong(currentSongIndex +1);
  };

  // Mini player controls
  miniPlayPause.onclick = playPauseBtn.onclick;
  miniPrev.onclick = prevBtn.onclick;
  miniNext.onclick = nextBtn.onclick;

  // Update play/pause button icons
  function updateButtons() {
    if(isPlaying) {
      playPauseBtn.textContent = '⏸️';
      miniPlayPause.textContent = '⏸️';
    } else {
      playPauseBtn.textContent = '▶️';
      miniPlayPause.textContent = '▶️';
    }
  }

  // Audio time updates
  audio.ontimeupdate = () => {
    if (!audio.duration) return;
    const percent = (audio.currentTime / audio.duration) * 100;
    progressFilled.style.width = percent + '%';
    currentTimeEl.textContent = formatDuration(audio.currentTime);
    durationEl.textContent = formatDuration(audio.duration);
  };

  // Seek audio on progress bar click
  progressBar.onclick = e => {
    const rect = progressBar.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const width = rect.width;
    const seekTime = (clickX / width) * audio.duration;
    audio.currentTime = seekTime;
  };

  // Volume control
  volumeSlider.oninput = () => {
    audio.volume = volumeSlider.value;
  };

  // Search songs
  searchInput.oninput = () => {
    const term = searchInput.value.toLowerCase();
    const baseList = currentPlaylist ? playlists[currentPlaylist] : allSongs;
    filteredSongs = baseList.filter(s =>
      s.name.toLowerCase().includes(term) ||
      (s.artist && s.artist.toLowerCase().includes(term)) ||
      (s.album && s.album.toLowerCase().includes(term))
    );
    currentSongIndex = -1;
    renderSongs();
    renderQueue();
    updatePlaybackInfo();
  };

  // Playlist buttons render
  function renderPlaylists() {
    playlistsContainer.innerHTML = '';
    for(const name in playlists) {
      const btn = document.createElement('button');
      btn.textContent = name;
      btn.className = 'playlist-btn';
      if(name === currentPlaylist) btn.classList.add('active');
      btn.onclick = () => {
        currentPlaylist = name;
        filteredSongs = playlists[name].slice();
        currentSongIndex = -1;
        searchInput.value = '';
        renderSongs();
        renderQueue();
        updatePlaybackInfo();
        renderPlaylists();
        allSongsBtn.classList.remove('active');
      };
      playlistsContainer.appendChild(btn);
    }
  }

  // All songs button
  allSongsBtn.onclick = () => {
    currentPlaylist = null;
    filteredSongs = allSongs.slice();
    currentSongIndex = -1;
    searchInput.value = '';
    renderSongs();
    renderQueue();
    updatePlaybackInfo();
    renderPlaylists();
    allSongsBtn.classList.add('active');
  };

  // Add new playlist
  addPlaylistBtn.onclick = () => {
    const name = newPlaylistInput.value.trim();
    if (!name || playlists[name]) {
      alert('Invalid or duplicate playlist name');
      return;
    }
    playlists[name] = [];
    currentPlaylist = name;
    filteredSongs = [];
    newPlaylistInput.value = '';
    renderPlaylists();
    renderSongs();
    renderQueue();
    updatePlaybackInfo();
    allSongsBtn.classList.remove('active');
  };

  // Features dropdown toggle
  featuresDropdownBtn.onclick = () => {
    featuresDropdown.classList.toggle('open');
  };

  // Close features dropdown if clicked outside
  document.addEventListener('click', e => {
    if (!featuresDropdown.contains(e.target) && e.target !== featuresDropdownBtn) {
      featuresDropdown.classList.remove('open');
    }
  });

  // Drag and drop to add songs to playlist
  songListEl.addEventListener('dragstart', e => {
    e.dataTransfer.setData('text/plain', e.target.dataset.index);
  });
  queueList.addEventListener('dragover', e => {
    e.preventDefault();
  });
  queueList.addEventListener('drop', e => {
    e.preventDefault();
    if(!currentPlaylist) {
      alert('Select or create a playlist first');
      return;
    }
    const draggedIndex = +e.dataTransfer.getData('text/plain');
    const draggedSong = filteredSongs[draggedIndex];
    if(!playlists[currentPlaylist].some(s => s.url === draggedSong.url)) {
      playlists[currentPlaylist].push(draggedSong);
      alert(`Added "${draggedSong.name}" to playlist "${currentPlaylist}"`);
    }
  });

  // Update mini player UI
  function updateMiniPlayer() {
    if(currentSongIndex === -1) {
      miniPlayer.classList.remove('show');
    } else {
      miniPlayer.classList.add('show');
    }
  }

  // Load songs from Google Drive API
  async function loadSongsFromDrive() {
    try {
      const url = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents+and+trashed=false+and+mimeType contains 'audio/'&key=${API_KEY}&fields=files(id,name,mimeType)`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`Google Drive API error ${res.status}`);
      const data = await res.json();
      const files = data.files || [];
      allSongs = files.map(f => ({
        name: f.name,
        url: `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media&key=${API_KEY}`,
        duration: 0,
        artist: '',
        album: ''
      }));

      // Load durations by loading audio metadata
      for(let song of allSongs) {
        try {
          const tempAudio = new Audio();
          tempAudio.src = song.url;
          await new Promise(res => {
            tempAudio.addEventListener('loadedmetadata', () => {
              song.duration = tempAudio.duration;
              res();
            });
          });
        } catch(e) {
          console.warn('Could not load metadata for', song.name);
        }
      }

      filteredSongs = allSongs.slice();
      currentSongIndex = -1;
      renderSongs();
      renderQueue();
      updatePlaybackInfo();

    } catch(err) {
      alert('Failed to load songs: ' + err.message);
    }
  }

  // Initialize player
  async function init() {
    renderPlaylists();
    allSongsBtn.classList.add('active');
    await loadSongsFromDrive();
  }

  // Start
  init();

</script>
</body>
</html>
