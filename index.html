<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Apple Music 1:1 Replica</title>
<style>
  /* Reset & basic */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    background-color: #121212;
    color: white;
    display: flex; flex-direction: column; height: 100vh;
  }
  /* Layout */
  .container {
    flex: 1; display: flex; overflow: hidden;
  }
  /* Sidebar */
  .sidebar {
    width: 280px;
    background-color: #000;
    padding: 24px 20px 20px;
    display: flex; flex-direction: column;
  }
  .sidebar h2 {
    color: #1DB954;
    margin-bottom: 24px;
    font-weight: 700;
    font-size: 24px;
  }
  .sidebar button {
    background: none;
    border: none;
    color: #b3b3b3;
    text-align: left;
    padding: 10px 0;
    font-size: 16px;
    cursor: pointer;
    transition: color 0.2s ease;
  }
  .sidebar button:hover {
    color: white;
  }
  .playlist-names {
    margin-top: 30px;
    overflow-y: auto;
    flex-grow: 1;
  }

  /* Main */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: linear-gradient(180deg, #181818 0%, #121212 100%);
  }
  .top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 24px;
    background-color: #181818;
  }
  #search {
    flex: 1;
    max-width: 300px;
    padding: 10px 14px;
    border-radius: 20px;
    border: none;
    background-color: #282828;
    color: white;
    font-size: 16px;
    outline: none;
  }
  /* Dark/Light toggle */
  #darkLightToggle {
    margin-left: 20px;
    cursor: pointer;
    background: none;
    border: 1.5px solid #1DB954;
    color: #1DB954;
    font-weight: 600;
    padding: 6px 14px;
    border-radius: 20px;
    user-select: none;
    transition: all 0.3s ease;
  }
  #darkLightToggle:hover {
    background-color: #1DB954;
    color: #000;
  }

  /* Content - scrollable list */
  .content {
    flex: 1;
    overflow-y: auto;
    padding: 10px 24px;
    background-color: #121212;
  }
  #track-list {
    margin-top: 10px;
  }
  .track-item {
    display: flex;
    justify-content: space-between;
    padding: 14px 20px;
    cursor: pointer;
    border-bottom: 1px solid #282828;
    align-items: center;
    transition: background-color 0.2s ease;
  }
  .track-item:hover {
    background-color: #282828;
  }
  .track-item.active {
    background-color: #1DB954;
    color: black;
  }
  .track-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .track-title {
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .track-subinfo {
    font-size: 13px;
    color: #b3b3b3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .track-duration {
    min-width: 50px;
    text-align: right;
    font-size: 13px;
    color: #b3b3b3;
  }
  /* Player bar */
  .player-bar {
    background-color: #181818;
    padding: 18px 24px;
    border-top: 1px solid #282828;
    display: flex;
    align-items: center;
    gap: 24px;
    position: relative;
  }
  .player-meta {
    flex-grow: 1;
    overflow: hidden;
  }
  .player-title {
    font-weight: 700;
    font-size: 18px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .player-artist-album {
    font-size: 14px;
    color: #b3b3b3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Controls */
  .controls {
    display: flex;
    align-items: center;
    gap: 28px;
  }
  .controls button {
    background: none;
    border: none;
    color: white;
    font-size: 26px;
    cursor: pointer;
    user-select: none;
    transition: color 0.3s ease;
  }
  .controls button:hover {
    color: #1DB954;
  }

  audio {
    width: 100%;
    outline: none;
    margin-top: 6px;
    display: none; /* hide default */
  }

  /* Features menu */
  #featuresMenu {
    position: relative;
  }
  #featuresToggle {
    background: none;
    border: none;
    color: #1DB954;
    cursor: pointer;
    font-weight: 600;
    user-select: none;
    font-size: 16px;
  }
  #featuresDropdown {
    display: none;
    position: absolute;
    top: 28px;
    right: 0;
    background: #282828;
    border: 1px solid #444;
    padding: 10px;
    border-radius: 6px;
    width: 220px;
    z-index: 1000;
  }
  #featuresDropdown.active {
    display: block;
  }

  /* EQ panel */
  #eqPanel {
    position: fixed;
    bottom: 90px;
    right: 40px;
    width: 320px;
    background: #121212dd;
    border: 1px solid #1DB954;
    padding: 12px 20px;
    border-radius: 10px;
    box-shadow: 0 0 8px #1DB954aa;
    cursor: move;
    user-select: none;
    display: none;
    flex-direction: column;
    gap: 12px;
    z-index: 2000;
  }
  #eqPanel h3 {
    margin: 0 0 8px;
    color: #1DB954;
    font-weight: 700;
    user-select: none;
  }
  .eq-slider-container {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .eq-label {
    width: 40px;
    font-size: 14px;
    color: #b3b3b3;
    user-select: none;
  }
  .eq-slider {
    flex: 1;
    -webkit-appearance: none;
    appearance: none;
    height: 6px;
    border-radius: 3px;
    background: #555;
    cursor: pointer;
  }
  .eq-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    background: #1DB954;
    border-radius: 50%;
    cursor: pointer;
    margin-top: -5px;
    transition: background 0.2s ease;
  }
  .eq-slider::-webkit-slider-thumb:hover {
    background: #17a44d;
  }
  /* Firefox */
  .eq-slider::-moz-range-thumb {
    width: 16px;
    height: 16px;
    background: #1DB954;
    border-radius: 50%;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  .eq-slider::-moz-range-thumb:hover {
    background: #17a44d;
  }

  /* Scrollbar style */
  .playlist-names::-webkit-scrollbar,
  .content::-webkit-scrollbar {
    width: 8px;
  }
  .playlist-names::-webkit-scrollbar-track,
  .content::-webkit-scrollbar-track {
    background: #121212;
  }
  .playlist-names::-webkit-scrollbar-thumb,
  .content::-webkit-scrollbar-thumb {
    background: #1DB954;
    border-radius: 4px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .container {
      flex-direction: column;
    }
    .sidebar {
      width: 100%;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: space-between;
      padding: 12px 16px;
    }
    .sidebar h2 {
      margin-bottom: 12px;
    }
    .playlist-names {
      flex-grow: 1;
      margin-top: 12px;
      max-height: 150px;
      overflow-y: auto;
      width: 100%;
    }
    .main {
      flex: 1;
    }
    .top-bar {
      padding: 10px 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    #search {
      max-width: 100%;
      flex-grow: 1;
    }
    #darkLightToggle {
      margin-left: 0;
      width: 100%;
      text-align: center;
    }
    .player-bar {
      flex-wrap: wrap;
      gap: 12px;
    }
  }
</style>
</head>
<body>

<div class="container">
  <nav class="sidebar">
    <h2>MUSIC</h2>
    <button onclick="loadAllTracks()">All Songs</button>
    <div class="playlist-names" id="playlist-names"></div>
  </nav>

  <main class="main">
    <div class="top-bar">
      <input id="search" type="text" placeholder="Search songs..." autocomplete="off" />
      <button id="darkLightToggle">Light Mode</button>
      <div id="featuresMenu">
        <button id="featuresToggle">Features ‚ñº</button>
        <div id="featuresDropdown">
          <button id="eqToggle">Equalizer / Bass Boost</button>
        </div>
      </div>
    </div>

    <div class="content" id="track-list" tabindex="0" aria-label="Track list" role="list"></div>

    <div class="player-bar" role="region" aria-label="Audio player controls">
      <div class="player-meta">
        <div class="player-title" id="playerTitle">Select a song</div>
        <div class="player-artist-album" id="playerArtistAlbum">Artist - Album</div>
      </div>

      <div class="controls">
        <button title="Previous" id="btnPrev">‚èÆÔ∏è</button>
        <button title="Play/Pause" id="btnPlayPause">‚ñ∂Ô∏è</button>
        <button title="Next" id="btnNext">‚è≠Ô∏è</button>
        <button title="Shuffle" id="btnShuffle">üîÄ</button>
      </div>

      <audio id="audio" preload="metadata"></audio>
    </div>
  </main>
</div>

<!-- Equalizer Panel -->
<div id="eqPanel" aria-label="Equalizer panel" role="region" aria-hidden="true" tabindex="-1">
  <h3>Equalizer & Bass Boost</h3>
  <div class="eq-slider-container">
    <label for="eq60" class="eq-label">60 Hz</label>
    <input type="range" id="eq60" class="eq-slider" min="-15" max="15" value="0" step="1" />
  </div>
  <div class="eq-slider-container">
    <label for="eq170" class="eq-label">170 Hz</label>
    <input type="range" id="eq170" class="eq-slider" min="-15" max="15" value="0" step="1" />
  </div>
  <div class="eq-slider-container">
    <label for="eq310" class="eq-label">310 Hz</label>
    <input type="range" id="eq310" class="eq-slider" min="-15" max="15" value="0" step="1" />
  </div>
  <div class="eq-slider-container">
    <label for="eq600" class="eq-label">600 Hz</label>
    <input type="range" id="eq600" class="eq-slider" min="-15" max="15" value="0" step="1" />
  </div>
  <div class="eq-slider-container">
    <label for="eq1k" class="eq-label">1 kHz</label>
    <input type="range" id="eq1k" class="eq-slider" min="-15" max="15" value="0" step="1" />
  </div>
  <div class="eq-slider-container">
    <label for="eq3k" class="eq-label">3 kHz</label>
    <input type="range" id="eq3k" class="eq-slider" min="-15" max="15" value="0" step="1" />
  </div>
  <div class="eq-slider-container">
    <label for="eq6k" class="eq-label">6 kHz</label>
    <input type="range" id="eq6k" class="eq-slider" min="-15" max="15" value="0" step="1" />
  </div>
  <div class="eq-slider-container">
    <label for="eq12k" class="eq-label">12 kHz</label>
    <input type="range" id="eq12k" class="eq-slider" min="-15" max="15" value="0" step="1" />
  </div>
  <div class="eq-slider-container">
    <label for="eq14k" class="eq-label">14 kHz</label>
    <input type="range" id="eq14k" class="eq-slider" min="-15" max="15" value="0" step="1" />
  </div>
  <div class="eq-slider-container">
    <label for="eq16k" class="eq-label">16 kHz</label>
    <input type="range" id="eq16k" class="eq-slider" min="-15" max="15" value="0" step="1" />
  </div>
</div>

<script>
  // Constants - your API info
  const folderId = '1DGz9zEQh29EAqTZpmWK5mwSj5HComnkn';
  const apiKey = 'AIzaSyDsYE91wH7UDwu8eZNbD1CFuVcilgYeZhI';

  // Elements
  const audio = document.getElementById('audio');
  const playerTitle = document.getElementById('playerTitle');
  const playerArtistAlbum = document.getElementById('playerArtistAlbum');
  const searchInput = document.getElementById('search');
  const trackListDiv = document.getElementById('track-list');
  const playlistNamesDiv = document.getElementById('playlist-names');
  const darkLightToggle = document.getElementById('darkLightToggle');

  const featuresToggle = document.getElementById('featuresToggle');
  const featuresDropdown = document.getElementById('featuresDropdown');
  const eqToggle = document.getElementById('eqToggle');
  const eqPanel = document.getElementById('eqPanel');

  // Player controls
  const btnPrev = document.getElementById('btnPrev');
  const btnPlayPause = document.getElementById('btnPlayPause');
  const btnNext = document.getElementById('btnNext');
  const btnShuffle = document.getElementById('btnShuffle');

  // Audio context for EQ
  let audioCtx;
  let sourceNode;
  let gainNodes = {};
  let eqFrequencies = {
    eq60: 60,
    eq170: 170,
    eq310: 310,
    eq600: 600,
    eq1k: 1000,
    eq3k: 3000,
    eq6k: 6000,
    eq12k: 12000,
    eq14k: 14000,
    eq16k: 16000
  };

  // Playback & data
  let tracks = [];
  let filteredTracks = [];
  let currentTrackIndex = -1;
  let isPlaying = false;
  let currentView = 'all';

  // Setup
  document.addEventListener('DOMContentLoaded', init);

  function init() {
    setupAudioContext();
    setupEventListeners();
    loadAllTracks();
    renderPlaylistNames();
  }

  // === AUDIO CONTEXT & EQ SETUP ===
  function setupAudioContext() {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    sourceNode = audioCtx.createMediaElementSource(audio);

    // Create filter nodes for each frequency
    for (const [id, freq] of Object.entries(eqFrequencies)) {
      const filter = audioCtx.createBiquadFilter();
      filter.type = 'peaking';
      filter.frequency.value = freq;
      filter.Q.value = 1;
      filter.gain.value = 0;
      gainNodes[id] = filter;
    }

    // Connect nodes in series
    let prevNode = sourceNode;
    for (const filter of Object.values(gainNodes)) {
      prevNode.connect(filter);
      prevNode = filter;
    }
    prevNode.connect(audioCtx.destination);
  }

  // === EVENT LISTENERS SETUP ===
  function setupEventListeners() {
    // EQ sliders
    Object.keys(eqFrequencies).forEach(id => {
      const slider = document.getElementById(id);
      if (slider) {
        slider.addEventListener('input', () => {
          const gainValue = parseFloat(slider.value);
          gainNodes[id].gain.setValueAtTime(gainValue, audioCtx.currentTime);
        });
      }
    });

    // Features menu toggle
    featuresToggle.addEventListener('click', () => {
      featuresDropdown.classList.toggle('active');
    });
    // EQ panel toggle
    eqToggle.addEventListener('click', () => {
      eqPanel.style.display = eqPanel.style.display === 'flex' ? 'none' : 'flex';
      eqPanel.setAttribute('aria-hidden', eqPanel.style.display === 'none');
      featuresDropdown.classList.remove('active');
    });

    // Dark/Light mode toggle
    darkLightToggle.addEventListener('click', () => {
      document.body.classList.toggle('light-mode');
      if (document.body.classList.contains('light-mode')) {
        darkLightToggle.textContent = 'Dark Mode';
        document.body.style.backgroundColor = '#fefefe';
        document.body.style.color = '#121212';
        // Adjust player bar and sidebar backgrounds for light
        document.querySelector('.sidebar').style.backgroundColor = '#f5f5f5';
        document.querySelector('.main').style.background = 'linear-gradient(180deg, #e0e0e0 0%, #ffffff 100%)';
        document.querySelector('.top-bar').style.backgroundColor = '#f0f0f0';
        document.querySelector('.player-bar').style.backgroundColor = '#f0f0f0';
      } else {
        darkLightToggle.textContent = 'Light Mode';
        document.body.style.backgroundColor = '#121212';
        document.body.style.color = 'white';
        document.querySelector('.sidebar').style.backgroundColor = '#000';
        document.querySelector('.main').style.background = 'linear-gradient(180deg, #181818 0%, #121212 100%)';
        document.querySelector('.top-bar').style.backgroundColor = '#181818';
        document.querySelector('.player-bar').style.backgroundColor = '#181818';
      }
    });

    // Search input
    searchInput.addEventListener('input', () => {
      const q = searchInput.value.trim().toLowerCase();
      if (currentView === 'all') {
        filteredTracks = tracks.filter(t => t.name.toLowerCase().includes(q));
      } else {
        // For playlists if implemented later
        filteredTracks = filteredTracks.filter(t => t.name.toLowerCase().includes(q));
      }
      renderTrackList();
    });

    // Player controls
    btnPlayPause.addEventListener('click', () => {
      if (isPlaying) {
        audio.pause();
      } else {
        playTrack(currentTrackIndex);
      }
    });
    btnNext.addEventListener('click', nextTrack);
    btnPrev.addEventListener('click', prevTrack);
    btnShuffle.addEventListener('click', shuffleTrack);

    // Audio event listeners
    audio.addEventListener('ended', nextTrack);
    audio.addEventListener('play', () => {
      isPlaying = true;
      btnPlayPause.textContent = '‚è∏Ô∏è';
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
    });
    audio.addEventListener('pause', () => {
      isPlaying = false;
      btnPlayPause.textContent = '‚ñ∂Ô∏è';
    });

    // Make eqPanel draggable
    makeDraggable(eqPanel);
  }

  // === LOAD TRACKS FROM GOOGLE DRIVE ===
  async function loadAllTracks() {
    currentView = 'all';
    tracks = [];
    filteredTracks = [];
    trackListDiv.innerHTML = 'Loading...';

    let pageToken = '';
    try {
      do {
        // Only audio mime types allowed:
        const query = `'${folderId}' in parents and (mimeType contains 'audio/') and trashed = false`;
        const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=nextPageToken,files(id,name,mimeType)&pageSize=100${pageToken ? `&pageToken=${pageToken}` : ''}&key=${apiKey}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('Google Drive API error');
        const data = await res.json();

        if (data.files && data.files.length > 0) {
          tracks.push(...data.files);
        }
        pageToken = data.nextPageToken;
      } while (pageToken);

      // Sort alphabetically
      tracks.sort((a, b) => a.name.localeCompare(b.name));
      filteredTracks = [...tracks];
      renderTrackList();
    } catch (err) {
      trackListDiv.innerHTML = 'Failed to load tracks.';
      console.error(err);
    }
  }

  // === RENDER SONG LIST ===
  function renderTrackList() {
    trackListDiv.innerHTML = '';
    if (filteredTracks.length === 0) {
      trackListDiv.innerHTML = '<p style="padding:20px; color:#888;">No songs found.</p>';
      return;
    }

    filteredTracks.forEach((track, i) => {
      const div = document.createElement('div');
      div.className = 'track-item';
      if (i === currentTrackIndex) div.classList.add('active');
      div.setAttribute('role', 'listitem');
      div.tabIndex = 0;

      const trackInfo = document.createElement('div');
      trackInfo.className = 'track-info';

      const titleSpan = document.createElement('div');
      titleSpan.className = 'track-title';
      titleSpan.textContent = track.name;

      const subInfoSpan = document.createElement('div');
      subInfoSpan.className = 'track-subinfo';
      subInfoSpan.textContent = 'Loading metadata...';

      const durationSpan = document.createElement('div');
      durationSpan.className = 'track-duration';
      durationSpan.textContent = '--:--';

      trackInfo.appendChild(titleSpan);
      trackInfo.appendChild(subInfoSpan);

      div.appendChild(trackInfo);
      div.appendChild(durationSpan);

      div.onclick = () => playTrack(i);
      div.onkeydown = e => { if(e.key === 'Enter') playTrack(i); };

      trackListDiv.appendChild(div);

      // Load metadata duration + artist/album
      extractMetadata(track, subInfoSpan, durationSpan);
    });
  }

  // === EXTRACT DURATION & METADATA ===
  async function extractMetadata(track, subInfoSpan, durationSpan) {
    try {
      const url = `https://www.googleapis.com/drive/v3/files/${track.id}?alt=media&key=${apiKey}`;
      const audioForMeta = new Audio();
      audioForMeta.src = url;
      // Load metadata only
      audioForMeta.preload = 'metadata';

      await new Promise((resolve, reject) => {
        audioForMeta.addEventListener('loadedmetadata', () => {
          // Duration in MM:SS
          const dur = audioForMeta.duration;
          durationSpan.textContent = formatTime(dur);

          // Artist & album extraction (basic): 
          // Since Google Drive audio files usually don't expose ID3 tags via JS, we show 'Unknown'
          // If you want to integrate ID3.js or music-metadata-browser, we can do that, but slower.
          subInfoSpan.textContent = 'Unknown Artist ‚Äî Unknown Album';

          resolve();
        });
        audioForMeta.addEventListener('error', () => {
          durationSpan.textContent = '--:--';
          subInfoSpan.textContent = '';
          resolve();
        });
      });
    } catch {
      durationSpan.textContent = '--:--';
      subInfoSpan.textContent = '';
    }
  }

  // === PLAYBACK FUNCTIONS ===
  function playTrack(index) {
    if (index < 0 || index >= filteredTracks.length) return;
    currentTrackIndex = index;
    const track = filteredTracks[index];
    const url = `https://www.googleapis.com/drive/v3/files/${track.id}?alt=media&key=${apiKey}`;

    audio.src = url;
    audio.play().catch(() => {});
    updatePlayerUI(track);
    renderTrackList();
  }

  function updatePlayerUI(track) {
    playerTitle.textContent = track.name;
    // Artist and album not available from Drive metadata ‚Äî placeholder
    playerArtistAlbum.textContent = 'Unknown Artist ‚Äî Unknown Album';
  }

  function nextTrack() {
    if (filteredTracks.length === 0) return;
    currentTrackIndex = (currentTrackIndex + 1) % filteredTracks.length;
    playTrack(currentTrackIndex);
  }

  function prevTrack() {
    if (filteredTracks.length === 0) return;
    currentTrackIndex = (currentTrackIndex - 1 + filteredTracks.length) % filteredTracks.length;
    playTrack(currentTrackIndex);
  }

  function shuffleTrack() {
    if (filteredTracks.length === 0) return;
    const randomIndex = Math.floor(Math.random() * filteredTracks.length);
    playTrack(randomIndex);
  }

  // === UTILITIES ===
  function formatTime(seconds) {
    if (isNaN(seconds) || !isFinite(seconds)) return '--:--';
    const m = Math.floor(seconds / 60);
    const s = Math.floor(seconds % 60);
    return `${m}:${s.toString().padStart(2, '0')}`;
  }

  // === DRAGGABLE EQ PANEL ===
  function makeDraggable(el) {
    let posX = 0, posY = 0, mouseX = 0, mouseY = 0;

    el.onmousedown = dragMouseDown;
    el.ontouchstart = dragTouchStart;

    function dragMouseDown(e) {
      e.preventDefault();
      mouseX = e.clientX;
      mouseY = e.clientY;
      document.onmouseup = closeDrag;
      document.onmousemove = elementDrag;
    }
    function dragTouchStart(e) {
      if (e.touches.length !== 1) return;
      mouseX = e.touches[0].clientX;
      mouseY = e.touches[0].clientY;
      document.ontouchend = closeDrag;
      document.ontouchmove = elementTouchDrag;
    }
    function elementDrag(e) {
      e.preventDefault();
      posX = mouseX - e.clientX;
      posY = mouseY - e.clientY;
      mouseX = e.clientX;
      mouseY = e.clientY;
      el.style.top = (el.offsetTop - posY) + "px";
      el.style.left = (el.offsetLeft - posX) + "px";
    }
    function elementTouchDrag(e) {
      if (e.touches.length !== 1) return;
      e.preventDefault();
      posX = mouseX - e.touches[0].clientX;
      posY = mouseY - e.touches[0].clientY;
      mouseX = e.touches[0].clientX;
      mouseY = e.touches[0].clientY;
      el.style.top = (el.offsetTop - posY) + "px";
      el.style.left = (el.offsetLeft - posX) + "px";
    }
    function closeDrag() {
      document.onmouseup = null;
      document.onmousemove = null;
      document.ontouchend = null;
      document.ontouchmove = null;
    }
  }
</script>

</body>
</html>
