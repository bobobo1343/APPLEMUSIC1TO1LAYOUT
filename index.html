<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ITUNE VERSION</title>
<style>
  /* ... same styles as before ... */
  /* To keep this snippet short, assume same styles from previous script above are here */
</style>
</head>
<body>
<div class="app">
  <!-- main UI: sidebar, song list, playback bar, etc. -->
  <!-- ... same main UI as before ... -->

  <button id="btnOpenMiniPlayer" style="position: fixed; bottom: 120px; right: 20px; padding: 10px 20px; border-radius: 20px; font-weight: 700; cursor: pointer; z-index:1001;">Open Mini Player</button>
</div>

<audio id="audioPlayer"></audio>

<script>
  // Constants & elements same as before
  // ... all the previous code with API_KEY, FOLDER_ID, song fetching, etc.

  // Mini player popup window reference
  let miniPlayerWindow = null;

  // Open mini player in popup window
  const btnOpenMiniPlayer = document.getElementById('btnOpenMiniPlayer');

  btnOpenMiniPlayer.addEventListener('click', () => {
    if (miniPlayerWindow && !miniPlayerWindow.closed) {
      miniPlayerWindow.focus();
      return;
    }
    const width = 320;
    const height = 140;
    const left = window.screenX + window.innerWidth - width - 20;
    const top = window.screenY + window.innerHeight - height - 40;

    miniPlayerWindow = window.open('', 'MiniPlayerWindow', `width=${width},height=${height},left=${left},top=${top},resizable=no,alwaysRaised=yes`);

    // Write the mini player HTML to the popup
    miniPlayerWindow.document.write(`
      <html>
      <head>
        <title>Mini Player</title>
        <style>
          body {
            margin:0; padding:10px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background: #222;
            color: #eee;
            user-select: none;
          }
          #title {
            font-weight: 700;
            font-size: 18px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            margin-bottom: 12px;
          }
          #controls button {
            font-size: 24px;
            margin-right: 10px;
            background: none;
            border: none;
            color: #eee;
            cursor: pointer;
            user-select: none;
          }
          #controls button:hover {
            color: #aaa;
          }
        </style>
      </head>
      <body>
        <div id="title">No song playing</div>
        <div id="controls">
          <button id="prevBtn" title="Previous">&#9664;&#9664;</button>
          <button id="playPauseBtn" title="Play/Pause">&#9654;</button>
          <button id="nextBtn" title="Next">&#9654;&#9654;</button>
          <button id="closeBtn" title="Close Mini Player" style="float:right; font-size:18px; margin-left: 20px;">✖</button>
        </div>
        <script>
          const playPauseBtn = document.getElementById('playPauseBtn');
          const prevBtn = document.getElementById('prevBtn');
          const nextBtn = document.getElementById('nextBtn');
          const closeBtn = document.getElementById('closeBtn');
          const titleElem = document.getElementById('title');

          // Listen to messages from opener
          window.addEventListener('message', e => {
            if (e.data.type === 'updateSong') {
              titleElem.textContent = e.data.songName || 'No song playing';
              playPauseBtn.textContent = e.data.isPlaying ? '⏸' : '▶';
            }
          });

          // Send control commands to opener
          function sendCommand(cmd) {
            if (window.opener && !window.opener.closed) {
              window.opener.postMessage({ type: 'control', command: cmd }, '*');
            }
          }
          playPauseBtn.onclick = () => sendCommand('togglePlayPause');
          prevBtn.onclick = () => sendCommand('prevSong');
          nextBtn.onclick = () => sendCommand('nextSong');
          closeBtn.onclick = () => window.close();
        <\/script>
      </body>
      </html>
    `);
    miniPlayerWindow.document.close();
  });

  // Listen to commands from mini player popup
  window.addEventListener('message', e => {
    if (e.data.type === 'control') {
      switch (e.data.command) {
        case 'togglePlayPause':
          togglePlayPause();
          break;
        case 'prevSong':
          prevSong();
          break;
        case 'nextSong':
          nextSong();
          break;
      }
    }
  });

  // Whenever playback changes, update the mini player window too
  function updateMiniPlayer() {
    if (miniPlayerWindow && !miniPlayerWindow.closed) {
      const currentSong = filteredSongs[currentSongIndex];
      miniPlayerWindow.postMessage({
        type: 'updateSong',
        songName: currentSong ? currentSong.name : 'No song playing',
        isPlaying: isPlaying,
      }, '*');
    }
  }

  // Modify playSong and togglePlayPause to call updateMiniPlayer after state changes:
  async function playSong(index) {
    if (index < 0 || index >= filteredSongs.length) return;
    currentSongIndex = index;
    const song = filteredSongs[index];
    audio.src = createSongURL(song.id);
    try {
      await audio.play();
      isPlaying = true;
    } catch(e) {
      isPlaying = false;
    }
    updatePlaybackUI();
    renderSongs(filteredSongs);
    updateMiniPlayer();
  }

  function togglePlayPause() {
    if (!audio.src) return;
    if (audio.paused) {
      audio.play();
      isPlaying = true;
    } else {
      audio.pause();
      isPlaying = false;
    }
    updatePlaybackUI();
    updateMiniPlayer();
  }

  function nextSong() {
    if(filteredSongs.length === 0) return;
    currentSongIndex = (currentSongIndex + 1) % filteredSongs.length;
    playSong(currentSongIndex);
  }
  function prevSong() {
    if(filteredSongs.length === 0) return;
    currentSongIndex = (currentSongIndex - 1 + filteredSongs.length) % filteredSongs.length;
    playSong(currentSongIndex);
  }

  // Then in init() or at the end, call updateMiniPlayer() to sync if popup already open

  // rest of your original initialization code here...

  // For demo/testing, call init() here:
  init();

</script>
</body>
</html>
