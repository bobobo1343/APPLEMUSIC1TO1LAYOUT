<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>iTune Version - iTunes Style Player with EQ & Mini Player Popup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Reset and base */
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background: #121212;
      color: #e0e0e0;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }
    body.light {
      background: #f9f9f9;
      color: #111;
    }
    a {
      color: inherit;
      text-decoration: none;
    }
    button {
      cursor: pointer;
      background: none;
      border: none;
      color: inherit;
      font-weight: 600;
      font-size: 14px;
      transition: color 0.2s;
      user-select: none;
    }
    button:hover, button.active {
      color: #007aff;
      font-weight: 700;
    }
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 10px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }

    /* Layout */
    #app {
      display: flex;
      height: 100vh;
      overflow: hidden;
      user-select: none;
    }
    /* Sidebar: Playlists + Search */
    #sidebar {
      width: 280px;
      background: #181818;
      border-right: 1px solid #333;
      display: flex;
      flex-direction: column;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }
    body.light #sidebar {
      background: #fafafa;
      border-color: #ccc;
      color: #111;
    }
    #sidebar h1 {
      font-size: 24px;
      margin: 0 0 20px 0;
      font-weight: 900;
      text-align: center;
      color: #007aff;
      letter-spacing: 1.5px;
    }
    #searchInput {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: none;
      background: #222;
      color: #ddd;
      font-size: 14px;
      outline: none;
      margin-bottom: 20px;
      transition: background 0.3s, color 0.3s;
    }
    body.light #searchInput {
      background: #eee;
      color: #111;
    }
    #playlistButtons {
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
      flex-grow: 1;
    }
    #playlistButtons button {
      text-align: left;
      padding: 12px 16px;
      border-radius: 8px;
      background: transparent;
      border: 1.5px solid transparent;
      transition: background 0.3s, border-color 0.3s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #playlistButtons button:hover {
      background: #007aff;
      color: white;
    }
    #playlistButtons button.active {
      background: #007aff;
      color: white;
      border-color: #005bb5;
      font-weight: 700;
    }

    /* Main Content: Song List and Queue */
    #mainContent {
      flex: 1;
      display: flex;
      flex-direction: row;
      overflow: hidden;
      position: relative;
    }
    /* Song List Table */
    #songListContainer {
      flex: 2.5;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #333;
      transition: border-color 0.3s;
    }
    body.light #songListContainer {
      border-color: #ccc;
    }
    #songListHeader {
      padding: 15px 20px;
      font-weight: 700;
      font-size: 18px;
      border-bottom: 1px solid #333;
      color: #007aff;
      background: #222;
      transition: background 0.3s, border-color 0.3s;
    }
    body.light #songListHeader {
      background: #eee;
      border-color: #ccc;
      color: #005bb5;
    }
    #songsTableWrapper {
      overflow-y: auto;
      flex-grow: 1;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
      color: inherit;
      user-select: none;
    }
    thead tr {
      background: #222;
    }
    body.light thead tr {
      background: #ddd;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    th {
      font-weight: 700;
      cursor: pointer;
      user-select: text;
    }
    tbody tr {
      border-bottom: 1px solid #333;
      transition: background 0.2s;
      cursor: pointer;
    }
    body.light tbody tr {
      border-color: #ccc;
    }
    tbody tr:hover {
      background: #007aff;
      color: white;
    }
    tbody tr.selected {
      background: #005bb5;
      color: white;
      font-weight: 700;
    }

    /* Queue / History Panel */
    #queuePanel {
      width: 320px;
      background: #181818;
      display: flex;
      flex-direction: column;
      transition: background 0.3s, color 0.3s;
    }
    body.light #queuePanel {
      background: #fafafa;
      color: #111;
    }
    #queuePanel h2 {
      text-align: center;
      font-weight: 700;
      font-size: 20px;
      margin: 15px 0;
      color: #007aff;
    }
    #queueList {
      flex-grow: 1;
      overflow-y: auto;
      padding: 0 10px 10px 10px;
    }
    .queue-item {
      padding: 10px 12px;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      color: inherit;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    body.light .queue-item {
      border-color: #ccc;
    }
    .queue-item:hover {
      background: #007aff;
      color: white;
    }
    .queue-item.selected {
      background: #005bb5;
      color: white;
      font-weight: 700;
    }
    .queue-item button {
      background: none;
      border: none;
      color: #007aff;
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      user-select: none;
      padding: 0 5px;
      transition: color 0.2s;
    }
    .queue-item button:hover {
      color: #005bb5;
    }

    /* Playback Bar at bottom */
    #playbackBar {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: 90px;
      background: #222;
      border-top: 1px solid #333;
      display: flex;
      align-items: center;
      padding: 0 30px;
      color: white;
      user-select: none;
      z-index: 9999;
      transition: background 0.3s;
      gap: 25px;
      flex-wrap: wrap;
    }
    body.light #playbackBar {
      background: #eee;
      color: #111;
      border-color: #ccc;
    }
    #nowPlayingInfo {
      flex: 1 1 320px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    #nowPlayingTitle {
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 6px;
    }
    #nowPlayingArtist {
      font-size: 14px;
      color: #bbb;
    }
    body.light #nowPlayingArtist {
      color: #555;
    }
    #controls {
      display: flex;
      align-items: center;
      gap: 25px;
      flex-shrink: 0;
      user-select: none;
    }
    #controls button {
      background: none;
      border: none;
      font-size: 28px;
      color: inherit;
      cursor: pointer;
      transition: color 0.3s;
      user-select: none;
    }
    #controls button:hover {
      color: #007aff;
    }
    #progressContainer {
      flex-grow: 2;
      min-width: 300px;
      display: flex;
      flex-direction: column;
      user-select: none;
    }
    #progressBar {
      width: 100%;
      height: 6px;
      background: #444;
      border-radius: 4px;
      cursor: pointer;
      position: relative;
      margin-bottom: 6px;
    }
    #progressFill {
      height: 100%;
      background: #007aff;
      border-radius: 4px;
      width: 0%;
      transition: width 0.1s linear;
    }
    #timeContainer {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #bbb;
    }
    body.light #timeContainer {
      color: #555;
    }
    #volumeControl {
      display: flex;
      align-items: center;
      gap: 8px;
      user-select: none;
      flex-shrink: 0;
    }
    #volumeControl input[type=range] {
      width: 100px;
      cursor: pointer;
    }

    /* Features dropdown */
    #featuresContainer {
      position: relative;
      user-select: none;
    }
    #featuresButton {
      background: none;
      border: none;
      color: inherit;
      font-weight: 700;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }
    #featuresButton:hover {
      background: #007aff;
      color: white;
    }
    #featuresDropdown {
      position: absolute;
      bottom: 45px;
      right: 0;
      background: #222;
      border-radius: 8px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.5);
      padding: 12px;
      min-width: 180px;
      display: none;
      flex-direction: column;
      gap: 10px;
      z-index: 10000;
    }
    body.light #featuresDropdown {
      background: #fafafa;
      color: #111;
      box-shadow: 0 6px 15px rgba(0,0,0,0.15);
    }
    #featuresDropdown label {
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #featuresDropdown button {
      font-weight: 600;
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #007aff;
      color: white;
      transition: background 0.3s;
    }
    #featuresDropdown button:hover {
      background: #005bb5;
    }

    /* Mini Player popup reminder button */
    #miniPlayerToggleBtn {
      background: none;
      border: 1.5px solid #007aff;
      border-radius: 6px;
      color: #007aff;
      font-weight: 700;
      font-size: 13px;
      padding: 5px 12px;
      cursor: pointer;
      user-select: none;
      margin-top: 5px;
      transition: all 0.3s;
      white-space: nowrap;
    }
    #miniPlayerToggleBtn:hover {
      background: #007aff;
      color: white;
    }

    /* Utility */
    .hidden {
      display: none !important;
    }

  </style>
</head>
<body>
  <div id="app" role="main" aria-label="iTune Version Music Player">
    <nav id="sidebar" aria-label="Sidebar with playlists and search">
      <h1>iTune Version</h1>
      <input id="searchInput" type="search" aria-label="Search songs" placeholder="Search songs..." />
      <div id="playlistButtons" role="list" aria-label="Playlists">
        <button class="active" data-playlist="all">All Songs</button>
      </div>
    </nav>
    <section id="mainContent">
      <div id="songListContainer" aria-label="Song list">
        <div id="songListHeader">Songs</div>
        <div id="songsTableWrapper">
          <table id="songsTable" aria-describedby="songListHeader" role="grid" tabindex="0">
            <thead>
              <tr>
                <th class="col-name" data-sort="name" scope="col" tabindex="0" aria-sort="none">Title</th>
                <th class="col-artist" data-sort="artist" scope="col" tabindex="0" aria-sort="none">Artist</th>
                <th class="col-album" data-sort="album" scope="col" tabindex="0" aria-sort="none">Album</th>
                <th class="col-duration" data-sort="duration" scope="col" tabindex="0" aria-sort="none" style="text-align:right;padding-right:30px;">Duration</th>
              </tr>
            </thead>
            <tbody id="songsTbody" role="rowgroup">
              <!-- Populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
      <aside id="queuePanel" aria-label="Up Next queue">
        <h2>Up Next</h2>
        <div id="queueList" role="list" tabindex="0">
          <!-- Queue items -->
        </div>
      </aside>
    </section>

    <div id="playbackBar" aria-label="Playback controls">
      <div id="nowPlayingInfo" aria-live="polite" aria-atomic="true">
        <div id="nowPlayingTitle">No song playing</div>
        <div id="nowPlayingArtist"></div>
      </div>
      <div id="controls">
        <button id="prevBtn" aria-label="Previous track">‚èÆÔ∏è</button>
        <button id="playPauseBtn" aria-label="Play/Pause">‚ñ∂Ô∏è</button>
        <button id="nextBtn" aria-label="Next track">‚è≠Ô∏è</button>
      </div>
      <div id="progressContainer" aria-label="Playback progress" role="slider" aria-valuemin="0" aria-valuemax="100" tabindex="0">
        <div id="progressBar" aria-hidden="true">
          <div id="progressFill"></div>
        </div>
        <div id="timeContainer">
          <span id="currentTime">0:00</span>
          <span id="durationTime">0:00</span>
        </div>
      </div>
      <div id="volumeControl" aria-label="Volume control">
        <button id="muteBtn" aria-label="Mute/Unmute volume">üîà</button>
        <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1" aria-valuemin="0" aria-valuemax="1" aria-valuenow="1" />
      </div>
      <div id="featuresContainer">
        <button id="featuresButton" aria-haspopup="true" aria-expanded="false" aria-controls="featuresDropdown">Features ‚ñæ</button>
        <div id="featuresDropdown" role="menu" aria-label="Features menu">
          <button id="toggleMiniPlayerBtn" role="menuitem">Open Mini Player</button>
          <button id="clearQueueBtn" role="menuitem">Clear Up Next</button>
          <label role="menuitem" style="margin-top: 8px; cursor:pointer;">
            <span>Dark Mode</span>
            <input type="checkbox" id="darkModeToggle" style="margin-left: 6px; cursor:pointer;" aria-label="Toggle dark mode"/>
          </label>
          <button id="openEqBtn" role="menuitem">Open EQ</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (() => {
      // Replace with your Google Drive folder ID and API key
      const folderId = '1DGz9zEQh29EAqTZpmWK5mwSj5HComnkn';
      const apiKey = 'AIzaSyDsYE91wH7UDwu8eZNbD1CFuVcilgYeZhI';

      const searchInput = document.getElementById('searchInput');
      const songsTbody = document.getElementById('songsTbody');
      const queueList = document.getElementById('queueList');
      const nowPlayingTitle = document.getElementById('nowPlayingTitle');
      const nowPlayingArtist = document.getElementById('nowPlayingArtist');
      const playPauseBtn = document.getElementById('playPauseBtn');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      const currentTimeEl = document.getElementById('currentTime');
      const durationTimeEl = document.getElementById('durationTime');
      const volumeSlider = document.getElementById('volumeSlider');
      const muteBtn = document.getElementById('muteBtn');
      const featuresButton = document.getElementById('featuresButton');
      const featuresDropdown = document.getElementById('featuresDropdown');
      const toggleMiniPlayerBtn = document.getElementById('toggleMiniPlayerBtn');
      const clearQueueBtn = document.getElementById('clearQueueBtn');
      const darkModeToggle = document.getElementById('darkModeToggle');
      const openEqBtn = document.getElementById('openEqBtn');
      const body = document.body;

      // Audio context and nodes for EQ (5-band)
      let audioCtx, sourceNode, gainNode, filters = [];
      const EQ_BANDS = [
        { freq: 60, type: 'lowshelf' },
        { freq: 170, type: 'peaking' },
        { freq: 1000, type: 'peaking' },
        { freq: 3500, type: 'peaking' },
        { freq: 10000, type: 'highshelf' },
      ];

      // State
      let songs = [];
      let filteredSongs = [];
      let currentSongIndex = -1;
      let audio = new Audio();
      let isPlaying = false;
      let queue = [];
      let history = [];
      let miniPlayerWindow = null;
      let miniPlayerOpen = false;

      // UTILITIES
      function secToTime(s) {
        if (isNaN(s) || !isFinite(s)) return '0:00';
        const min = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        return min + ':' + (sec < 10 ? '0' : '') + sec;
      }

      // --- FETCH SONGS FROM GOOGLE DRIVE ---
      async function fetchSongsFromDrive(pageToken = '') {
        const baseUrl = `https://www.googleapis.com/drive/v3/files`;
        const fields = 'nextPageToken,files(id,name,mimeType,modifiedTime)';
        const q = `'${folderId}' in parents and mimeType contains 'audio/' and trashed = false`;
        const url = new URL(baseUrl);
        url.searchParams.set('key', apiKey);
        url.searchParams.set('q', q);
        url.searchParams.set('fields', fields);
        url.searchParams.set('pageSize', '1000');
        if(pageToken) url.searchParams.set('pageToken', pageToken);

        const res = await fetch(url);
        if (!res.ok) throw new Error(`Drive API Error: ${res.status} ${res.statusText}`);
        const data = await res.json();

        return data;
      }

      async function loadAllSongs() {
        songs = [];
        let pageToken = '';
        try {
          do {
            const data = await fetchSongsFromDrive(pageToken);
            songs.push(...data.files.map(f => ({
              id: f.id,
              title: f.name.replace(/\.[^/.]+$/, ""), // remove extension
              artist: "Unknown Artist",
              album: "Unknown Album",
              duration: 0,
              url: `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media&key=${apiKey}`,
            })));
            pageToken = data.nextPageToken || '';
          } while (pageToken);
          filteredSongs = songs;
          await fetchDurationsForSongs();
          renderSongsTable();
        } catch (e) {
          console.error(e);
          alert('Failed to load songs from Google Drive. Check API key and folder ID.');
        }
      }

      // Load audio durations async for UX
      async function fetchDurationsForSongs() {
        for (let i = 0; i < songs.length; i++) {
          await new Promise(res => {
            const tmpAudio = new Audio();
            tmpAudio.preload = 'metadata';
            tmpAudio.src = songs[i].url;
            tmpAudio.onloadedmetadata = () => {
              songs[i].duration = tmpAudio.duration || 0;
              tmpAudio.remove();
              res();
            };
            tmpAudio.onerror = () => {
              songs[i].duration = 0;
              tmpAudio.remove();
              res();
            };
          });
          if (i % 20 === 0) renderSongsTable();
        }
        renderSongsTable();
      }

      // --- RENDER SONGS TABLE ---
      function renderSongsTable() {
        songsTbody.innerHTML = '';
        filteredSongs.forEach((song, i) => {
          const tr = document.createElement('tr');
          tr.tabIndex = 0;
          tr.setAttribute('role', 'row');
          tr.dataset.index = i;
          if (queue.length > 0 && currentSongIndex >= 0) {
            const currentSong = queue[currentSongIndex];
            if (currentSong.id === song.id) tr.classList.add('selected');
          }

          const titleTd = document.createElement('td');
          titleTd.textContent = song.title;
          const artistTd = document.createElement('td');
          artistTd.textContent = song.artist;
          const albumTd = document.createElement('td');
          albumTd.textContent = song.album;
          const durationTd = document.createElement('td');
          durationTd.textContent = song.duration ? secToTime(song.duration) : '--:--';
          durationTd.style.textAlign = 'right';
          durationTd.style.paddingRight = '30px';

          tr.appendChild(titleTd);
          tr.appendChild(artistTd);
          tr.appendChild(albumTd);
          tr.appendChild(durationTd);

          tr.addEventListener('click', () => {
            addSongToQueue(i);
          });

          songsTbody.appendChild(tr);
        });
      }

      // --- FILTER SONGS BY SEARCH ---
      function filterSongsBySearch(query) {
        query = query.trim().toLowerCase();
        filteredSongs = songs.filter(s =>
          s.title.toLowerCase().includes(query) ||
          s.artist.toLowerCase().includes(query) ||
          s.album.toLowerCase().includes(query)
        );
        renderSongsTable();
      }

      // --- QUEUE MANAGEMENT ---
      function addSongToQueue(songIndex) {
        const song = filteredSongs[songIndex];
        if (!song) return;
        // Avoid duplicate in queue
        if (!queue.some(s => s.id === song.id)) {
          queue.push(song);
        }
        renderQueue();
        if (!isPlaying) {
          playSongByQueueIndex(queue.length - 1);
        }
      }

      function removeSongFromQueue(index) {
        if(index === currentSongIndex){
          // If removing currently playing, play next or stop
          if(queue.length > 1){
            playSongByQueueIndex(index + 1 < queue.length ? index + 1 : 0);
          } else {
            stopPlayback();
          }
        }
        queue.splice(index, 1);
        if(currentSongIndex > index) currentSongIndex--;
        else if(currentSongIndex === index) currentSongIndex = -1;
        renderQueue();
        renderSongsTable();
      }

      function clearQueue() {
        stopPlayback();
        queue = [];
        currentSongIndex = -1;
        renderQueue();
        renderSongsTable();
      }

      function renderQueue() {
        queueList.innerHTML = '';
        queue.forEach((song, idx) => {
          const div = document.createElement('div');
          div.className = 'queue-item';
          div.tabIndex = 0;
          if(currentSongIndex === idx) div.classList.add('selected');
          div.textContent = `${song.title} ‚Äî ${song.artist}`;
          div.title = song.title + ' - ' + song.artist;
          // Play on click
          div.addEventListener('click', () => {
            playSongByQueueIndex(idx);
          });

          // Remove button
          const rmBtn = document.createElement('button');
          rmBtn.textContent = '‚úï';
          rmBtn.title = 'Remove from queue';
          rmBtn.addEventListener('click', e => {
            e.stopPropagation();
            removeSongFromQueue(idx);
          });
          div.appendChild(rmBtn);

          queueList.appendChild(div);
        });
      }

      // --- AUDIO PLAYBACK CONTROLS ---
      async function playSongByQueueIndex(idx) {
        if (idx < 0 || idx >= queue.length) return;
        currentSongIndex = idx;
        const song = queue[idx];
        if (!song) return;

        audio.src = song.url;
        audio.load();

        try {
          setupAudioContext(); // Make sure audio context setup for EQ
          await audio.play();
          isPlaying = true;
          updatePlayPauseButton();
          updateNowPlayingInfo(song);
          highlightCurrentSong();
          addToHistory(song);
          renderQueue();
          syncMiniPlayer();
        } catch (e) {
          console.error('Audio play error:', e);
          isPlaying = false;
          updatePlayPauseButton();
        }
      }
      function stopPlayback(){
        audio.pause();
        audio.src = '';
        isPlaying = false;
        currentSongIndex = -1;
        updatePlayPauseButton();
        updateNowPlayingInfo({title:'No song playing', artist:''});
        highlightCurrentSong();
        syncMiniPlayer();
      }

      function updateNowPlayingInfo(song) {
        nowPlayingTitle.textContent = song.title;
        nowPlayingArtist.textContent = song.artist;
      }

      function updatePlayPauseButton() {
        playPauseBtn.textContent = isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
        playPauseBtn.setAttribute('aria-label', isPlaying ? 'Pause' : 'Play');
      }

      function highlightCurrentSong() {
        const trs = songsTbody.querySelectorAll('tr');
        trs.forEach(tr => tr.classList.remove('selected'));
        if (currentSongIndex < 0 || currentSongIndex >= queue.length) return;
        // Find song index in filteredSongs
        const currentSong = queue[currentSongIndex];
        const filteredIndex = filteredSongs.findIndex(s => s.id === currentSong.id);
        if (filteredIndex >= 0) {
          const tr = songsTbody.querySelector(`tr[data-index="${filteredIndex}"]`);
          if (tr) tr.classList.add('selected');
        }
      }

      function addToHistory(song) {
        history.unshift(song);
        if (history.length > 50) history.pop();
      }

      function togglePlayPause() {
        if (!audio.src) {
          if (queue.length > 0) playSongByQueueIndex(0);
          return;
        }
        if (isPlaying) audio.pause();
        else audio.play();
      }

      function playNext() {
        if (currentSongIndex + 1 < queue.length) {
          playSongByQueueIndex(currentSongIndex + 1);
        }
      }
      function playPrev() {
        if (currentSongIndex - 1 >= 0) {
          playSongByQueueIndex(currentSongIndex - 1);
        }
      }

      // --- PROGRESS BAR ---
      function updateProgress() {
        if (!audio.duration || isNaN(audio.duration)) return;
        const percent = (audio.currentTime / audio.duration) * 100;
        progressFill.style.width = percent + '%';
        currentTimeEl.textContent = secToTime(audio.currentTime);
        durationTimeEl.textContent = secToTime(audio.duration);
        progressBar.setAttribute('aria-valuenow', Math.round(percent));
      }

      function seek(e) {
        const rect = progressBar.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const percent = clickX / rect.width;
        if (!audio.duration) return;
        audio.currentTime = percent * audio.duration;
      }

      // --- VOLUME CONTROLS ---
      function updateVolume() {
        audio.volume = volumeSlider.value;
        if (audio.volume === 0) muteBtn.textContent = 'üîá';
        else muteBtn.textContent = 'üîà';
      }

      function toggleMute() {
        if (audio.volume > 0) {
          volumeSlider.dataset.prevVolume = audio.volume;
          volumeSlider.value = 0;
        } else {
          volumeSlider.value = volumeSlider.dataset.prevVolume || 1;
        }
        updateVolume();
      }

      // --- FEATURES DROPDOWN ---
      function toggleFeaturesDropdown() {
        const expanded = featuresButton.getAttribute('aria-expanded') === 'true';
        if (expanded) {
          featuresDropdown.style.display = 'none';
          featuresButton.setAttribute('aria-expanded', 'false');
        } else {
          featuresDropdown.style.display = 'flex';
          featuresButton.setAttribute('aria-expanded', 'true');
        }
      }

      // --- EQ Setup ---
      function setupAudioContext() {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          sourceNode = audioCtx.createMediaElementSource(audio);
          gainNode = audioCtx.createGain();
          filters = EQ_BANDS.map(band => {
            const filter = audioCtx.createBiquadFilter();
            filter.type = band.type;
            filter.frequency.value = band.freq;
            filter.gain.value = 0;
            return filter;
          });
          // Chain filters: sourceNode -> filters[0] -> filters[1] -> ... -> gainNode -> destination
          sourceNode.connect(filters[0]);
          for (let i = 0; i < filters.length - 1; i++) {
            filters[i].connect(filters[i + 1]);
          }
          filters[filters.length - 1].connect(gainNode);
          gainNode.connect(audioCtx.destination);
        }
      }

      // --- EQ UI ---
      let eqPopup;
      function createEQPopup() {
        if (eqPopup) return eqPopup;
        eqPopup = document.createElement('div');
        eqPopup.style.position = 'fixed';
        eqPopup.style.bottom = '100px';
        eqPopup.style.right = '30px';
        eqPopup.style.background = body.classList.contains('light') ? '#fafafa' : '#222';
        eqPopup.style.color = body.classList.contains('light') ? '#111' : '#eee';
        eqPopup.style.padding = '15px 25px';
        eqPopup.style.borderRadius = '12px';
        eqPopup.style.boxShadow = '0 10px 30px rgba(0,0,0,0.5)';
        eqPopup.style.zIndex = '10001';
        eqPopup.style.width = '320px';
        eqPopup.style.userSelect = 'none';
        eqPopup.style.fontWeight = '700';
        eqPopup.style.fontSize = '14px';
        eqPopup.style.fontFamily = 'inherit';

        eqPopup.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span>Equalizer</span>
            <button id="eqCloseBtn" aria-label="Close EQ" style="background:none; border:none; color:inherit; font-size:20px; cursor:pointer;">‚úï</button>
          </div>
          <div id="eqSliders" style="display:flex; justify-content:space-between; gap: 10px; height: 160px; align-items:flex-end;"></div>
        `;
        document.body.appendChild(eqPopup);

        document.getElementById('eqCloseBtn').addEventListener('click', () => {
          eqPopup.style.display = 'none';
        });

        const slidersContainer = eqPopup.querySelector('#eqSliders');

        EQ_BANDS.forEach((band, i) => {
          const sliderContainer = document.createElement('div');
          sliderContainer.style.display = 'flex';
          sliderContainer.style.flexDirection = 'column';
          sliderContainer.style.alignItems = 'center';
          sliderContainer.style.width = '50px';

          const slider = document.createElement('input');
          slider.type = 'range';
          slider.min = '-15';
          slider.max = '15';
          slider.value = '0';
          slider.step = '0.5';
          slider.style.writingMode = 'bt-lr'; // vertical
          slider.style.height = '140px';
          slider.style.cursor = 'pointer';
          slider.setAttribute('aria-label', `EQ Band ${band.freq} Hz`);
          slider.addEventListener('input', e => {
            filters[i].gain.value = parseFloat(e.target.value);
          });

          const label = document.createElement('div');
          label.textContent = band.freq >= 1000 ? (band.freq/1000).toFixed(1)+'k' : band.freq;
          label.style.marginTop = '8px';
          label.style.fontSize = '12px';
          label.style.userSelect = 'none';

          sliderContainer.appendChild(slider);
          sliderContainer.appendChild(label);
          slidersContainer.appendChild(sliderContainer);
        });

        return eqPopup;
      }

      // --- Mini Player Popup ---
      function openMiniPlayer() {
        if (miniPlayerWindow && !miniPlayerWindow.closed) {
          miniPlayerWindow.focus();
          return;
        }
        const width = 360, height = 120;
        const left = window.screenX + window.outerWidth - width - 30;
        const top = window.screenY + window.outerHeight - height - 100;
        miniPlayerWindow = window.open('', 'miniPlayer', `width=${width},height=${height},left=${left},top=${top},resizable=no,scrollbars=no`);
        if (!miniPlayerWindow) {
          alert('Popup blocked! Please allow popups for this site to use Mini Player.');
          return;
        }
        miniPlayerOpen = true;
        miniPlayerWindow.document.title = "iTune Version Mini Player";
        miniPlayerWindow.document.body.style.margin = '0';
        miniPlayerWindow.document.body.style.backgroundColor = body.classList.contains('light') ? '#fafafa' : '#121212';
        miniPlayerWindow.document.body.style.color = body.classList.contains('light') ? '#111' : '#eee';
        miniPlayerWindow.document.body.style.fontFamily = 'Arial, sans-serif';
        miniPlayerWindow.document.body.style.userSelect = 'none';
        miniPlayerWindow.document.body.innerHTML = `
          <style>
            body {
              display: flex;
              align-items: center;
              justify-content: space-between;
              height: 100%;
              padding: 10px 15px;
              margin: 0;
              font-weight: 700;
              user-select: none;
            }
            #info {
              flex: 1;
              overflow: hidden;
            }
            #info div {
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
              font-weight: 700;
            }
            #title {
              font-size: 16px;
              margin-bottom: 4px;
            }
            #artist {
              font-size: 12px;
              color: #888;
            }
            #controls button {
              font-size: 24px;
              background: none;
              border: none;
              color: inherit;
              cursor: pointer;
              margin-left: 15px;
              user-select: none;
            }
            #controls button:hover {
              color: #007aff;
            }
          </style>
          <div id="info" aria-label="Now playing info" tabindex="0">
            <div id="title" aria-live="polite">No song playing</div>
            <div id="artist"></div>
          </div>
          <div id="controls">
            <button id="miniPrevBtn" aria-label="Previous track">‚èÆÔ∏è</button>
            <button id="miniPlayPauseBtn" aria-label="Play/Pause">‚ñ∂Ô∏è</button>
            <button id="miniNextBtn" aria-label="Next track">‚è≠Ô∏è</button>
          </div>
        `;

        // Sync controls
        const miniTitle = miniPlayerWindow.document.getElementById('title');
        const miniArtist = miniPlayerWindow.document.getElementById('artist');
        const miniPlayPauseBtn = miniPlayerWindow.document.getElementById('miniPlayPauseBtn');
        const miniPrevBtn = miniPlayerWindow.document.getElementById('miniPrevBtn');
        const miniNextBtn = miniPlayerWindow.document.getElementById('miniNextBtn');

        miniPlayPauseBtn.addEventListener('click', () => {
          togglePlayPause();
          syncMiniPlayer();
        });
        miniPrevBtn.addEventListener('click', () => {
          playPrev();
          syncMiniPlayer();
        });
        miniNextBtn.addEventListener('click', () => {
          playNext();
          syncMiniPlayer();
        });

        // Update mini player content on focus/interval
        function updateMiniPlayer() {
          if (miniPlayerWindow.closed) {
            miniPlayerWindow = null;
            miniPlayerOpen = false;
            return;
          }
          miniTitle.textContent = nowPlayingTitle.textContent;
          miniArtist.textContent = nowPlayingArtist.textContent;
          miniPlayPauseBtn.textContent = isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
          requestAnimationFrame(updateMiniPlayer);
        }
        updateMiniPlayer();
      }

      function syncMiniPlayer() {
        if (!miniPlayerWindow || miniPlayerWindow.closed) {
          miniPlayerWindow = null;
          miniPlayerOpen = false;
          return;
        }
        const miniTitle = miniPlayerWindow.document.getElementById('title');
        const miniArtist = miniPlayerWindow.document.getElementById('artist');
        const miniPlayPauseBtn = miniPlayerWindow.document.getElementById('miniPlayPauseBtn');
        if (miniTitle && miniArtist && miniPlayPauseBtn) {
          miniTitle.textContent = nowPlayingTitle.textContent;
          miniArtist.textContent = nowPlayingArtist.textContent;
          miniPlayPauseBtn.textContent = isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
        }
      }

      // --- EVENT LISTENERS ---
      playPauseBtn.addEventListener('click', () => {
        togglePlayPause();
        syncMiniPlayer();
      });
      prevBtn.addEventListener('click', () => {
        playPrev();
        syncMiniPlayer();
      });
      nextBtn.addEventListener('click', () => {
        playNext();
        syncMiniPlayer();
      });

      audio.addEventListener('ended', () => {
        playNext();
        syncMiniPlayer();
      });
      audio.addEventListener('timeupdate', updateProgress);
      audio.addEventListener('play', () => {
        isPlaying = true;
        updatePlayPauseButton();
        syncMiniPlayer();
      });
      audio.addEventListener('pause', () => {
        isPlaying = false;
        updatePlayPauseButton();
        syncMiniPlayer();
      });
      audio.addEventListener('error', e => {
        console.error('Audio error:', e);
        playNext();
      });

      progressBar.addEventListener('click', seek);

      volumeSlider.addEventListener('input', updateVolume);
      muteBtn.addEventListener('click', toggleMute);

      searchInput.addEventListener('input', () => {
        filterSongsBySearch(searchInput.value);
      });

      featuresButton.addEventListener('click', toggleFeaturesDropdown);
      document.addEventListener('click', e => {
        if (!featuresContainer.contains(e.target) && !featuresButton.contains(e.target)) {
          featuresDropdown.style.display = 'none';
          featuresButton.setAttribute('aria-expanded', 'false');
        }
      });

      toggleMiniPlayerBtn.addEventListener('click', () => {
        openMiniPlayer();
        featuresDropdown.style.display = 'none';
        featuresButton.setAttribute('aria-expanded', 'false');
      });

      clearQueueBtn.addEventListener('click', () => {
        clearQueue();
        featuresDropdown.style.display = 'none';
        featuresButton.setAttribute('aria-expanded', 'false');
      });

      darkModeToggle.addEventListener('change', e => {
        if (e.target.checked) {
          body.classList.add('light');
        } else {
          body.classList.remove('light');
        }
        // Update EQ popup and mini player colors if open
        if (eqPopup) {
          eqPopup.style.background = body.classList.contains('light') ? '#fafafa' : '#222';
          eqPopup.style.color = body.classList.contains('light') ? '#111' : '#eee';
        }
        if (miniPlayerWindow && !miniPlayerWindow.closed) {
          miniPlayerWindow.document.body.style.backgroundColor = body.classList.contains('light') ? '#fafafa' : '#121212';
          miniPlayerWindow.document.body.style.color = body.classList.contains('light') ? '#111' : '#eee';
        }
      });

      openEqBtn.addEventListener('click', () => {
        createEQPopup().style.display = 'flex';
        featuresDropdown.style.display = 'none';
        featuresButton.setAttribute('aria-expanded', 'false');
      });

      // Keyboard navigation for table headers for sorting
      let currentSortColumn = null;
      let currentSortAsc = true;

      function sortSongs(column) {
        if (currentSortColumn === column) currentSortAsc = !currentSortAsc;
        else {
          currentSortColumn = column;
          currentSortAsc = true;
        }
        filteredSongs.sort((a,b) => {
          let valA = a[column].toLowerCase();
          let valB = b[column].toLowerCase();
          if(column === 'duration'){
            valA = a.duration;
            valB = b.duration;
          }
          if(valA < valB) return currentSortAsc ? -1 : 1;
          if(valA > valB) return currentSortAsc ? 1 : -1;
          return 0;
        });
        // Update aria-sort attributes
        document.querySelectorAll('th').forEach(th => {
          th.setAttribute('aria-sort', 'none');
        });
        const th = document.querySelector(`th[data-sort="${column}"]`);
        if(th) th.setAttribute('aria-sort', currentSortAsc ? 'ascending' : 'descending');
        renderSongsTable();
      }

      document.querySelectorAll('th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
          sortSongs(th.dataset.sort);
        });
        th.addEventListener('keydown', e => {
          if(e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            sortSongs(th.dataset.sort);
          }
        });
      });

      // --- INIT ---
      loadAllSongs();

      // Start volume at 1
      audio.volume = 1;
      volumeSlider.value = 1;

      // Accessibility & focus helpers for queue list (optional)
      queueList.addEventListener('keydown', e => {
        const items = Array.from(queueList.children);
        let idx = items.findIndex(item => item === document.activeElement);
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          idx = (idx + 1) % items.length;
          items[idx]?.focus();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          idx = (idx - 1 + items.length) % items.length;
          items[idx]?.focus();
        }
      });

    })();
  </script>
</body>
</html>
