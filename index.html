<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>iTunes Desktop Replica - No Artwork + EQ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Reset */
    * {
      box-sizing: border-box;
    }
    body, html {
      margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      user-select: none;
      background: #121212;
      color: #eee;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }
    body.light {
      background: #f9f9f9;
      color: #111;
    }
    a {
      color: inherit;
      text-decoration: none;
    }
    button {
      cursor: pointer;
      background: none;
      border: none;
      color: inherit;
      font-size: 14px;
      font-weight: 600;
      transition: color 0.2s;
    }
    button:hover {
      color: #1db954;
    }
    /* Layout containers */
    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }
    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    /* Sidebar */
    .sidebar {
      width: 250px;
      background: #000;
      border-right: 1px solid #333;
      display: flex;
      flex-direction: column;
      padding: 20px 10px;
      transition: background 0.3s, color 0.3s;
    }
    body.light .sidebar {
      background: #f0f0f0;
      color: #111;
      border-color: #ccc;
    }
    .sidebar h2 {
      margin: 0 0 20px 0;
      font-size: 22px;
      font-weight: 900;
      color: #1db954;
      text-align: center;
      letter-spacing: 1.5px;
    }
    .sidebar button {
      display: block;
      width: 100%;
      padding: 10px 15px;
      text-align: left;
      border-radius: 4px;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sidebar button.active,
    .sidebar button:hover {
      background: #1db954;
      color: #000;
      font-weight: 700;
    }
    /* Playlist list */
    .playlist-list {
      margin-top: 20px;
      flex-grow: 1;
      overflow-y: auto;
    }
    .playlist-list button {
      padding-left: 25px;
      font-weight: 500;
      font-size: 14px;
    }
    /* Middle content (Library & song list) */
    .library {
      flex: 2;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #333;
      transition: background 0.3s, color 0.3s;
    }
    body.light .library {
      border-color: #ccc;
    }
    .library-header {
      padding: 10px 20px;
      background: #181818;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #333;
      transition: background 0.3s, border-color 0.3s;
      gap: 15px;
      flex-wrap: wrap;
    }
    body.light .library-header {
      background: #fff;
      border-color: #ccc;
      color: #111;
    }
    #toggleThemeBtn {
      background: #1db954;
      color: #000;
      font-weight: 700;
      padding: 8px 14px;
      border-radius: 18px;
      border: none;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s;
      flex-shrink: 0;
      white-space: nowrap;
    }
    #toggleThemeBtn:hover {
      background: #17a44c;
    }
    .library-header input[type="search"] {
      padding: 7px 15px;
      border-radius: 14px;
      border: none;
      flex-grow: 1;
      min-width: 200px;
      font-size: 14px;
      background: #282828;
      color: #eee;
      outline: none;
      transition: background 0.3s, color 0.3s;
    }
    body.light .library-header input[type="search"] {
      background: #eee;
      color: #111;
    }
    #btnNewPlaylist {
      background: #1db954;
      color: #000;
      font-weight: 700;
      padding: 8px 15px;
      border-radius: 18px;
      font-size: 14px;
      transition: background 0.3s;
      flex-shrink: 0;
      white-space: nowrap;
    }
    #btnNewPlaylist:hover {
      background: #17a44c;
    }
    /* Song Table */
    table {
      width: 100%;
      border-collapse: collapse;
      user-select: none;
      table-layout: fixed;
      flex-grow: 1;
      display: block;
      overflow-y: auto;
      height: calc(100% - 52px); /* Reserve header height */
    }
    thead {
      background: #282828;
      color: #bbb;
      font-size: 12px;
      font-weight: 700;
      display: table;
      width: 100%;
      table-layout: fixed;
    }
    body.light thead {
      background: #ddd;
      color: #555;
    }
    tbody {
      display: block;
      max-height: calc(100vh - 220px); /* adjust for header and footer */
      overflow-y: auto;
      width: 100%;
    }
    th, td {
      padding: 10px 12px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      vertical-align: middle;
      cursor: default;
      display: table-cell;
    }
    th {
      text-align: left;
      user-select: text;
    }
    tbody tr {
      border-bottom: 1px solid #282828;
      transition: background 0.2s;
      display: table;
      width: 100%;
      table-layout: fixed;
    }
    body.light tbody tr {
      border-color: #ccc;
    }
    tbody tr:hover {
      background: #1db954;
      color: #000;
    }
    tbody tr.selected {
      background: #1db954;
      color: #000;
      font-weight: 700;
    }
    tbody tr.selected:hover {
      background: #17a44c;
    }
    /* Table column widths */
    th.name, td.name {
      width: 35%;
    }
    th.artist, td.artist {
      width: 25%;
    }
    th.album, td.album {
      width: 25%;
    }
    th.duration, td.duration {
      width: 15%;
      text-align: right;
      padding-right: 20px;
      font-variant-numeric: tabular-nums;
    }
    /* Right sidebar (Up Next queue) */
    .queue {
      width: 300px;
      background: #000;
      display: flex;
      flex-direction: column;
      padding: 20px 10px;
      transition: background 0.3s, color 0.3s;
    }
    body.light .queue {
      background: #f0f0f0;
      color: #111;
    }
    .queue h3 {
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 10px 0;
      text-align: center;
      color: #1db954;
    }
    .queue-list {
      flex-grow: 1;
      overflow-y: auto;
    }
    .queue-item {
      padding: 8px 10px;
      border-bottom: 1px solid #282828;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      transition: background 0.2s;
    }
    body.light .queue-item {
      border-color: #ccc;
    }
    .queue-item:hover {
      background: #1db954;
      color: #000;
    }
    .queue-item.selected {
      background: #1db954;
      font-weight: 700;
      color: #000;
    }
    .queue-item span {
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      width: 90%;
    }
    .queue-item button {
      background: none;
      border: none;
      color: #1db954;
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      user-select: none;
    }
    /* Bottom now playing bar */
    .now-playing-bar {
      height: 120px;
      background: #181818;
      border-top: 1px solid #333;
      display: flex;
      align-items: center;
      padding: 0 25px;
      color: #eee;
      user-select: none;
      transition: background 0.3s, color 0.3s;
      gap: 20px;
      flex-wrap: wrap;
    }
    body.light .now-playing-bar {
      background: #f9f9f9;
      border-color: #ccc;
      color: #111;
    }
    .now-playing-info {
      flex: 1 1 300px;
      overflow: hidden;
      min-width: 200px;
    }
    .now-playing-title {
      font-weight: 700;
      font-size: 18px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 6px;
    }
    .now-playing-artist {
      font-size: 14px;
      color: #888;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    body.light .now-playing-artist {
      color: #666;
    }
    .player-controls {
      display: flex;
      align-items: center;
      gap: 20px;
      user-select: none;
      flex-shrink: 0;
    }
    .player-controls button {
      background: none;
      border: none;
      font-size: 28px;
      color: inherit;
      cursor: pointer;
      transition: color 0.3s;
      user-select: none;
    }
    .player-controls button:hover {
      color: #1db954;
    }
    .progress-container {
      flex-grow: 2;
      min-width: 250px;
      display: flex;
      flex-direction: column;
      user-select: none;
    }
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #333;
      border-radius: 4px;
      cursor: pointer;
      position: relative;
      margin-bottom: 6px;
    }
    .progress-filled {
      height: 100%;
      background: #1db954;
      border-radius: 4px;
      width: 0%;
      transition: width 0.1s linear;
    }
    .time-container {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #888;
    }
    body.light .time-container {
      color: #666;
    }
    .volume-container {
      width: 150px;
      display: flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }
    .volume-slider {
      -webkit-appearance: none;
      width: 100px;
      height: 4px;
      background: #333;
      border-radius: 4px;
      cursor: pointer;
      outline: none;
      transition: background 0.3s;
    }
    .volume-slider:hover {
      background: #1db954;
    }
    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #1db954;
      cursor: pointer;
      transition: background 0.3s;
      border: none;
    }
    .volume-slider::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #1db954;
      cursor: pointer;
      border: none;
    }
    /* Features menu button */
    #featuresBtn {
      background: #1db954;
      color: #000;
      font-weight: 700;
      padding: 8px 14px;
      border-radius: 18px;
      border: none;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s;
      white-space: nowrap;
      position: relative;
      margin-left: 15px;
    }
    #featuresBtn:hover {
      background: #17a44c;
    }
    /* Features dropdown */
    #featuresMenu {
      position: absolute;
      top: 100%;
      left: 0;
      background: #282828;
      border-radius: 8px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
      overflow: hidden;
      margin-top: 8px;
      display: none;
      min-width: 140px;
      z-index: 1000;
    }
    #featuresMenu button {
      display: block;
      width: 100%;
      padding: 10px 15px;
      font-size: 14px;
      text-align: left;
      border-radius: 0;
      border: none;
      color: #eee;
      background: none;
      transition: background 0.2s;
    }
    #featuresMenu button:hover {
      background: #1db954;
      color: #000;
    }
    /* EQ panel */
    #eqPanel {
      position: fixed;
      width: 320px;
      height: 220px;
      background: #181818;
      border: 1px solid #1db954;
      border-radius: 12px;
      padding: 15px 20px;
      color: #eee;
      box-shadow: 0 0 12px #1db954aa;
      top: 150px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      z-index: 2000;
      user-select: none;
      cursor: move;
    }
    #eqPanel h3 {
      margin: 0 0 12px 0;
      font-weight: 700;
      font-size: 18px;
      text-align: center;
      color: #1db954;
    }
    #eqCloseBtn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      color: #1db954;
      background: none;
      border: none;
    }
    #eqCloseBtn:hover {
      color: #17a44c;
    }
    .eq-slider-container {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      gap: 8px;
    }
    .eq-slider {
      -webkit-appearance: none;
      appearance: none;
      width: 28px;
      height: 140px;
      background: #333;
      border-radius: 6px;
      cursor: pointer;
      writing-mode: vertical-lr;
      direction: rtl;
      transition: background 0.3s;
    }
    .eq-slider:hover {
      background: #1db954;
    }
    .eq-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #1db954;
      cursor: pointer;
      border: none;
      transition: background 0.3s;
    }
    .eq-slider::-moz-range-thumb {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #1db954;
      cursor: pointer;
      border: none;
      transition: background 0.3s;
    }
    /* EQ label below sliders */
    .eq-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 12px;
      user-select: none;
      color: #aaa;
    }
    body.light #eqPanel {
      background: #f9f9f9;
      color: #111;
      border-color: #17a44c;
      box-shadow: 0 0 12px #17a44caa;
    }
    body.light #eqCloseBtn {
      color: #17a44c;
    }
    body.light #eqCloseBtn:hover {
      color: #15912b;
    }
    body.light .eq-slider {
      background: #ddd;
    }
    body.light .eq-slider:hover {
      background: #17a44c;
    }
    body.light .eq-slider::-webkit-slider-thumb {
      background: #17a44c;
    }
    body.light .eq-slider::-moz-range-thumb {
      background: #17a44c;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <h2>iTunes</h2>
      <!-- Sidebar buttons example -->
      <button id="btnLibrary" class="active">Library</button>
      <div class="playlist-list" id="playlistList">
        <!-- For future playlists if you want -->
      </div>
    </div>
    <div class="main-content">
      <div class="library">
        <div class="library-header">
          <button id="toggleThemeBtn" title="Toggle Dark/Light Mode">Light Mode</button>
          <input type="search" id="searchInput" placeholder="Search Songs…" />
          <button id="featuresBtn" aria-haspopup="true" aria-expanded="false">Features ▼</button>
          <div id="featuresMenu" role="menu" aria-label="Features menu">
            <button id="toggleEQBtn" role="menuitem">Equalizer</button>
          </div>
        </div>
        <table id="songTable" aria-label="Song Library">
          <thead>
            <tr>
              <th class="name">Name</th>
              <th class="artist">Artist</th>
              <th class="album">Album</th>
              <th class="duration">Duration</th>
            </tr>
          </thead>
          <tbody>
            <!-- Songs loaded dynamically -->
          </tbody>
        </table>
      </div>
      <div class="queue" aria-label="Up Next Queue">
        <h3>Up Next</h3>
        <div class="queue-list" id="queueList">
          <!-- Queue songs -->
        </div>
      </div>
    </div>
    <div class="now-playing-bar" aria-label="Now Playing Controls">
      <div class="now-playing-info" aria-live="polite" aria-atomic="true">
        <div class="now-playing-title" id="nowPlayingTitle">Not Playing</div>
        <div class="now-playing-artist" id="nowPlayingArtist">-</div>
      </div>
      <div class="player-controls">
        <button id="prevBtn" title="Previous Track" aria-label="Previous Track">⏮</button>
        <button id="playPauseBtn" title="Play/Pause" aria-label="Play/Pause">▶️</button>
        <button id="nextBtn" title="Next Track" aria-label="Next Track">⏭</button>
      </div>
      <div class="progress-container" aria-label="Progress Bar" role="slider" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" tabindex="0">
        <div class="progress-bar" id="progressBar">
          <div class="progress-filled" id="progressFilled"></div>
        </div>
        <div class="time-container">
          <span id="currentTime">0:00</span>
          <span id="totalTime">0:00</span>
        </div>
      </div>
      <div class="volume-container" aria-label="Volume Control">
        <svg id="volumeIcon" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false" viewBox="0 0 24 24"><polygon points="3 9 9 9 13 5 13 19 9 15 3 15 3 9"></polygon><path d="M16.5 12a4.5 4.5 0 0 1 0 0"></path></svg>
        <input type="range" min="0" max="1" step="0.01" class="volume-slider" id="volumeSlider" aria-label="Volume Slider" />
      </div>
    </div>
  </div>

  <!-- Equalizer Panel -->
  <div id="eqPanel" role="dialog" aria-modal="true" aria-labelledby="eqTitle" tabindex="-1">
    <button id="eqCloseBtn" aria-label="Close Equalizer">&times;</button>
    <h3 id="eqTitle">Equalizer</h3>
    <div class="eq-slider-container">
      <input type="range" min="-12" max="12" value="0" step="1" class="eq-slider" id="eq60Hz" aria-label="60 Hz" />
      <input type="range" min="-12" max="12" value="0" step="1" class="eq-slider" id="eq170Hz" aria-label="170 Hz" />
      <input type="range" min="-12" max="12" value="0" step="1" class="eq-slider" id="eq310Hz" aria-label="310 Hz" />
      <input type="range" min="-12" max="12" value="0" step="1" class="eq-slider" id="eq600Hz" aria-label="600 Hz" />
      <input type="range" min="-12" max="12" value="0" step="1" class="eq-slider" id="eq1kHz" aria-label="1 kHz" />
      <input type="range" min="-12" max="12" value="0" step="1" class="eq-slider" id="eq3kHz" aria-label="3 kHz" />
      <input type="range" min="-12" max="12" value="0" step="1" class="eq-slider" id="eq6kHz" aria-label="6 kHz" />
      <input type="range" min="-12" max="12" value="0" step="1" class="eq-slider" id="eq12kHz" aria-label="12 kHz" />
      <input type="range" min="-12" max="12" value="0" step="1" class="eq-slider" id="eq14kHz" aria-label="14 kHz" />
      <input type="range" min="-12" max="12" value="0" step="1" class="eq-slider" id="eq16kHz" aria-label="16 kHz" />
    </div>
    <div class="eq-labels">
      <span>60</span><span>170</span><span>310</span><span>600</span><span>1k</span><span>3k</span><span>6k</span><span>12k</span><span>14k</span><span>16k</span>
    </div>
  </div>

  <script>
    // Your Google API and Folder ID:
    const API_KEY = 'AIzaSyB3o_Axhv-7OtIUjv0FfN3j1qTvEUS7o8k'; // Replace with your actual Google API Key
    const FOLDER_ID = '1DGz9zEQh29EAqTZpmWK5mwSj5HComnkn';

    // Globals
    let songs = [];
    let filteredSongs = [];
    let currentIndex = -1;
    let audioContext, sourceNode, gainNode, analyserNode, eqFilters = [];
    let isPlaying = false;
    let audioElement = new Audio();
    audioElement.crossOrigin = "anonymous";
    let dragOffset = { x: 0, y: 0 };
    let isDragging = false;

    // Initialize UI elements
    const body = document.body;
    const toggleThemeBtn = document.getElementById('toggleThemeBtn');
    const searchInput = document.getElementById('searchInput');
    const songTableBody = document.querySelector('#songTable tbody');
    const nowPlayingTitle = document.getElementById('nowPlayingTitle');
    const nowPlayingArtist = document.getElementById('nowPlayingArtist');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const progressBar = document.getElementById('progressBar');
    const progressFilled = document.getElementById('progressFilled');
    const currentTimeEl = document.getElementById('currentTime');
    const totalTimeEl = document.getElementById('totalTime');
    const volumeSlider = document.getElementById('volumeSlider');
    const queueList = document.getElementById('queueList');
    const featuresBtn = document.getElementById('featuresBtn');
    const featuresMenu = document.getElementById('featuresMenu');
    const toggleEQBtn = document.getElementById('toggleEQBtn');
    const eqPanel = document.getElementById('eqPanel');
    const eqCloseBtn = document.getElementById('eqCloseBtn');

    // Setup theme from localStorage
    if(localStorage.getItem('theme') === 'light') {
      body.classList.add('light');
      toggleThemeBtn.textContent = 'Dark Mode';
    }

    toggleThemeBtn.addEventListener('click', () => {
      body.classList.toggle('light');
      if(body.classList.contains('light')) {
        toggleThemeBtn.textContent = 'Dark Mode';
        localStorage.setItem('theme', 'light');
      } else {
        toggleThemeBtn.textContent = 'Light Mode';
        localStorage.removeItem('theme');
      }
    });

    // Features menu toggle
    featuresBtn.addEventListener('click', () => {
      const visible = featuresMenu.style.display === 'block';
      featuresMenu.style.display = visible ? 'none' : 'block';
      featuresBtn.setAttribute('aria-expanded', String(!visible));
    });
    // Close features menu if clicked outside
    document.addEventListener('click', (e) => {
      if (!featuresBtn.contains(e.target) && !featuresMenu.contains(e.target)) {
        featuresMenu.style.display = 'none';
        featuresBtn.setAttribute('aria-expanded', 'false');
      }
    });

    // Equalizer panel toggle
    toggleEQBtn.addEventListener('click', () => {
      featuresMenu.style.display = 'none';
      featuresBtn.setAttribute('aria-expanded', 'false');
      if(eqPanel.style.display === 'block') {
        eqPanel.style.display = 'none';
      } else {
        eqPanel.style.display = 'block';
        eqPanel.focus();
      }
    });

    eqCloseBtn.addEventListener('click', () => {
      eqPanel.style.display = 'none';
    });

    // Drag for EQ panel
    eqPanel.addEventListener('mousedown', (e) => {
      if (e.target === eqCloseBtn) return;
      isDragging = true;
      dragOffset.x = e.clientX - eqPanel.offsetLeft;
      dragOffset.y = e.clientY - eqPanel.offsetTop;
      eqPanel.style.cursor = 'grabbing';
      e.preventDefault();
    });
    document.addEventListener('mouseup', () => {
      isDragging = false;
      eqPanel.style.cursor = 'move';
    });
    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        eqPanel.style.left = (e.clientX - dragOffset.x) + 'px';
        eqPanel.style.top = (e.clientY - dragOffset.y) + 'px';
      }
    });

    // Fetch songs from Google Drive folder via Google Drive API
    async function fetchSongsFromDrive(pageToken = '') {
      const url = new URL('https://www.googleapis.com/drive/v3/files');
      url.searchParams.append('q', `'${FOLDER_ID}' in parents and mimeType contains 'audio/' and trashed = false`);
      url.searchParams.append('fields', 'nextPageToken, files(id, name, mimeType)');
      url.searchParams.append('key', API_KEY);
      if(pageToken) {
        url.searchParams.append('pageToken', pageToken);
      }
      const res = await fetch(url.toString());
      if(!res.ok) throw new Error('Failed to fetch from Google Drive API');
      return res.json();
    }

    // Load all songs, paginated
    async function loadAllSongs() {
      songs = [];
      let nextPageToken = '';
      do {
        try {
          const data = await fetchSongsFromDrive(nextPageToken);
          songs.push(...data.files.map(f => ({
            id: f.id,
            name: f.name,
            url: `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media&key=${API_KEY}`,
            artist: 'Unknown Artist',
            album: 'Unknown Album',
            duration: 0 // Will update later
          })));
          nextPageToken = data.nextPageToken || '';
        } catch (err) {
          console.error(err);
          break;
        }
      } while (nextPageToken);
      filteredSongs = [...songs];
      await updateDurations();
      renderSongTable();
    }

    // Format seconds to MM:SS
    function formatDuration(seconds) {
      const m = Math.floor(seconds / 60);
      const s = Math.floor(seconds % 60);
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    // Update durations by loading audio metadata
    async function updateDurations() {
      const promises = songs.map((song, idx) => new Promise(resolve => {
        const audio = new Audio();
        audio.src = song.url;
        audio.addEventListener('loadedmetadata', () => {
          songs[idx].duration = audio.duration || 0;
          resolve();
        });
        audio.addEventListener('error', () => {
          songs[idx].duration = 0;
          resolve();
        });
      }));
      await Promise.all(promises);
    }

    // Render song table rows
    function renderSongTable() {
      songTableBody.innerHTML = '';
      filteredSongs.forEach((song, idx) => {
        const tr = document.createElement('tr');
        tr.tabIndex = 0;
        tr.setAttribute('role', 'row');
        tr.dataset.index = idx;
        tr.innerHTML = `
          <td class="name">${song.name}</td>
          <td class="artist">${song.artist}</td>
          <td class="album">${song.album}</td>
          <td class="duration">${formatDuration(song.duration)}</td>
        `;
        tr.addEventListener('click', () => {
          selectSong(idx);
          playCurrent();
        });
        tr.addEventListener('keydown', e => {
          if(e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            selectSong(idx);
            playCurrent();
          }
        });
        songTableBody.appendChild(tr);
      });
    }

    // Select song visually
    function selectSong(idx) {
      currentIndex = idx;
      [...songTableBody.children].forEach((row, i) => {
        row.classList.toggle('selected', i === idx);
      });
      updateNowPlayingInfo();
    }

    // Update Now Playing info bar
    function updateNowPlayingInfo() {
      if(currentIndex < 0 || !songs[currentIndex]) {
        nowPlayingTitle.textContent = 'Not Playing';
        nowPlayingArtist.textContent = '-';
      } else {
        nowPlayingTitle.textContent = songs[currentIndex].name;
        nowPlayingArtist.textContent = songs[currentIndex].artist;
      }
    }

    // Play current song
    function playCurrent() {
      if(currentIndex < 0 || !songs[currentIndex]) return;
      const song = songs[currentIndex];
      audioElement.src = song.url;
      audioElement.play();
      isPlaying = true;
      playPauseBtn.textContent = '⏸️';
      updateNowPlayingInfo();
      updateQueueUI();
    }

    // Pause playback
    function pausePlayback() {
      audioElement.pause();
      isPlaying = false;
      playPauseBtn.textContent = '▶️';
    }

    // Toggle play/pause
    playPauseBtn.addEventListener('click', () => {
      if(isPlaying) pausePlayback();
      else if(currentIndex < 0 && songs.length > 0) {
        selectSong(0);
        playCurrent();
      } else {
        audioElement.play();
        isPlaying = true;
        playPauseBtn.textContent = '⏸️';
      }
    });

    // Prev track
    prevBtn.addEventListener('click', () => {
      if(currentIndex <= 0) {
        selectSong(songs.length - 1);
      } else {
        selectSong(currentIndex - 1);
      }
      playCurrent();
    });

    // Next track
    nextBtn.addEventListener('click', () => {
      if(currentIndex >= songs.length - 1) {
        selectSong(0);
      } else {
        selectSong(currentIndex + 1);
      }
      playCurrent();
    });

    // Update progress bar as audio plays
    audioElement.addEventListener('timeupdate', () => {
      if(audioElement.duration) {
        const percent = (audioElement.currentTime / audioElement.duration) * 100;
        progressFilled.style.width = percent + '%';
        currentTimeEl.textContent = formatDuration(audioElement.currentTime);
        totalTimeEl.textContent = formatDuration(audioElement.duration);
      }
    });

    // Seek audio on progress bar click
    progressBar.addEventListener('click', e => {
      const rect = progressBar.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const width = rect.width;
      const seekTime = (clickX / width) * audioElement.duration;
      audioElement.currentTime = seekTime;
    });

    // Volume control
    volumeSlider.value = 0.8;
    audioElement.volume = 0.8;
    volumeSlider.addEventListener('input', () => {
      audioElement.volume = volumeSlider.value;
    });

    // Keyboard shortcuts: space toggles play/pause
    document.addEventListener('keydown', e => {
      if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if(e.code === 'Space') {
        e.preventDefault();
        playPauseBtn.click();
      }
    });

    // Search filter
    searchInput.addEventListener('input', () => {
      const val = searchInput.value.toLowerCase();
      filteredSongs = songs.filter(s => 
        s.name.toLowerCase().includes(val) ||
        s.artist.toLowerCase().includes(val) ||
        s.album.toLowerCase().includes(val)
      );
      renderSongTable();
    });

    // Queue management
    function updateQueueUI() {
      queueList.innerHTML = '';
      if(currentIndex < 0) return;
      // Show next 5 songs
      let nextSongs = [];
      for(let i = 1; i <= 5; i++) {
        let idx = (currentIndex + i) % songs.length;
        nextSongs.push(songs[idx]);
      }
      nextSongs.forEach((song, idx) => {
        const div = document.createElement('div');
        div.className = 'queue-item';
        div.tabIndex = 0;
        div.textContent = song.name + ' — ' + song.artist;
        div.addEventListener('click', () => {
          selectSong((currentIndex + idx + 1) % songs.length);
          playCurrent();
        });
        queueList.appendChild(div);
      });
    }

    // Audio Context and Equalizer setup
    function setupAudioContext() {
      if(audioContext) return; // already setup
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      sourceNode = audioContext.createMediaElementSource(audioElement);
      gainNode = audioContext.createGain();
      analyserNode = audioContext.createAnalyser();

      // Create filters for EQ bands
      const frequencies = [60, 170, 310, 600, 1000, 3000, 6000, 12000, 14000, 16000];
      eqFilters = frequencies.map(freq => {
        const filter = audioContext.createBiquadFilter();
        filter.type = 'peaking';
        filter.frequency.value = freq;
        filter.Q.value = 1;
        filter.gain.value = 0;
        return filter;
      });

      // Connect filters in series
      sourceNode.connect(eqFilters[0]);
      for(let i = 0; i < eqFilters.length - 1; i++) {
        eqFilters[i].connect(eqFilters[i + 1]);
      }
      eqFilters[eqFilters.length - 1].connect(gainNode);
      gainNode.connect(analyserNode);
      analyserNode.connect(audioContext.destination);
    }

    // Connect sliders to EQ filters
    function setupEQControls() {
      const eqIds = ['eq60Hz', 'eq170Hz', 'eq310Hz', 'eq600Hz', 'eq1kHz', 'eq3kHz', 'eq6kHz', 'eq12kHz', 'eq14kHz', 'eq16kHz'];
      eqIds.forEach((id, idx) => {
        const slider = document.getElementById(id);
        slider.addEventListener('input', () => {
          eqFilters[idx].gain.value = slider.value;
        });
      });
    }

    // Initialize app
    async function init() {
      setupAudioContext();
      setupEQControls();
      await loadAllSongs();
      updateQueueUI();
      updateNowPlayingInfo();
    }

    // Start initialization
    init();

  </script>
</body>
</html>
