<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>iTunes Desktop Replica - No Artwork + EQ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Reset */
    * {
      box-sizing: border-box;
    }
    body, html {
      margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      user-select: none;
      background: #121212;
      color: #eee;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }
    body.light {
      background: #f9f9f9;
      color: #111;
    }
    a {
      color: inherit;
      text-decoration: none;
    }
    button {
      cursor: pointer;
      background: none;
      border: none;
      color: inherit;
      font-size: 14px;
      font-weight: 600;
      transition: color 0.2s;
    }
    button:hover {
      color: #1db954;
    }
    /* Layout containers */
    .app {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100vw;
      overflow: hidden;
    }
    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    /* Sidebar */
    .sidebar {
      width: 250px;
      background: #000;
      border-right: 1px solid #333;
      display: flex;
      flex-direction: column;
      padding: 20px 10px;
      transition: background 0.3s, color 0.3s;
    }
    body.light .sidebar {
      background: #f0f0f0;
      color: #111;
      border-color: #ccc;
    }
    .sidebar h2 {
      margin: 0 0 20px 0;
      font-size: 22px;
      font-weight: 900;
      color: #1db954;
      text-align: center;
      letter-spacing: 1.5px;
    }
    .sidebar button {
      display: block;
      width: 100%;
      padding: 10px 15px;
      text-align: left;
      border-radius: 4px;
      margin-bottom: 5px;
    }
    .sidebar button.active,
    .sidebar button:hover {
      background: #1db954;
      color: #000;
      font-weight: 700;
    }
    /* Playlist list */
    .playlist-list {
      margin-top: 20px;
      flex-grow: 1;
      overflow-y: auto;
    }
    .playlist-list button {
      padding-left: 25px;
      font-weight: 500;
      font-size: 14px;
    }
    /* Middle content (Library & song list) */
    .library {
      flex: 2;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #333;
      transition: background 0.3s, color 0.3s;
    }
    body.light .library {
      border-color: #ccc;
    }
    .library-header {
      padding: 10px 20px;
      background: #181818;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #333;
      transition: background 0.3s, border-color 0.3s;
      gap: 15px;
      flex-wrap: wrap;
    }
    body.light .library-header {
      background: #fff;
      border-color: #ccc;
      color: #111;
    }
    #toggleThemeBtn {
      background: #1db954;
      color: #000;
      font-weight: 700;
      padding: 8px 14px;
      border-radius: 18px;
      border: none;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s;
      flex-shrink: 0;
      white-space: nowrap;
    }
    #toggleThemeBtn:hover {
      background: #17a44c;
    }
    .library-header input[type="search"] {
      padding: 7px 15px;
      border-radius: 14px;
      border: none;
      flex-grow: 1;
      min-width: 200px;
      font-size: 14px;
      background: #282828;
      color: #eee;
      outline: none;
      transition: background 0.3s, color 0.3s;
    }
    body.light .library-header input[type="search"] {
      background: #eee;
      color: #111;
    }
    #btnNewPlaylist {
      background: #1db954;
      color: #000;
      font-weight: 700;
      padding: 8px 15px;
      border-radius: 18px;
      font-size: 14px;
      transition: background 0.3s;
      flex-shrink: 0;
      white-space: nowrap;
    }
    #btnNewPlaylist:hover {
      background: #17a44c;
    }
    /* Song Table */
    table {
      width: 100%;
      border-collapse: collapse;
      user-select: none;
      table-layout: fixed;
      flex-grow: 1;
      display: block;
      overflow-y: auto;
      height: calc(100% - 52px); /* Reserve header height */
    }
    thead {
      background: #282828;
      color: #bbb;
      font-size: 12px;
      font-weight: 700;
      display: table;
      width: 100%;
      table-layout: fixed;
    }
    body.light thead {
      background: #ddd;
      color: #555;
    }
    tbody {
      display: block;
      max-height: calc(100vh - 220px); /* adjust for header and footer */
      overflow-y: auto;
      width: 100%;
    }
    th, td {
      padding: 10px 12px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      vertical-align: middle;
      cursor: default;
      display: table-cell;
    }
    th {
      text-align: left;
      user-select: text;
    }
    tbody tr {
      border-bottom: 1px solid #282828;
      transition: background 0.2s;
      display: table;
      width: 100%;
      table-layout: fixed;
    }
    body.light tbody tr {
      border-color: #ccc;
    }
    tbody tr:hover {
      background: #1db954;
      color: #000;
    }
    tbody tr.selected {
      background: #1db954;
      color: #000;
      font-weight: 700;
    }
    tbody tr.selected:hover {
      background: #17a44c;
    }
    /* Table column widths */
    th.name, td.name {
      width: 35%;
    }
    th.artist, td.artist {
      width: 25%;
    }
    th.album, td.album {
      width: 25%;
    }
    th.duration, td.duration {
      width: 15%;
      text-align: right;
      padding-right: 20px;
      font-variant-numeric: tabular-nums;
    }
    /* Right sidebar (Up Next queue) */
    .queue {
      width: 300px;
      background: #000;
      display: flex;
      flex-direction: column;
      padding: 20px 10px;
      transition: background 0.3s, color 0.3s;
    }
    body.light .queue {
      background: #f0f0f0;
      color: #111;
    }
    .queue h3 {
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 10px 0;
      text-align: center;
      color: #1db954;
    }
    .queue-list {
      flex-grow: 1;
      overflow-y: auto;
    }
    .queue-item {
      padding: 8px 10px;
      border-bottom: 1px solid #282828;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      transition: background 0.2s;
    }
    body.light .queue-item {
      border-color: #ccc;
    }
    .queue-item:hover {
      background: #1db954;
      color: #000;
    }
    .queue-item.selected {
      background: #1db954;
      font-weight: 700;
      color: #000;
    }
    .queue-item span {
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      width: 90%;
    }
    .queue-item button {
      background: none;
      border: none;
      color: #1db954;
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      user-select: none;
    }
    /* Bottom now playing bar */
    .now-playing-bar {
      height: 120px;
      background: #181818;
      border-top: 1px solid #333;
      display: flex;
      align-items: center;
      padding: 0 25px;
      color: #eee;
      user-select: none;
      transition: background 0.3s, color 0.3s;
      gap: 20px;
      flex-wrap: wrap;
    }
    body.light .now-playing-bar {
      background: #f9f9f9;
      border-color: #ccc;
      color: #111;
    }
    .now-playing-info {
      flex: 1 1 300px;
      overflow: hidden;
      min-width: 200px;
    }
    .now-playing-title {
      font-weight: 700;
      font-size: 18px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 6px;
    }
    .now-playing-artist {
      font-size: 14px;
      color: #888;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    body.light .now-playing-artist {
      color: #666;
    }
    .player-controls {
      display: flex;
      align-items: center;
      gap: 20px;
      user-select: none;
      flex-shrink: 0;
    }
    .player-controls button {
      background: none;
      border: none;
      font-size: 28px;
      color: inherit;
      cursor: pointer;
      transition: color 0.3s;
      user-select: none;
    }
    .player-controls button:hover {
      color: #1db954;
    }
    .progress-container {
      flex-grow: 2;
      min-width: 250px;
      display: flex;
      flex-direction: column;
      user-select: none;
    }
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #333;
      border-radius: 4px;
      cursor: pointer;
      position: relative;
      margin-bottom: 6px;
    }
    .progress-filled {
      height: 100%;
      background: #1db954;
      border-radius: 4px;
      width: 0%;
      transition: width 0.1s linear;
    }
    .time-container {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #888;
    }
    body.light .time-container {
      color: #666;
    }
    .volume-container {
      width: 150px;
      display: flex;
      align-items: center;
      gap: 6px;
      user-select: none;
      flex-shrink: 0;
      min-width: 150px;
    }
    .volume-slider {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 5px;
      background: #333;
      outline: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #1db954;
      cursor: pointer;
      transition: background 0.3s;
    }
    .volume-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #1db954;
      cursor: pointer;
      transition: background 0.3s;
    }
    /* Equalizer controls */
    .equalizer {
      display: flex;
      gap: 12px;
      align-items: center;
      min-width: 220px;
      flex-shrink: 0;
      color: #bbb;
    }
    body.light .equalizer {
      color: #444;
    }
    .eq-control {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 10px;
      user-select: none;
    }
    .eq-control label {
      margin-bottom: 4px;
      font-weight: 600;
      color: inherit;
    }
    .eq-slider {
      -webkit-appearance: none;
      width: 40px;
      height: 100px;
      background: #333;
      border-radius: 8px;
      cursor: pointer;
      transform: rotate(-90deg);
      margin-bottom: 6px;
    }
    .eq-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #1db954;
      cursor: pointer;
      transition: background 0.3s;
    }
    .eq-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #1db954;
      cursor: pointer;
      transition: background 0.3s;
    }
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background-color: #1db954;
      border-radius: 4px;
    }
    /* Responsive */
    @media (max-width: 900px) {
      .queue {
        display: none;
      }
      .library-header {
        gap: 10px;
      }
      .equalizer {
        min-width: 150px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="main-content">
      <nav class="sidebar" id="sidebar">
        <h2>Library</h2>
        <button id="btnAllSongs" class="active">All Songs</button>
        <div class="playlist-list" id="playlists"></div>
      </nav>
      <section class="library">
        <div class="library-header">
          <button id="toggleThemeBtn" aria-label="Toggle light/dark mode">Toggle Light/Dark</button>
          <input type="search" id="searchInput" placeholder="Search" autocomplete="off" aria-label="Search songs"/>
          <button id="btnNewPlaylist">New Playlist</button>
        </div>
        <table id="songsTable" tabindex="0" aria-label="Songs List">
          <thead>
            <tr>
              <th class="name" title="Song Name">Name</th>
              <th class="artist" title="Artist">Artist</th>
              <th class="album" title="Album">Album</th>
              <th class="duration" title="Duration">Time</th>
            </tr>
          </thead>
          <tbody id="songsBody">
            <!-- Songs go here -->
          </tbody>
        </table>
      </section>
      <aside class="queue">
        <h3>Up Next</h3>
        <div class="queue-list" id="queueList">
          <!-- Queue songs -->
        </div>
      </aside>
    </div>
    <footer class="now-playing-bar" aria-label="Now playing controls">
      <div class="now-playing-info" id="nowPlayingInfo">
        <div class="now-playing-title" id="nowPlayingTitle">No song selected</div>
        <div class="now-playing-artist" id="nowPlayingArtist">&nbsp;</div>
      </div>
      <div class="player-controls" role="group" aria-label="Playback controls">
        <button id="btnPrev" title="Previous" aria-label="Previous track">⏮️</button>
        <button id="btnPlayPause" title="Play" aria-label="Play/Pause">▶️</button>
        <button id="btnNext" title="Next" aria-label="Next track">⏭️</button>
        <button id="btnShuffle" title="Shuffle" aria-label="Shuffle playlist">🔀</button>
      </div>
      <div class="progress-container" id="progressContainer" aria-label="Playback progress" role="slider" tabindex="0">
        <div class="progress-bar" id="progressBar">
          <div class="progress-filled" id="progressFilled"></div>
        </div>
        <div class="time-container">
          <span id="currentTime">0:00</span>
          <span id="durationTime">0:00</span>
        </div>
      </div>
      <div class="volume-container" title="Volume control">
        <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.01" value="0.7" aria-label="Volume control"/>
      </div>
      <div class="equalizer" aria-label="Equalizer controls">
        <div class="eq-control">
          <label for="bassSlider">Bass</label>
          <input type="range" id="bassSlider" class="eq-slider" min="-15" max="15" step="1" value="0" aria-valuemin="-15" aria-valuemax="15" aria-valuenow="0" aria-label="Bass level"/>
        </div>
        <div class="eq-control">
          <label for="midSlider">Mid</label>
          <input type="range" id="midSlider" class="eq-slider" min="-15" max="15" step="1" value="0" aria-label="Mid level"/>
        </div>
        <div class="eq-control">
          <label for="trebleSlider">Treble</label>
          <input type="range" id="trebleSlider" class="eq-slider" min="-15" max="15" step="1" value="0" aria-label="Treble level"/>
        </div>
      </div>
    </footer>
  </div>

  <script>
    // Globals
    const folderId = '1DGz9zEQh29EAqTZpmWK5mwSj5HComnkn'; // Put your Google Drive folder ID here
    const apiKey = 'AIzaSyDsYE91wH7UDwu8eZNbD1CFuVcilgYeZhI'; // Put your Google API key here

    const playlistsDiv = document.getElementById('playlists');
    const songsBody = document.getElementById('songsBody');
    const queueList = document.getElementById('queueList');
    const btnAllSongs = document.getElementById('btnAllSongs');
    const btnNewPlaylist = document.getElementById('btnNewPlaylist');
    const searchInput = document.getElementById('searchInput');
    const btnPlayPause = document.getElementById('btnPlayPause');
    const btnNext = document.getElementById('btnNext');
    const btnPrev = document.getElementById('btnPrev');
    const btnShuffle = document.getElementById('btnShuffle');
    const toggleThemeBtn = document.getElementById('toggleThemeBtn');
    const volumeSlider = document.getElementById('volumeSlider');
    const progressBar = document.getElementById('progressBar');
    const progressFilled = document.getElementById('progressFilled');
    const currentTimeElem = document.getElementById('currentTime');
    const durationTimeElem = document.getElementById('durationTime');
    const progressContainer = document.getElementById('progressContainer');
    const nowPlayingTitle = document.getElementById('nowPlayingTitle');
    const nowPlayingArtist = document.getElementById('nowPlayingArtist');
    const bassSlider = document.getElementById('bassSlider');
    const midSlider = document.getElementById('midSlider');
    const trebleSlider = document.getElementById('trebleSlider');

    // Audio & WebAudio setup
    let audioCtx, audioSource, gainNode;
    let bassFilter, midFilter, trebleFilter;
    let audio = new Audio();
    let isPlaying = false;

    // Initialize Web Audio API context and filters for EQ
    function setupAudioContext() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        audioSource = audioCtx.createMediaElementSource(audio);

        bassFilter = audioCtx.createBiquadFilter();
        bassFilter.type = 'lowshelf';
        bassFilter.frequency.value = 200;

        midFilter = audioCtx.createBiquadFilter();
        midFilter.type = 'peaking';
        midFilter.frequency.value = 1000;
        midFilter.Q.value = 1;

        trebleFilter = audioCtx.createBiquadFilter();
        trebleFilter.type = 'highshelf';
        trebleFilter.frequency.value = 3000;

        gainNode = audioCtx.createGain();

        audioSource.connect(bassFilter);
        bassFilter.connect(midFilter);
        midFilter.connect(trebleFilter);
        trebleFilter.connect(gainNode);
        gainNode.connect(audioCtx.destination);
      }
    }

    // Connect WebAudio on play
    audio.onplay = () => {
      setupAudioContext();
      if (audioCtx.state === 'suspended') audioCtx.resume();
    };

    // Adjust EQ filter gains from sliders
    bassSlider.addEventListener('input', () => {
      bassFilter.gain.value = parseFloat(bassSlider.value);
    });
    midSlider.addEventListener('input', () => {
      midFilter.gain.value = parseFloat(midSlider.value);
    });
    trebleSlider.addEventListener('input', () => {
      trebleFilter.gain.value = parseFloat(trebleSlider.value);
    });

    // Tracks & playlists
    let tracks = [];
    let filteredTracks = [];
    let playlists = JSON.parse(localStorage.getItem('playlists') || '{}');
    let currentTrackIndex = -1;
    let queue = [];

    // Volume default
    audio.volume = parseFloat(volumeSlider.value);

    // Format seconds to mm:ss
    function formatDuration(seconds) {
      if (isNaN(seconds)) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }

    // Load tracks from Google Drive folder
    async function loadAllTracks() {
      let allFiles = [];
      let pageToken = '';
      try {
        do {
          const query = encodeURIComponent(`'${folderId}' in parents and (mimeType contains 'audio/')`);
          const url = `https://www.googleapis.com/drive/v3/files?q=${query}&fields=files(id,name,mimeType),nextPageToken&pageSize=100&key=${apiKey}${pageToken ? `&pageToken=${pageToken}` : ''}`;
          const res = await fetch(url);
          const data = await res.json();
          if (data.files) allFiles = allFiles.concat(data.files);
          pageToken = data.nextPageToken || '';
        } while (pageToken);

        allFiles.sort((a,b) => a.name.localeCompare(b.name));

        tracks = allFiles.map(f => ({
          id: f.id,
          name: f.name,
          artist: 'Unknown Artist',
          album: 'Unknown Album',
          duration: 0,
        }));

        filteredTracks = [...tracks];
        renderSongs();
      } catch (err) {
        console.error('Error loading tracks', err);
        nowPlayingTitle.textContent = 'Error loading tracks';
      }
    }

    // Render playlists in sidebar
    function renderPlaylists() {
      playlistsDiv.innerHTML = '';
      for (const plName in playlists) {
        const btn = document.createElement('button');
        btn.textContent = plName;
        btn.onclick = () => {
          filteredTracks = playlists[plName];
          currentTrackIndex = -1;
          renderSongs();
          highlightPlaylistButton(plName);
        };
        playlistsDiv.appendChild(btn);
      }
    }

    function highlightPlaylistButton(name) {
      [...playlistsDiv.children].forEach(btn => {
        btn.classList.toggle('active', btn.textContent === name);
      });
      btnAllSongs.classList.remove('active');
    }

    // Render songs table
    function renderSongs() {
      songsBody.innerHTML = '';
      filteredTracks.forEach((track, index) => {
        const tr = document.createElement('tr');
        tr.tabIndex = 0;
        tr.className = index === currentTrackIndex ? 'selected' : '';
        tr.onclick = () => playTrack(index);
        tr.onkeydown = (e) => { if(e.key === 'Enter') playTrack(index); };

        const tdName = document.createElement('td');
        tdName.className = 'name';
        tdName.textContent = track.name;

        const tdArtist = document.createElement('td');
        tdArtist.className = 'artist';
        tdArtist.textContent = track.artist;

        const tdAlbum = document.createElement('td');
        tdAlbum.className = 'album';
        tdAlbum.textContent = track.album;

        const tdDuration = document.createElement('td');
        tdDuration.className = 'duration';
        tdDuration.textContent = formatDuration(track.duration);

        tr.append(tdName, tdArtist, tdAlbum, tdDuration);
        songsBody.appendChild(tr);
      });
    }

    // Play track by index
    async function playTrack(index) {
      if (index < 0 || index >= filteredTracks.length) return;
      currentTrackIndex = index;
      const track = filteredTracks[index];
      audio.src = `https://www.googleapis.com/drive/v3/files/${track.id}?alt=media&key=${apiKey}`;
      audio.play().catch(() => {});
      isPlaying = true;
      btnPlayPause.textContent = '⏸️';
      nowPlayingTitle.textContent = track.name;
      nowPlayingArtist.textContent = `${track.artist} — ${track.album}`;
      updateSelectedSong();
      addToQueue(track);

      audio.onloadedmetadata = () => {
        track.duration = audio.duration;
        renderSongs();
      };
    }

    function updateSelectedSong() {
      [...songsBody.children].forEach((tr, i) => {
        tr.classList.toggle('selected', i === currentTrackIndex);
      });
    }

    function addToQueue(track) {
      if (!queue.find(t => t.id === track.id)) {
        queue.push(track);
        renderQueue();
      }
    }

    function renderQueue() {
      queueList.innerHTML = '';
      queue.forEach((track, i) => {
        const div = document.createElement('div');
        div.className = 'queue-item';
        div.textContent = track.name;
        if (i === currentTrackIndex) div.classList.add('selected');
        div.onclick = () => playTrack(i);
        queueList.appendChild(div);
      });
    }

    // Playback controls
    function playPause() {
      if (!audio.src) return;
      if (isPlaying) {
        audio.pause();
        btnPlayPause.textContent = '▶️';
      } else {
        audio.play().catch(() => {});
        btnPlayPause.textContent = '⏸️';
      }
      isPlaying = !isPlaying;
    }
    function nextTrack() {
      if (queue.length === 0) return;
      currentTrackIndex = (currentTrackIndex + 1) % queue.length;
      playTrack(currentTrackIndex);
    }
    function prevTrack() {
      if (queue.length === 0) return;
      currentTrackIndex = (currentTrackIndex - 1 + queue.length) % queue.length;
      playTrack(currentTrackIndex);
    }
    function shuffleQueue() {
      if (queue.length === 0) return;
      for (let i = queue.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [queue[i], queue[j]] = [queue[j], queue[i]];
      }
      renderQueue();
      currentTrackIndex = 0;
      playTrack(currentTrackIndex);
    }

    // Volume control
    volumeSlider.oninput = () => {
      audio.volume = parseFloat(volumeSlider.value);
    };

    // Progress bar control
    audio.ontimeupdate = () => {
      if (audio.duration) {
        const percent = (audio.currentTime / audio.duration) * 100;
        progressFilled.style.width = percent + '%';
        currentTimeElem.textContent = formatDuration(audio.currentTime);
        durationTimeElem.textContent = formatDuration(audio.duration);
      }
    };

    function seek(e) {
      const rect = progressBar.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const percent = clickX / rect.width;
      audio.currentTime = percent * audio.duration;
    }
    progressBar.addEventListener('click', seek);
    progressContainer.addEventListener('keydown', e => {
      if(e.key === 'ArrowLeft') audio.currentTime = Math.max(0, audio.currentTime - 5);
      else if(e.key === 'ArrowRight') audio.currentTime = Math.min(audio.duration, audio.currentTime + 5);
    });

    // Search/filter songs
    searchInput.oninput = () => {
      const q = searchInput.value.toLowerCase();
      filteredTracks = tracks.filter(t => t.name.toLowerCase().includes(q) || t.artist.toLowerCase().includes(q) || t.album.toLowerCase().includes(q));
      currentTrackIndex = -1;
      renderSongs();
    };

    // Playlist handling
    btnNewPlaylist.onclick = () => {
      const plName = prompt('Enter new playlist name:');
      if (!plName) return;
      if (playlists[plName]) {
        alert('Playlist already exists!');
        return;
      }
      playlists[plName] = [];
      savePlaylists();
      renderPlaylists();
    };

    function savePlaylists() {
      localStorage.setItem('playlists', JSON.stringify(playlists));
    }

    function addToPlaylist(plName, track) {
      if (!playlists[plName]) return;
      if (!playlists[plName].some(t => t.id === track.id)) {
        playlists[plName].push(track);
        savePlaylists();
      }
    }

    // Prevent right-click on playlist buttons
    playlistsDiv.addEventListener('contextmenu', e => {
      e.preventDefault();
      if (e.target.tagName === 'BUTTON') {
        alert('Right-click disabled on playlist buttons.');
      }
    });

    // Right-click menu on songs for adding to playlist
    songsBody.addEventListener('contextmenu', e => {
      e.preventDefault();
      if (filteredTracks.length === 0 || currentTrackIndex === -1) return;

      // Remove any existing menu first
      const oldMenu = document.getElementById('contextMenu');
      if (oldMenu) oldMenu.remove();

      const menu = document.createElement('div');
      menu.id = 'contextMenu';
      menu.style.position = 'fixed';
      menu.style.left = e.pageX + 'px';
      menu.style.top = e.pageY + 'px';
      menu.style.background = '#282828';
      menu.style.color = '#eee';
      menu.style.border = '1px solid #1db954';
      menu.style.padding = '5px';
      menu.style.borderRadius = '6px';
      menu.style.zIndex = 9999;
      menu.style.minWidth = '160px';

      Object.keys(playlists).forEach(plName => {
        const item = document.createElement('div');
        item.textContent = `Add to "${plName}"`;
        item.style.padding = '5px 10px';
        item.style.cursor = 'pointer';
        item.onmouseenter = () => { item.style.background = '#1db954'; item.style.color = '#000'; };
        item.onmouseleave = () => { item.style.background = ''; item.style.color = '#eee'; };
        item.onclick = () => {
          addToPlaylist(plName, filteredTracks[currentTrackIndex]);
          alert(`Added to playlist "${plName}"`);
          menu.remove();
        };
        menu.appendChild(item);
      });

      document.body.appendChild(menu);

      const removeMenu = () => {
        if (menu.parentNode) menu.parentNode.removeChild(menu);
        document.removeEventListener('click', removeMenu);
      };
      document.addEventListener('click', removeMenu);
    });

    // Button handlers
    btnAllSongs.onclick = () => {
      filteredTracks = [...tracks];
      currentTrackIndex = -1;
      renderSongs();
      btnAllSongs.classList.add('active');
      [...playlistsDiv.children].forEach(b => b.classList.remove('active'));
    };
    btnPlayPause.onclick = playPause;
    btnNext.onclick = nextTrack;
    btnPrev.onclick = prevTrack;
    btnShuffle.onclick = shuffleQueue;
    toggleThemeBtn.onclick = () => {
      if(document.body.classList.contains('light')) {
        document.body.classList.remove('light');
        localStorage.setItem('theme', 'dark');
      } else {
        document.body.classList.add('light');
        localStorage.setItem('theme', 'light');
      }
    };

    // Load saved theme
    (function(){
      const savedTheme = localStorage.getItem('theme');
      if(savedTheme === 'light') document.body.classList.add('light');
    })();

    // Initialize app
    async function init() {
      renderPlaylists();
      await loadAllTracks();
      btnAllSongs.click();
    }
    init();

  </script>
</body>
</html>
